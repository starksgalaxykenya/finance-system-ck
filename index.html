<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarKenya Financial Manager - Integrated & Enhanced</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#267921',
                        'primary-dark': '#1f641b',
                        secondary: '#f0f0f0',
                        'secondary-dark': '#1c272a',
                        accent: '#0dcaf0',
                        danger: '#dc3545',
                        warning: '#ffc107',
                        success: '#28a745'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'Segoe UI', 'system-ui', '-apple-system', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 8px 30px rgba(0, 0, 0, 0.12)',
                        'floating': '0 10px 40px rgba(0, 0, 0, 0.15)'
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem'
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom styles to complement Tailwind */
        :root {
            --primary-color: #267921;
            --secondary-color: #f0f0f0;
            --text-color: #333;
            --light-bg: #fff;
            --dark-bg: #1c272a;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Smooth transitions */
        .transition-all {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        /* Bank card gradient effects */
        .bank-card-gradient {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .bank-card-gradient:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        /* Shimmer loading effect */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Pulse animation for notifications */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Custom tab styling */
        .custom-tab {
            position: relative;
            overflow: hidden;
        }

        .custom-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .custom-tab.active::after {
            transform: translateX(0);
        }

        /* Confirmation step indicator */
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #e9ecef;
            color: #6c757d;
        }

        .step-indicator.active {
            background: var(--primary-color);
            color: white;
        }

        .step-indicator.completed {
            background: #28a745;
            color: white;
        }

        /* Bank transfer animation */
        @keyframes transferPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .transfer-animation {
            animation: transferPulse 0.5s ease-in-out;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            max-width: 350px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Tab content styling */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Calculator tab styling */
        .calc-tab-content {
            display: none;
        }
        
        .calc-tab-content.active {
            display: block;
        }

        /* Bank step styling */
        .bank-step {
            display: none;
        }
        
        .bank-step.active {
            display: block;
        }

        /* Modal z-index fixes */
        .modal-container {
            z-index: 99999;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 20px;
        }

        /* Hide balance text */
        .hidden-balance {
            filter: blur(5px);
            user-select: none;
        }

        /* M-Pesa specific styling */
        .mpesa-card {
            background: linear-gradient(135deg, #00b300 0%, #008000 100%);
            color: white;
        }

        .mpesa-badge {
            background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
            color: #000;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p class="text-lg font-semibold text-gray-700" id="loading-text">Loading...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-[99999] hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-container flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-8 relative z-[99999]">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîê Firebase Login</h2>
                <p class="text-gray-600 mb-6 text-center">Connect to Firebase to sync bank data and receipts</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="login-email" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                               placeholder="your@email.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button onclick="firebaseLogin()" 
                            class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login to Firebase
                    </button>
                    
                    <div class="text-center mt-4">
                        <button onclick="toggleFirebaseLogin()" 
                                class="text-sm text-gray-500 hover:text-gray-700">
                            Skip for now (Use Local Data)
                        </button>
                    </div>
                </div>
                
                <div id="firebase-status" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="firebase-status-text"></span>
                    </p>
                </div>
                
                <button onclick="toggleFirebaseLogin()" 
                        class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="bg-gradient-to-r from-primary to-primary-dark text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-car mr-3"></i>CarKenya.Co.Ke üöò Financial Dashboard
                    </h1>
                    <p class="text-primary-light mt-2">Petty Cash Manager & Financial Report Generator</p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="firebase-user-info" class="hidden bg-white bg-opacity-20 px-4 py-2 rounded-lg">
                        <i class="fas fa-user-circle mr-2"></i>
                        <span id="user-email" class="font-medium"></span>
                    </div>
                    
                    <button id="firebase-login-btn" onclick="toggleFirebaseLogin()"
                            class="bg-white text-primary hover:bg-gray-100 font-semibold py-2 px-4 rounded-lg transition-all flex items-center">
                        <i class="fas fa-cloud mr-2"></i>Connect Firebase
                    </button>
                    
                    <button onclick="toggleDarkMode()"
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-lg transition-all">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Main Content Area -->
            <div class="lg:w-2/3">
                <!-- Tabs Navigation -->
                <div class="bg-white rounded-2xl shadow-card overflow-hidden mb-8">
                    <div class="flex border-b border-gray-200">
                        <button class="custom-tab flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-primary transition-all active"
                                onclick="openTab(event, 'petty-cash')">
                            <i class="fas fa-wallet mr-2"></i>üí∞ Petty Cash Manager
                        </button>
                        <button class="custom-tab flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-primary transition-all"
                                onclick="openTab(event, 'financial-reports')">
                            <i class="fas fa-chart-line mr-2"></i>üìà Financial Reports
                        </button>
                        <button class="custom-tab flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-primary transition-all"
                                onclick="openTab(event, 'bank-management')">
                            <i class="fas fa-university mr-2"></i>üè¶ Bank Management
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="p-6">
                        <!-- Petty Cash Tab -->
                        <div id="petty-cash" class="tab-content active">
                            <!-- Balance Bar -->
                            <div id="petty-cash-balance-bar" class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-100 rounded-xl p-6 mb-8">
                                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                                    <div class="flex flex-wrap gap-8">
                                        <div class="text-center">
                                            <div id="current-balance" class="text-3xl font-bold text-primary mb-2">KSH 0</div>
                                            <div class="text-sm text-gray-600">Current Petty Cash Balance</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="day-expense" class="text-3xl font-bold text-red-500 mb-2">KSH 0</div>
                                            <div class="text-sm text-gray-600">Today's Total Expense</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="day-income" class="text-3xl font-bold text-green-500 mb-2">KSH 0</div>
                                            <div class="text-sm text-gray-600">Today's Total Income</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <button onclick="toggleAllBalances()"
                                                class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all flex items-center justify-center">
                                            <i class="fas fa-eye-slash mr-2"></i>Hide All Balances
                                        </button>
                                        <button onclick="endDayAndGenerateReport()"
                                                class="bg-accent hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                                            <i class="fas fa-calendar-day mr-2"></i>End Day & Report
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Transaction Form -->
                            <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-exchange-alt mr-3"></i>Petty Cash Transactions
                                </h2>
                                
                                <form id="petty-cash-form">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-align-left mr-2"></i>Transaction Description
                                            </label>
                                            <input type="text" id="description" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                                   placeholder="e.g., Fuel for delivery car" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-user mr-2"></i>Recipient/Vendor
                                            </label>
                                            <input type="text" id="recipient" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                                   placeholder="e.g., John Doe" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-money-bill-wave mr-2"></i>Cost (KSH)
                                            </label>
                                            <input type="number" id="cost" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                                   placeholder="1500" required min="0" step="0.01">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-tag mr-2"></i>Type
                                            </label>
                                            <select id="type" 
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all appearance-none bg-white">
                                                <option value="expense">Expense</option>
                                                <option value="income">Income</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button type="submit"
                                            class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center">
                                        <i class="fas fa-plus-circle mr-2"></i>‚ûï Add Transaction
                                    </button>
                                </form>
                            </div>

                            <!-- Charts Section -->
                            <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-chart-bar mr-3"></i>üìä Petty Cash Flow Analysis
                                </h3>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Summary (Income vs. Expense)</h4>
                                        <div class="chart-container">
                                            <canvas id="pettyCashChart"></canvas>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Daily & Monthly Expenditure Trend</h4>
                                        <div class="chart-container">
                                            <canvas id="pettyExpenditureLineChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Transactions -->
                            <div class="bg-white rounded-xl shadow-card p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-history mr-3"></i>üìú Recent Transactions (Last 5)
                                </h3>
                                
                                <div class="overflow-x-auto rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-primary text-white">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Description</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Recipient</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Type</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Cost (KSH)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                                            <!-- Transactions will be inserted here -->
                                            <tr>
                                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                                    <i class="fas fa-exchange-alt text-3xl mb-3"></i>
                                                    <p>No transactions yet</p>
                                                    <p class="text-sm mt-2">Add your first transaction above</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Reports Tab -->
                        <div id="financial-reports" class="tab-content hidden">
                            <!-- Access Gate -->
                            <div id="access-gate" class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-8 mb-8">
                                <div class="text-center">
                                    <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Access Restricted üîí</h3>
                                    <p class="text-gray-600 mb-6">Please enter the security access code to manage major financial transactions and generate reports.</p>
                                    
                                    <div class="max-w-md mx-auto">
                                        <input type="text" id="access-code" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:ring-2 focus:ring-primary focus:border-transparent mb-4"
                                               placeholder="Enter Access Code">
                                        <button onclick="checkAccessCode()"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center mx-auto">
                                            <i class="fas fa-key mr-2"></i>üîë Unlock Reports
                                        </button>
                                    </div>
                                    
                                    <p class="mt-6 text-sm text-gray-500">
                                        <i class="fas fa-lightbulb mr-2"></i>Hint: The code is <span class="font-mono font-bold">2679</span>
                                    </p>
                                </div>
                            </div>

                            <!-- Report Input Area -->
                            <div id="report-input-area" class="hidden">
                                <!-- Financial Summary Dashboard -->
                                <div class="bg-gradient-to-r from-primary to-primary-dark text-white rounded-2xl shadow-card p-6 mb-8">
                                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                                        <i class="fas fa-chart-pie mr-3"></i>üí∞ Overall Financial Summary
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 text-center">
                                            <div id="total-bank-funds" class="text-4xl font-bold mb-2">KSH 0</div>
                                            <div class="text-sm opacity-90">Total Bank Funds (All Accounts)</div>
                                        </div>
                                        
                                        <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 text-center">
                                            <div id="total-outstanding-loans" class="text-4xl font-bold mb-2">KSH 0</div>
                                            <div class="text-sm opacity-90">Total Outstanding Loans</div>
                                        </div>
                                        
                                        <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 text-center">
                                            <div id="monthly-spend" class="text-4xl font-bold mb-2">KSH 0</div>
                                            <div class="text-sm opacity-90">Current Monthly Expense Spend</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Major Transaction Form -->
                                <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                        <i class="fas fa-exchange-alt mr-3"></i>Major Transaction Input
                                    </h3>
                                    
                                    <form id="major-transaction-form">
                                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                            <div class="md:col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                                <input type="text" id="major-description" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="e.g., Vehicle Import Duty" required>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (KSH)</label>
                                                <input type="number" id="major-cost" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="500000" required min="0">
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                                <select id="major-category" 
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                    <option value="Sales">Sales (Income)</option>
                                                    <option value="Payroll">Payroll (Expense)</option>
                                                    <option value="Assets">Assets (Investment)</option>
                                                    <option value="Overheads">Overheads (Expense)</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Tied Bank Account</label>
                                                <select id="transaction-bank-id" 
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                    <option value="" disabled selected>Select Bank</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button type="submit"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                                            <i class="fas fa-save mr-2"></i>üíæ Log Major Transaction
                                        </button>
                                    </form>
                                </div>

                                <!-- Loan Management -->
                                <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                        <i class="fas fa-hand-holding-usd mr-3"></i>üìà Loan Management
                                    </h3>
                                    
                                    <form id="loan-form">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Institution</label>
                                                <input type="text" id="loan-institution" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="e.g., Equity Bank" required>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Outstanding Balance (KSH)</label>
                                                <input type="number" id="loan-balance" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="500000" required min="1">
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Deposit to Bank Account</label>
                                                <select id="loan-bank-account" 
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                    <option value="" disabled selected>Select Bank Account</option>
                                                </select>
                                                <div id="loan-bank-balance" class="text-sm text-gray-500 mt-2"></div>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Loan Type</label>
                                                <select id="loan-type" 
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                    <option value="business">Business Loan</option>
                                                    <option value="asset">Asset Financing</option>
                                                    <option value="overdraft">Overdraft Facility</option>
                                                    <option value="mortgage">Mortgage</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Interest Rate (%)</label>
                                                <input type="number" id="loan-interest-rate" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="12.5" step="0.1" min="0">
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                                                <input type="date" id="loan-due-date" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       value="${new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0]}">
                                            </div>
                                        </div>
                                        
                                        <button type="submit"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                                            <i class="fas fa-plus-circle mr-2"></i>‚ûï Add New Loan
                                        </button>
                                    </form>
                                </div>
                                

                                <!-- Loan Institution Cards -->
                                <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                        <i class="fas fa-landmark mr-3"></i>üìã Active Loan Institutions
                                    </h3>
                                    
                                    <div id="loan-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <!-- Loan cards will be dynamically inserted here -->
                                        <div class="col-span-full text-center py-8 text-gray-500">
                                            <i class="fas fa-hand-holding-usd text-3xl mb-3"></i>
                                            <p>No active loans</p>
                                            <p class="text-sm mt-2">Add loans to see them listed here</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Report Generation -->
                                <div class="bg-white rounded-xl shadow-card p-6">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                        <i class="fas fa-file-alt mr-3"></i>Report Generation & Auditing
                                    </h3>
                                    
                                    <div class="flex flex-wrap gap-4 mb-8">
                                        <button onclick="generateReport()"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center">
                                            <i class="fas fa-newspaper mr-2"></i>üì∞ Major Transactions Report
                                        </button>
                                        
                                        <button onclick="simulateAudit()"
                                                class="bg-warning hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center">
                                            <i class="fas fa-search mr-2"></i>üîç Run Audit
                                        </button>
                                        
                                        <button onclick="exportReportToPdf()"
                                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center">
                                            <i class="fas fa-print mr-2"></i>üñ®Ô∏è Print/PDF Report
                                        </button>
                                    </div>
                                    
                                    <div id="report-output-area">
                                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Generated Report Summary</h4>
                                        <div class="chart-container mb-6">
                                            <canvas id="majorCategoryChart"></canvas>
                                        </div>
                                        <div id="major-summary" class="text-gray-600">
                                            <p>No major transactions logged yet.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Management Tab -->
                        <div id="bank-management" class="tab-content hidden">
                            <!-- Sync Status -->
                            <div id="firebase-sync-status" class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8 hidden">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-cloud text-2xl text-blue-500 mr-4"></i>
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Firebase Sync Active</h4>
                                            <p class="text-sm text-gray-600" id="sync-status-text">Syncing bank data...</p>
                                        </div>
                                    </div>
                                    <button onclick="refreshBankData()"
                                            class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center">
                                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                                    </button>
                                </div>
                            </div>

                         <!-- Bank Transfer Form -->
<div class="bg-white rounded-xl shadow-card p-6 mb-8">
    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-money-check-alt mr-3"></i>üí∏ Inter-Bank Transfer
    </h3>
    
    <form id="bank-transfer-form">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">From Bank</label>
                <select id="transfer-from-bank" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="" disabled selected>Select Source Bank</option>
                </select>
                <div id="from-bank-balance" class="text-sm text-gray-500 mt-2"></div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">To Bank</label>
                <select id="transfer-to-bank" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="" disabled selected>Select Destination Bank</option>
                </select>
                <div id="to-bank-balance" class="text-sm text-gray-500 mt-2"></div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Transfer Amount (KSH)</label>
                <input type="number" id="transfer-amount" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                       placeholder="100000" min="0.01" step="0.01" required>
            </div>
        </div>
        
        <!-- New Fee Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Fee (KSH)</label>
                <input type="number" id="transfer-fee-input" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                       placeholder="0.00" min="0" step="0.01" value="0" required>
                <p class="text-sm text-gray-500 mt-2">Enter the transaction fee amount</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fee Bearer</label>
                <select id="fee-bearer" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="sending">Sending Bank Pays Fee</option>
                    <option value="receiving">Receiving Bank Pays Fee</option>
                </select>
                <p class="text-sm text-gray-500 mt-2">Who bears the transaction fee?</p>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Transfer Reason</label>
            <textarea id="transfer-reason" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                      rows="2" placeholder="e.g., Working capital transfer between accounts"></textarea>
        </div>
        
        <button type="submit"
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
            <i class="fas fa-paper-plane mr-2"></i>Initiate Transfer
        </button>
    </form>
    
    <div id="transfer-preview" class="mt-6 hidden">
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="font-semibold text-gray-800 mb-2">Transfer Preview</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-gray-600">From:</span>
                    <span id="preview-from" class="font-medium"></span>
                </div>
                <div>
                    <span class="text-gray-600">To:</span>
                    <span id="preview-to" class="font-medium"></span>
                </div>
                <div>
                    <span class="text-gray-600">Amount:</span>
                    <span id="preview-amount" class="font-medium text-green-600"></span>
                </div>
                <div>
                    <span class="text-gray-600">Fee:</span>
                    <span id="preview-fee" class="font-medium text-red-600"></span>
                </div>
                <div>
                    <span class="text-gray-600">Fee Bearer:</span>
                    <span id="preview-fee-bearer" class="font-medium"></span>
                </div>
                <div>
                    <span class="text-gray-600">Total Debit:</span>
                    <span id="preview-total-debit" class="font-bold"></span>
                </div>
                <div class="col-span-2">
                    <span class="text-gray-600">Reason:</span>
                    <span id="preview-reason" class="font-medium"></span>
                </div>
            </div>
        </div>
    </div>
</div>

                            <!-- Bank Cards Grid -->
                            <div class="mb-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                                        <i class="fas fa-credit-card mr-3"></i>üè¶ Bank Accounts
                                    </h3>
                                    <button onclick="openAddBankModal()"
                                            class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Bank Account
                                    </button>
                                </div>
                                
                                <!-- Loading Skeleton -->
                                <div id="bank-cards-loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                                    <div class="bg-gray-100 rounded-xl p-6 shimmer h-40"></div>
                                    <div class="bg-gray-100 rounded-xl p-6 shimmer h-40"></div>
                                    <div class="bg-gray-100 rounded-xl p-6 shimmer h-40"></div>
                                </div>
                                
                                <!-- Bank Cards Container -->
                                <div id="bank-details-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Bank cards will be dynamically inserted here -->
                                </div>
                                
                                <div id="no-banks-message" class="text-center py-12 hidden">
                                    <i class="fas fa-university text-4xl text-gray-300 mb-4"></i>
                                    <h4 class="text-xl font-semibold text-gray-600 mb-2">No Bank Accounts</h4>
                                    <p class="text-gray-500 mb-6">Add bank accounts to start managing your finances</p>
                                    <button onclick="openAddBankModal()"
                                            class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-lg transition-all">
                                        Add Your First Bank
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Transfers -->
                            <div class="bg-white rounded-xl shadow-card p-6">
                                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-history mr-3"></i>Recent Transfers
                                </h3>
                                
                                <div class="overflow-x-auto rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">From</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">To</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Amount</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transfer-history" class="bg-white divide-y divide-gray-200">
                                            <!-- Transfer history will be inserted here -->
                                            <tr>
                                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                                    <i class="fas fa-exchange-alt text-3xl mb-3"></i>
                                                    <p>No transfers yet</p>
                                                    <p class="text-sm mt-2">Make your first inter-bank transfer above</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:w-1/3">
                <!-- Audit Card -->
                <div id="audit-card" class="bg-white rounded-2xl shadow-card p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-shield-alt mr-3"></i>‚ú® Extra Features & Auditing
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-gray-800">Real-Time Auditing (Client-side)</h4>
                                <ul class="text-sm text-gray-600 mt-1 space-y-1">
                                    <li><strong>Anomaly Detection:</strong> Flags petty cash transactions over KSH 5,000</li>
                                    <li><strong>Balance Integrity:</strong> Alerts on negative bank/petty cash balance</li>
                                    <li><strong>Major Integrity:</strong> Checks for small transactions logged as Major</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-heartbeat mr-2"></i>Current Audit Status
                    </h3>
                    <div id="audit-status" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-3"></i>
                            <span class="font-medium text-green-800">System Health: All Clear.</span>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-link mr-2"></i>CarKenya Quick Links
                    </h3>
                    <div class="space-y-3">
                        <a href="#" class="flex items-center text-primary hover:text-primary-dark transition-all">
                            <i class="fas fa-file-invoice-dollar mr-3"></i>
                            <span>View Invoices</span>
                        </a>
                        <a href="#" class="flex items-center text-primary hover:text-primary-dark transition-all">
                            <i class="fas fa-chart-pie mr-3"></i>
                            <span>Setup Budget</span>
                        </a>
                        <a href="#" class="flex items-center text-primary hover:text-primary-dark transition-all">
                            <i class="fas fa-receipt mr-3"></i>
                            <span>Staff Expense Claims</span>
                        </a>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="bg-gradient-to-br from-primary to-primary-dark text-white rounded-2xl shadow-card p-6">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <i class="fas fa-bolt mr-3"></i>Quick Stats
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm opacity-90">Total Transactions Today</span>
                                <span class="font-bold" id="stats-today-transactions">0</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                                <div id="stats-today-progress" class="bg-white h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm opacity-90">Active Bank Accounts</span>
                                <span class="font-bold" id="stats-active-banks">0</span>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm opacity-90">Monthly Budget Used</span>
                                <span class="font-bold" id="stats-budget-used">0%</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                                <div id="stats-budget-progress" class="bg-accent h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="refreshAllData()"
                            class="w-full mt-6 bg-white text-primary hover:bg-gray-100 font-semibold py-3 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Calculator Button -->
    <button class="floating-btn fixed bottom-8 right-8 w-16 h-16 bg-primary hover:bg-primary-dark text-white rounded-full shadow-floating transition-all transform hover:scale-110 active:scale-95 flex items-center justify-center z-40"
            onclick="openCalculatorModal('basic')">
        <i class="fas fa-calculator text-2xl"></i>
    </button>

    <!-- Calculator Modal -->
    <div id="calculator-modal" class="fixed inset-0 z-[99999] hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-container flex items-center justify-center">
            <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-calculator mr-3"></i>Financial Calculator
                    </h2>
                    <button onclick="closeCalculatorModal()"
                            class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="calculator-tabs" class="flex mb-6 border-b border-gray-200">
                    <button class="calc-tab-button flex-1 py-3 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-primary transition-all active border-primary"
                            onclick="switchCalcTab(event, 'basic-calc')">
                        <i class="fas fa-calculator mr-2"></i>Basic Calculator
                    </button>
                    <button class="calc-tab-button flex-1 py-3 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-primary transition-all"
                            onclick="switchCalcTab(event, 'financial-calc')">
                        <i class="fas fa-chart-line mr-2"></i>Financial (EMI)
                    </button>
                </div>
                
                <div id="basic-calc" class="calc-tab-content active">
                    <div id="calculator-display" class="bg-gray-800 text-white text-3xl font-mono p-4 rounded-lg mb-4 text-right overflow-x-auto">0</div>
                    
                    <div id="calculator-buttons" class="grid grid-cols-4 gap-2">
                        <button class="clear-btn bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition-all" onclick="clearBasicCalc()">C</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('/')">√∑</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('*')">√ó</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('-')">‚àí</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('7')">7</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('8')">8</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('9')">9</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('+')">+</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('4')">4</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('5')">5</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('6')">6</button>
                        <button class="equals bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-lg transition-all col-start-4 col-end-5 row-start-3 row-end-5" onclick="calculateBasicCalc()">=</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('1')">1</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('2')">2</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('3')">3</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all col-span-2" onclick="appendToBasicCalc('0')">0</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('.')">.</button>
                    </div>
                </div>
                
                <div id="financial-calc" class="calc-tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Loan Payment (EMI) Calculator</h3>
                    
                    <form id="emi-calculator-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loan Principal (KSH)</label>
                            <input type="number" id="principal" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   value="1000000" required min="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Annual Interest Rate (%)</label>
                            <input type="number" id="rate" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   value="10" step="0.01" required min="0">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loan Term (Months)</label>
                            <input type="number" id="months" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   value="36" required min="1">
                        </div>
                        
                        <button type="submit"
                                class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                            <i class="fas fa-calculator mr-2"></i>Calculate EMI
                        </button>
                    </form>
                    
                    <div class="mt-6 p-4 bg-green-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">Result</h4>
                        <p id="emi-result" class="text-primary font-bold">Enter values and click Calculate.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bank Modal -->
    <div id="add-bank-modal" class="fixed inset-0 z-[99999] hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-container flex items-center justify-center">
            <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-university mr-3"></i>Add Bank Account
                    </h2>
                    <button onclick="closeAddBankModal()"
                            class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Step Indicator -->
                <div class="flex justify-between items-center mb-8">
                    <div class="flex flex-col items-center">
                        <div id="step-1-indicator" class="step-indicator active">1</div>
                        <span class="text-xs mt-2 font-medium">Select Bank</span>
                    </div>
                    <div class="h-1 w-12 bg-gray-200"></div>
                    <div class="flex flex-col items-center">
                        <div id="step-2-indicator" class="step-indicator">2</div>
                        <span class="text-xs mt-2 font-medium">Set Balance</span>
                    </div>
                    <div class="h-1 w-12 bg-gray-200"></div>
                    <div class="flex flex-col items-center">
                        <div id="step-3-indicator" class="step-indicator">3</div>
                        <span class="text-xs mt-2 font-medium">Confirm</span>
                    </div>
                </div>
                
                <!-- Step 1: Select Bank -->
                <div id="step-1" class="bank-step active">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Bank from Firebase</h3>
                    <p class="text-gray-600 mb-6">Choose a bank from your existing bank details in Firebase</p>
                    
                    <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Banks from Firebase will be loaded here -->
                        <div id="firebase-banks-list" class="space-y-3">
                            <!-- Bank options will be inserted here -->
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-university text-3xl mb-3"></i>
                                <p>No banks found in Firebase</p>
                                <p class="text-sm mt-2">Connect to Firebase and add banks first</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="closeAddBankModal()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium">
                            Cancel
                        </button>
                        <button onclick="nextBankStep()"
                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-lg transition-all">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Set Initial Balance -->
                <div id="step-2" class="bank-step hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Set Initial Balance</h3>
                    <p class="text-gray-600 mb-6">Enter the current balance for <span id="selected-bank-name" class="font-semibold"></span></p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Initial Balance (KSH)</label>
                        <input type="number" id="bank-initial-balance" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg text-2xl text-center focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="0.00" min="0" step="0.01" required>
                        <p class="text-sm text-gray-500 mt-2">This will be the starting balance for your local tracking</p>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevBankStep()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button onclick="nextBankStep()"
                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-lg transition-all">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Confirmation -->
                <div id="step-3" class="bank-step hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Details</h3>
                    
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-600 text-sm">Bank Name:</span>
                                <p id="confirm-bank-name" class="font-semibold"></p>
                            </div>
                            <div>
                                <span class="text-gray-600 text-sm">Initial Balance:</span>
                                <p id="confirm-bank-balance" class="font-semibold text-green-600"></p>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-600 text-sm">Source:</span>
                                <p class="font-semibold flex items-center">
                                    <i class="fas fa-fire mr-2 text-orange-500"></i>Firebase Sync
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-start mb-6">
                        <input type="checkbox" id="confirm-terms" class="mt-1 mr-3">
                        <label for="confirm-terms" class="text-sm text-gray-600">
                            I confirm that this balance is accurate and I've verified it against my bank statement
                        </label>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevBankStep()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button onclick="submitNewBank()"
                                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all flex items-center">
                            <i class="fas fa-check-circle mr-2"></i> Add Bank Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Confirmation Modal -->
 <div id="transfer-confirm-modal" class="fixed inset-0 z-[99999] hidden">
    <div class="modal-backdrop fixed inset-0"></div>
    <div class="modal-container flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6">
            <div class="text-center mb-6">
                <i class="fas fa-paper-plane text-5xl text-primary mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Confirm Transfer</h3>
                <p class="text-gray-600">Please confirm the bank transfer details</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">From:</span>
                        <span id="confirm-transfer-from" class="font-semibold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">To:</span>
                        <span id="confirm-transfer-to" class="font-semibold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Amount:</span>
                        <span id="confirm-transfer-amount" class="font-semibold text-green-600"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Fee:</span>
                        <span id="confirm-transfer-fee" class="font-semibold text-red-600"></span>
                    </div>
                    <!-- ADD THIS LINE -->
                    <div class="flex justify-between">
                        <span class="text-gray-600">Fee Bearer:</span>
                        <span id="confirm-transfer-fee-bearer" class="font-semibold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total Debit:</span>
                        <span id="confirm-transfer-total" class="font-bold"></span>
                    </div>
                    <hr class="my-2">
                    <div>
                        <span class="text-gray-600">Reason:</span>
                        <p id="confirm-transfer-reason" class="font-medium mt-1"></p>
                    </div>
                </div>
            </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Security PIN</label>
                        <input type="password" id="transfer-pin" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-xl tracking-widest focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="0000" maxlength="4" required>
                        <p class="text-xs text-gray-500 mt-2">Enter your 4-digit security PIN to confirm</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="closeTransferConfirm()"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg transition-all">
                            Cancel
                        </button>
                        <button onclick="executeBankTransfer()"
                                class="flex-1 bg-primary hover:bg-primary-dark text-white font-semibold py-3 rounded-lg transition-all">
                            Confirm Transfer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Repayment Modal -->
    <div id="loan-repayment-modal" class="fixed inset-0 z-[99999] hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-container flex items-center justify-center">
            <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-money-check-alt mr-3"></i>Loan Repayment
                    </h2>
                    <button onclick="closeLoanRepaymentModal()"
                            class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="repayment-loan-details" class="bg-gray-50 rounded-lg p-4 mb-6">
                    <!-- Loan details will be inserted here -->
                </div>
                
                <form id="loan-repayment-form">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Source Bank Account</label>
                            <select id="repayment-bank-select" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="" disabled selected>Select Bank for Repayment</option>
                            </select>
                            <div id="repayment-bank-balance" class="text-sm text-gray-500 mt-2"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Repayment Amount (KSH)</label>
                            <input type="number" id="repayment-amount" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="10000" min="0.01" step="0.01" required>
                            <div class="text-sm text-gray-500 mt-2">
                                <span id="remaining-balance-text">Remaining balance: KSH 0</span>
                                <button type="button" onclick="fillFullBalance()" class="text-primary hover:text-primary-dark text-xs ml-4">
                                    <i class="fas fa-money-bill-wave mr-1"></i>Repay Full Amount
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Repayment Date</label>
                            <input type="date" id="repayment-date" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Reference/Receipt No.</label>
                            <input type="text" id="repayment-reference" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="e.g., TRX-0012345" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea id="repayment-notes" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                      rows="2" placeholder="Additional notes about this repayment"></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                            Repayment Preview
                        </h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-600">Loan:</span>
                                <span id="preview-loan" class="font-medium"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">Amount:</span>
                                <span id="preview-amount" class="font-medium text-green-600"></span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-600">Source Bank:</span>
                                <span id="preview-source-bank" class="font-medium"></span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-600">New Loan Balance:</span>
                                <span id="preview-new-balance" class="font-medium text-blue-600"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeLoanRepaymentModal()"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg transition-all">
                            Cancel
                        </button>
                        <button type="submit"
                                class="flex-1 bg-primary hover:bg-primary-dark text-white font-semibold py-3 rounded-lg transition-all flex items-center justify-center">
                            <i class="fas fa-check-circle mr-2"></i>Confirm Repayment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCuUKCxYx0jYKqWOQaN82K5zFGlQsKQsK0",
        authDomain: "ck-manager-1abdc.firebaseapp.com",
        projectId: "ck-manager-1abdc",
        storageBucket: "ck-manager-1abdc.firebasestorage.app",
        messagingSenderId: "890017473158",
        appId: "1:890017473158:web:528e1eebc4b67bd54ca707",
        measurementId: "G-7Z71W1NSX4"
    };

    // Initialize Firebase
    let firebaseApp;
    let firestore;
    let auth;
    let firebaseInitialized = false;
    let user = null;

    // Main Application Data
    const { jsPDF } = window.jspdf;
    let pettyCashTransactions = [];
    let majorTransactions = [];
    let banks = [];
    let loans = [];
    let bankTransfers = [];
    let loanRepayments = [];
    const ACCESS_CODE = "2679";
    let pettyChartInstance = null;
    let majorChartInstance = null;
    let pettyLineChartInstance = null;
    let basicCalcCurrentExpression = '';
    let currentMonthSpend = {
        month: new Date().getMonth(),
        year: new Date().getFullYear(),
        totalExpense: 0
    };

    // Add Bank Modal State
    let addBankStep = 1;
    let selectedFirebaseBank = null;

    // Balance visibility state
    let balancesHidden = false;

    // Current repayment loan ID
    let currentRepaymentLoanId = null;

    // --- Firebase Login Function ---
    async function firebaseLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const statusElement = document.getElementById('firebase-status');
        
        if (!email || !password) {
            showToast('Please enter both email and password', 'error');
            return;
        }
        
        showLoading('Connecting to Firebase...');
        
        try {
            await auth.signInWithEmailAndPassword(email, password);
            showToast('Login successful!', 'success');
            toggleFirebaseLogin();
            
            // Update UI
            updateFirebaseUI();
            
        } catch (error) {
            showLoading(false);
            console.error("Firebase login error:", error);
            
            let errorMessage = 'Login failed. ';
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage += 'Invalid email address.';
                    break;
                case 'auth/user-disabled':
                    errorMessage += 'This account has been disabled.';
                    break;
                case 'auth/user-not-found':
                    errorMessage += 'No account found with this email.';
                    break;
                case 'auth/wrong-password':
                    errorMessage += 'Incorrect password.';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            showToast(errorMessage, 'error');
            
            // Show status in the modal
            if (statusElement) {
                statusElement.classList.remove('hidden');
                document.getElementById('firebase-status-text').textContent = errorMessage;
            }
        }
    }

    function toggleFirebaseLogin() {
        const modal = document.getElementById('login-modal');
        if (!modal) return;
        
        // Toggle display
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            // Clear any previous inputs
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            // Hide status message
            const statusElement = document.getElementById('firebase-status');
            if (statusElement) {
                statusElement.classList.add('hidden');
            }
        } else {
            modal.classList.add('hidden');
        }
    }

   function updateFirebaseUI() {
    const loginBtn = document.getElementById('firebase-login-btn');
    const userInfo = document.getElementById('firebase-user-info');
    const userEmail = document.getElementById('user-email');
    const syncStatus = document.getElementById('firebase-sync-status');
    
    if (user) {
        loginBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Connected';
        loginBtn.classList.remove('bg-white', 'text-primary');
        loginBtn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
        
        userInfo.classList.remove('hidden');
        userEmail.textContent = user.email;
        
        syncStatus.classList.remove('hidden');
        document.getElementById('sync-status-text').textContent = `Connected as ${user.email}`;
        
        // Start the payment scanner when user is connected
        setTimeout(() => startPaymentScanner(), 1000);
        
    } else {
        loginBtn.innerHTML = '<i class="fas fa-cloud mr-2"></i>Connect Firebase';
        loginBtn.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
        loginBtn.classList.add('bg-white', 'text-primary');
        
        userInfo.classList.add('hidden');
        syncStatus.classList.add('hidden');
    }
}

    function initializeFirebase() {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firestore = firebase.firestore();
            auth = firebase.auth();
            firebaseInitialized = true;
            
            // Set up auth state listener
            auth.onAuthStateChanged(async (firebaseUser) => {
                user = firebaseUser;
                updateFirebaseUI();
                
                if (user) {
                    showToast('Connected to Firebase successfully!', 'success');
                    await loadFirebaseBanks();
                    await loadReceiptPayments();
                    await loadUserData(); // Load all user data from Firestore
                    updateBankSelectors(); // Load banks into transfer selectors
                }
            });
            
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showToast('Firebase initialization failed. Using local data only.', 'error');
        }
    }

    // --- Firestore Persistent Storage Functions ---
   async function saveUserData() {
    if (!user) return;
    
    try {
        // Get current processed payments from the payment scanner
        const processedPaymentIds = new Set();
        
        // Collect all receipt IDs from majorTransactions
        majorTransactions
            .filter(t => t.isFromReceipt && t.receiptId)
            .forEach(t => processedPaymentIds.add(t.receiptId));
        
        const userData = {
            pettyCashTransactions: pettyCashTransactions,
            majorTransactions: majorTransactions,
            banks: banks,
            loans: loans,
            bankTransfers: bankTransfers,
            loanRepayments: loanRepayments,
            currentMonthSpend: currentMonthSpend,
            processedReceiptPayments: Array.from(processedPaymentIds), // Save processed payments
            lastUpdated: new Date().toISOString()
        };
        
        await firestore.collection('userData').doc(user.uid).set(userData, { merge: true });
        console.log("User data saved to Firestore");
    } catch (error) {
        console.error("Error saving user data:", error);
    }
}

   async function loadUserData() {
    if (!user) return;
    
    try {
        const doc = await firestore.collection('userData').doc(user.uid).get();
        if (doc.exists) {
            const userData = doc.data();
            
            // Load data
            pettyCashTransactions = userData.pettyCashTransactions || [];
            majorTransactions = userData.majorTransactions || [];
            banks = userData.banks || [];
            loans = userData.loans || [];
            bankTransfers = userData.bankTransfers || [];
            loanRepayments = userData.loanRepayments || [];
            currentMonthSpend = userData.currentMonthSpend || {
                month: new Date().getMonth(),
                year: new Date().getFullYear(),
                totalExpense: 0
            };
            
            // Note: processedReceiptPayments is loaded separately in startPaymentScanner
            
            // Recalculate balances to ensure integrity
            await recalculateBalances();
            
            // Ensure M-Pesa bank exists
            ensureMpesaBank();
            
            // Update all UI components
            renderPettyCash();
            updatePettyCashBalanceDisplay();
            updatePettyCashChart();
            updatePettyExpenditureChart();
            updateBankSelectors();
            updateTransferBankSelectors();
            updateMajorSummary();
            updateFinancialDashboard();
            updateBankCards();
            updateTransferHistory();
            updateQuickStats();
            initializeLoanBankSelector();
            updateLoanCards();
            
            showToast('User data loaded from Firestore', 'success');
        } else {
            // Initialize with default M-Pesa bank
            ensureMpesaBank();
            showToast('Welcome! Starting with new data', 'info');
        }
    } catch (error) {
        console.error("Error loading user data:", error);
        // Initialize with default M-Pesa bank
        ensureMpesaBank();
    }
}
// Add function to recalculate balances
async function recalculateBalances() {
    console.log('Recalculating all balances...');
    
    // Reset all bank balances to 0
    banks.forEach(bank => {
        const originalBalance = bank.balance;
        bank.balance = 0;
        console.log(`Reset ${bank.name} balance from ${formatCurrency(originalBalance, bank.currency)} to 0`);
    });
    
    // Recalculate from ALL major transactions including receipts
    let receiptTransactions = 0;
    let otherTransactions = 0;
    
    for (const transaction of majorTransactions) {
        const bank = banks.find(b => b.id === transaction.bankId);
        if (bank) {
            if (transaction.category === 'Sales' || 
                transaction.isFromReceipt || 
                transaction.isLoanDisbursement) {
                // Income transactions
                bank.balance += transaction.amount;
                if (transaction.isFromReceipt) receiptTransactions++;
            } else {
                // Expense transactions
                bank.balance -= transaction.amount;
                otherTransactions++;
            }
        }
    }
    
    console.log(`Recalculated balances: ${receiptTransactions} receipt transactions, ${otherTransactions} other transactions`);
    
    // Recalculate petty cash
    const { currentBalance } = calculatePettyCashBalance();
    const mpesaBank = banks.find(b => b.id === 'mpesa');
    if (mpesaBank) {
        console.log(`M-Pesa balance set to petty cash balance: ${formatCurrency(currentBalance, mpesaBank.currency)}`);
        mpesaBank.balance = currentBalance;
    }
    
    // Log final balances
    banks.forEach(bank => {
        console.log(`${bank.name} final balance: ${formatCurrency(bank.balance, bank.currency)}`);
    });
}

  // --- Initialize Loan Bank Selector ---
async function initializeLoanBankSelector() {
    const bankSelect = document.getElementById('loan-bank-account');
    if (!bankSelect) return;
    
    bankSelect.innerHTML = '<option value="" disabled selected>Select Bank Account</option>';
    
    // Clear previous options
    bankSelect.innerHTML = '<option value="" disabled selected>Loading banks from Firebase...</option>';
    
    try {
        // Load banks from Firestore
        const banksSnapshot = await firestore.collection('bankDetails').get();
        
        if (banksSnapshot.empty) {
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "No banks found in Firebase - Add banks first";
            option.disabled = true;
            bankSelect.appendChild(option);
            showToast('No banks found in Firebase', 'warning');
            return;
        }
        
        // Clear loading message
        bankSelect.innerHTML = '<option value="" disabled selected>Select Bank Account</option>';
        
        // Add banks from Firestore
        banksSnapshot.forEach(doc => {
            const bankData = doc.data();
            const bankId = doc.id;
            
            // Extract bank name from Firebase data
            const bankName = bankData.bankName || 
                           bankData.name || 
                           bankData.bank || 
                           bankData.bank_name || 
                           bankData.bankName || 
                           'Bank Account';
            
            // Extract account number
            const accountNumber = bankData.accountNumber || 
                                bankData.account || 
                                bankData.account_number || 
                                bankData.accountNumber || 
                                'N/A';
            
            // Extract branch
            const branch = bankData.branch || 
                         bankData.branchName || 
                         bankData.branch_name || 
                         bankData.branchName || 
                         '';
            
            const option = document.createElement('option');
            option.value = bankId;
            option.setAttribute('data-firebase-id', bankId);
            option.textContent = `${bankName} - ${accountNumber} ${branch ? `(${branch})` : ''}`;
            bankSelect.appendChild(option);
        });
        
        // Add local M-Pesa bank if it exists
        const mpesaBank = banks.find(b => b.id === 'mpesa');
        if (mpesaBank) {
            const option = document.createElement('option');
            option.value = 'mpesa';
            option.textContent = `${mpesaBank.name} (Petty Cash) - ${formatKSH(mpesaBank.balance)}`;
            bankSelect.appendChild(option);
        }
        
    } catch (error) {
        console.error("Error loading banks from Firestore:", error);
        bankSelect.innerHTML = '<option value="" disabled selected>Error loading banks</option>';
        showToast('Error loading banks from Firebase', 'error');
    }
    
    // Add event listener to show balance
    bankSelect.addEventListener('change', async function() {
        const bankId = this.value;
        const firebaseId = this.options[this.selectedIndex].getAttribute('data-firebase-id');
        const balanceElement = document.getElementById('loan-bank-balance');
        
        if (bankId === 'mpesa') {
            // For M-Pesa, use local balance
            const mpesaBank = banks.find(b => b.id === 'mpesa');
            if (mpesaBank && balanceElement) {
                balanceElement.innerHTML = 
                    `<span class="font-semibold">Current Balance:</span> ${formatKSH(mpesaBank.balance)}`;
            }
        } else if (firebaseId) {
            // For Firebase banks, fetch the latest balance
            try {
                const bankDoc = await firestore.collection('bankDetails').doc(firebaseId).get();
                if (bankDoc.exists) {
                    const bankData = bankDoc.data();
                    // Try to get balance from various possible field names
                    const balance = bankData.balance || 
                                   bankData.currentBalance || 
                                   bankData.accountBalance || 
                                   bankData.balanceAmount || 
                                   0;
                    
                    if (balanceElement) {
                        balanceElement.innerHTML = 
                            `<span class="font-semibold">Current Balance (from Firebase):</span> ${formatKSH(parseFloat(balance))}`;
                    }
                }
            } catch (error) {
                console.error("Error fetching bank balance:", error);
                if (balanceElement) {
                    balanceElement.innerHTML = 
                        `<span class="font-semibold text-red-600">Unable to fetch balance from Firebase</span>`;
                }
            }
        }
    });
}

    // --- Payment Scanner Functions ---
async function startPaymentScanner() {
    if (!user) return;
    
    // Track already processed payment IDs in memory
    let processedPaymentIds = new Set();
    
    // Load already processed payments from Firestore user data
    try {
        if (user) {
            const userDataDoc = await firestore.collection('userData').doc(user.uid).get();
            if (userDataDoc.exists) {
                const userData = userDataDoc.data();
                const processedPayments = userData.processedReceiptPayments || [];
                processedPayments.forEach(id => processedPaymentIds.add(id));
                console.log('Loaded processed payments from Firestore:', processedPayments.length);
            }
        }
    } catch (error) {
        console.error("Error loading processed payments from Firestore:", error);
    }
    
    // Function to process a single payment
    async function processPaymentIfNew(payment) {
        // Check if this payment has already been processed
        if (processedPaymentIds.has(payment.id)) {
            console.log('Payment already processed, skipping:', payment.id);
            return false;
        }
        
        await processNewPayment(payment);
        
        // Mark as processed
        processedPaymentIds.add(payment.id);
        return true;
    }
    
    // Process ALL existing payments in the collection first
    try {
        showLoading('Scanning all receipt payments...');
        
        const paymentsCollection = firestore.collection('receipt_payments');
        const allPaymentsSnapshot = await paymentsCollection.get();
        
        console.log(`Found ${allPaymentsSnapshot.size} payments in receipt_payments collection`);
        
        let processedCount = 0;
        const paymentsToProcess = [];
        
        // First, collect all payments
        allPaymentsSnapshot.forEach(doc => {
            const payment = { id: doc.id, ...doc.data() };
            paymentsToProcess.push(payment);
        });
        
        // Process payments in batches to avoid overwhelming the system
        for (const payment of paymentsToProcess) {
            const wasProcessed = await processPaymentIfNew(payment);
            if (wasProcessed) processedCount++;
            
            // Small delay to prevent overwhelming the system
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        console.log(`Processed ${processedCount} new payments out of ${paymentsToProcess.length} total`);
        
        if (processedCount > 0) {
            showToast(`Processed ${processedCount} receipt payments`, 'success');
        }
        
        showLoading(false);
        
    } catch (error) {
        console.error("Error processing existing payments:", error);
        showLoading(false);
        showToast('Error processing existing payments', 'error');
    }
    
    // Now set up real-time listener for NEW payments only
    const paymentsCollection = firestore.collection('receipt_payments');
    
    // Listen for new documents added to receipt_payments (real-time updates)
    paymentsCollection.onSnapshot((snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
            if (change.type === 'added') {
                const payment = { id: change.doc.id, ...change.doc.data() };
                
                // Check if this is a brand new payment (not from initial load)
                if (!processedPaymentIds.has(payment.id)) {
                    console.log('New real-time payment detected:', payment.id);
                    await processPaymentIfNew(payment);
                }
            }
        });
    }, (error) => {
        console.error("Payment scanner real-time listener error:", error);
        showToast('Payment scanner real-time listener error', 'error');
    });
    
    // Save processed payments to Firestore periodically
    async function saveProcessedPayments() {
        if (!user) return;
        
        try {
            const processedArray = Array.from(processedPaymentIds);
            await firestore.collection('userData').doc(user.uid).update({
                processedReceiptPayments: processedArray,
                lastPaymentScan: new Date().toISOString()
            });
            console.log('Saved processed payments to Firestore:', processedArray.length);
        } catch (error) {
            console.error("Error saving processed payments:", error);
        }
    }
    
    // Save processed payments every 30 seconds and on page unload
    setInterval(saveProcessedPayments, 30000);
    window.addEventListener('beforeunload', saveProcessedPayments);
}
// Process a new payment from Firestore
// Update the processNewPayment function
// Process a new payment from Firestore
// Process a new payment from Firestore
async function processNewPayment(payment) {
    try {
        // Create a unique identifier for this payment to prevent duplicates
        const paymentId = payment.id;
        const paymentDate = payment.paymentDate || payment.date || payment.createdAt || Date.now();
        const receiptNumber = payment.receiptNumber || payment.id;
        
        // Check if this payment has already been processed using multiple criteria
        const existingTransaction = majorTransactions.find(t => 
            t.receiptId === paymentId || 
            (t.isFromReceipt && t.receiptNumber === receiptNumber) ||
            (t.isFromReceipt && t.description.includes(receiptNumber)) ||
            (t.isFromReceipt && t.originalPaymentId === paymentId)
        );
        
        if (existingTransaction) {
            console.log('Payment already processed, skipping:', paymentId, receiptNumber);
            return;
        }
        
       const paymentMethod = payment.paymentMethod || payment.method || 'Unknown';
let amount = 0;
let currency = 'KSH'; // Default to KSH

    // Check specific amount fields first
if (payment.amountKSH && parseFloat(payment.amountKSH) > 0) {
    amount = parseFloat(payment.amountKSH);
    currency = 'KSH';
} else if (payment.amountUSD && parseFloat(payment.amountUSD) > 0) {
    amount = parseFloat(payment.amountUSD);
    currency = 'USD';
} else if (payment.amount && parseFloat(payment.amount) > 0) {
    amount = parseFloat(payment.amount);
    // Use currency from field if available
    if (payment.currency) {
        currency = payment.currency.toUpperCase();
        if (currency === 'KES') currency = 'KSH';
    }
}

if (amount <= 0) {
    console.log('Skipping payment with zero or negative amount:', payment);
    return;
}

console.log(`Processing ${amount} ${currency} from ${paymentMethod}`);    

// First, check if payment method contains currency hints
const paymentMethodUpper = paymentMethod.toUpperCase();
if (paymentMethodUpper.includes('(USD)') || paymentMethodUpper.includes('USD') || paymentMethodUpper.includes('$')) {
    // Payment method suggests USD
    currency = 'USD';
} else if (paymentMethodUpper.includes('(KSH)') || paymentMethodUpper.includes('KSH') || paymentMethodUpper.includes('KES')) {
    // Payment method suggests KSH
    currency = 'KSH';
}

// Now check amount fields, but override currency if amount field is specific
if (payment.amountKSH && parseFloat(payment.amountKSH) > 0) {
    amount = parseFloat(payment.amountKSH);
    currency = 'KSH'; // Force KSH if amountKSH is present
    console.log('Using KSH amount from amountKSH field:', amount, currency);
} else if (payment.amountUSD && parseFloat(payment.amountUSD) > 0) {
    amount = parseFloat(payment.amountUSD);
    currency = 'USD'; // Force USD if amountUSD is present
    console.log('Using USD amount from amountUSD field:', amount, currency);
} else if (payment.amount && parseFloat(payment.amount) > 0) {
    amount = parseFloat(payment.amount);
    // If we already detected currency from payment method, keep it
    // Otherwise try to detect from currency field
    if (!paymentMethodUpper.includes('(USD)') && !paymentMethodUpper.includes('(KSH)')) {
        if (payment.currency) {
            currency = payment.currency.toUpperCase();
            if (currency === 'KES') currency = 'KSH';
        }
    }
    console.log('Using generic amount field:', amount, currency, 'detected from payment method hint');
}
        
        if (amount <= 0) {
            console.log('Skipping payment with zero or negative amount:', payment);
            return;
        }
        
        console.log(`Processing payment: ${amount} ${currency} from receipt ${receiptNumber}, method: ${paymentMethod}`);
        
        // Find the appropriate bank based on payment method and currency
        const targetBank = await findBankByPaymentMethod(paymentMethod, currency);
        
        if (targetBank) {
            // Convert USD to KSH if needed with proper exchange rate
            let amountInBankCurrency = amount;
            
            // If currencies don't match, convert
            if (currency !== targetBank.currency) {
                const exchangeRate = await getExchangeRate(currency, targetBank.currency);
                amountInBankCurrency = amount * exchangeRate;
                
                console.log(`Currency conversion: ${amount} ${currency} to ${amountInBankCurrency} ${targetBank.currency} (Rate: ${exchangeRate})`);
            }
            
            // Update bank balance - add only if not already added
            const currentBankBalance = targetBank.balance;
            targetBank.balance += amountInBankCurrency;
            targetBank.lastUpdated = new Date().toISOString();
            
            // Add to major transactions with unique identifiers
            const newTransaction = {
                id: 'receipt_' + Date.now() + '_' + paymentId,
                description: `Payment received: ${receiptNumber} - ${paymentMethod}`,
                amount: amountInBankCurrency,
                category: 'Sales',
                date: new Date(paymentDate).toISOString(),
                formattedDate: new Date(paymentDate).toLocaleDateString('en-KE'),
                bankId: targetBank.id,
                bankName: targetBank.name,
                bankCurrency: targetBank.currency,
                isFromReceipt: true,
                receiptId: paymentId,
                receiptNumber: receiptNumber,
                originalCurrency: currency,
                originalAmount: amount,
                convertedAmount: amountInBankCurrency,
                exchangeRateUsed: currency !== targetBank.currency ? await getExchangeRate(currency, targetBank.currency) : 1,
                paymentMethod: paymentMethod,
                originalPaymentId: paymentId, // Store original payment ID to prevent duplicates
                processedAt: new Date().toISOString(),
                previousBankBalance: currentBankBalance,
                newBankBalance: currentBankBalance + amountInBankCurrency
            };
            
            majorTransactions.push(newTransaction);
            
            // Update UI
            updateFinancialDashboard();
            updateBankCards();
            updateBankSelectors();
            updateTransferBankSelectors();
            updateQuickStats();
            
            // Save to Firestore
            if (user) await saveUserData();
            
            showToast(`New ${currency} ${formatCurrency(amount, currency)} payment added to ${targetBank.name} (${targetBank.currency})`, 'success');
            console.log(`Payment processed: ${amount} ${currency} added to ${targetBank.name} as ${amountInBankCurrency} ${targetBank.currency}. Bank balance updated from ${formatCurrency(currentBankBalance, targetBank.currency)} to ${formatCurrency(targetBank.balance, targetBank.currency)}`);
        } else {
            console.log('No matching bank found for payment method:', paymentMethod, 'with currency:', currency);
            
            // Log as unmatched for debugging
            const unmatchedTransaction = {
                id: 'unmatched_' + Date.now(),
                description: `Unmatched payment: ${receiptNumber} - ${paymentMethod} (${currency} ${amount})`,
                amount: amount,
                category: 'Sales',
                date: new Date(paymentDate).toISOString(),
                formattedDate: new Date(paymentDate).toLocaleDateString('en-KE'),
                bankId: 'unmatched',
                bankName: 'Unmatched Bank',
                isFromReceipt: true,
                receiptId: paymentId,
                receiptNumber: receiptNumber,
                originalCurrency: currency,
                originalAmount: amount,
                convertedAmount: amount,
                isUnmatched: true,
                paymentMethod: paymentMethod,
                processedAt: new Date().toISOString()
            };
            
            majorTransactions.push(unmatchedTransaction);
            
            showToast(`Payment received but no matching ${currency} bank found for: ${paymentMethod}`, 'warning');
            
            // Save to Firestore even if unmatched
            if (user) await saveUserData();
        }
        
    } catch (error) {
        console.error("Error processing payment:", error);
        showToast('Error processing payment', 'error');
    }
}

// Helper function to get available banks from Firestore
async function getAvailableBanksFromFirestore() {
    if (!user) return [];
    
    try {
        const banksSnapshot = await firestore.collection('bankDetails').get();
        const availableBanks = [];
        
        banksSnapshot.forEach(doc => {
            const bankData = doc.data();
            // Skip transfer documents
            if (bankData.isTransfer || bankData.transferId || bankData.type === 'transfer') {
                return;
            }
            
            availableBanks.push({
                id: doc.id,
                name: bankData.bankName || bankData.name || bankData.bank || 'Unknown',
                currency: bankData.currency || 'KSH'
            });
        });
        
        return availableBanks;
    } catch (error) {
        console.error("Error getting available banks:", error);
        return [];
    }
}
// Find bank by payment method and currency
// Find bank by payment method (ONLY from existing banks, no ghost banks)
// Find bank by payment method (Query Firestore directly)
// Find bank by payment method (Query Firestore directly)

// Find bank by payment method (Query Firestore directly)
async function findBankByPaymentMethod(paymentMethod, currency) {
    if (!user) return null;
    
    const method = paymentMethod.toLowerCase();
    
    // First, check for M-Pesa/Mobile Money
    if (method.includes('mpesa') || method.includes('mobile') || method.includes('pesa')) {
        const mpesaBank = banks.find(b => b.id === 'mpesa');
        if (mpesaBank) {
            return mpesaBank;
        }
    }
    
    // Clean the payment method string to extract bank name
    let cleanMethod = method;
    cleanMethod = cleanMethod.replace(/\(usd\)/gi, '');
    cleanMethod = cleanMethod.replace(/\(ksh\)/gi, '');
    cleanMethod = cleanMethod.replace(/\(kes\)/gi, '');
    cleanMethod = cleanMethod.replace(/usd/gi, '');
    cleanMethod = cleanMethod.replace(/ksh/gi, '');
    cleanMethod = cleanMethod.replace(/kes/gi, '');
    cleanMethod = cleanMethod.replace(/\s+/g, ' ').trim();
    
    try {
        // Query bankDetails collection in Firestore
        const banksSnapshot = await firestore.collection('bankDetails').get();
        
        // Array to store matching banks
        const matchingBanks = [];
        
        banksSnapshot.forEach(doc => {
            const bankData = doc.data();
            const bankName = (bankData.bankName || bankData.name || bankData.bank || '').toLowerCase();
            const bankCurrency = bankData.currency || 'KSH';
            
            // Skip documents that aren't actual banks
            if (bankData.isTransfer || bankData.transferId || bankData.type === 'transfer') {
                return;
            }
            
            // Check if payment method contains bank name or vice versa
            const methodMatchesBank = cleanMethod.includes(bankName) || bankName.includes(cleanMethod);
            const currencyMatches = bankCurrency === currency;
            
            // If both method and currency match, this is a strong candidate
            if (methodMatchesBank && currencyMatches) {
                matchingBanks.push({
                    id: doc.id,
                    name: bankData.bankName || bankData.name || bankData.bank || 'Bank Account',
                    accountNumber: bankData.accountNumber || bankData.account || 'N/A',
                    branch: bankData.branch || '',
                    currency: bankCurrency,
                    firebaseId: doc.id,
                    firebaseData: bankData
                });
            }
        });
        
        // If we found exact matches, return the first one
        if (matchingBanks.length > 0) {
            // Check if this bank already exists locally
            const existingBank = banks.find(b => b.firebaseId === matchingBanks[0].id);
            if (existingBank) {
                return existingBank;
            }
            
            // Create a new local bank entry
            const newBank = {
                id: 'fb_' + matchingBanks[0].id,
                name: matchingBanks[0].name,
                accountNumber: matchingBanks[0].accountNumber,
                branch: matchingBanks[0].branch,
                currency: matchingBanks[0].currency,
                balance: 0,
                firebaseId: matchingBanks[0].id,
                firebaseData: matchingBanks[0].firebaseData,
                lastUpdated: new Date().toISOString(),
                isSynced: true
            };
            
            banks.push(newBank);
            return newBank;
        }
        
        // If no exact matches found, try fuzzy matching
        const bankKeywords = [
            { keywords: ['equity', 'equity bank'], currency: 'KSH' },
            { keywords: ['kcb', 'kenya commercial'], currency: 'KSH' },
            { keywords: ['cooperative', 'co-op'], currency: 'KSH' },
            { keywords: ['standard chartered', 'standard'], currency: 'KSH' },
            { keywords: ['barclays', 'absa'], currency: 'KSH' },
            { keywords: ['diamond trust', 'dtb'], currency: 'KSH' },
            { keywords: ['ncba'], currency: 'KSH' },
            { keywords: ['bank of africa', 'boa'], currency: 'KSH' },
            { keywords: ['citibank', 'citi'], currency: 'USD' },
            { keywords: ['stanbic'], currency: 'KSH' },
            { keywords: ['family bank'], currency: 'KSH' },
            { keywords: ['gt bank', 'guaranty trust'], currency: 'KSH' },
            { keywords: ['i&m'], currency: 'KSH' },
            { keywords: ['choice financial'], currency: 'USD' }
        ];
        
        for (const bankInfo of bankKeywords) {
            for (const keyword of bankInfo.keywords) {
                if (cleanMethod.includes(keyword) && bankInfo.currency === currency) {
                    // Search for this bank in Firestore
                    banksSnapshot.forEach(doc => {
                        const bankData = doc.data();
                        const bankName = (bankData.bankName || bankData.name || bankData.bank || '').toLowerCase();
                        const bankCurrency = bankData.currency || 'KSH';
                        
                        if (bankName.includes(keyword) && bankCurrency === currency) {
                            // Check if this bank already exists locally
                            const existingBank = banks.find(b => b.firebaseId === doc.id);
                            if (existingBank) {
                                return existingBank;
                            }
                            
                            // Create new local bank entry
                            const newBank = {
                                id: 'fb_' + doc.id,
                                name: bankData.bankName || bankData.name || bankData.bank || 'Bank Account',
                                accountNumber: bankData.accountNumber || bankData.account || 'N/A',
                                branch: bankData.branch || '',
                                currency: bankCurrency,
                                balance: 0,
                                firebaseId: doc.id,
                                firebaseData: bankData,
                                lastUpdated: new Date().toISOString(),
                                isSynced: true
                            };
                            
                            banks.push(newBank);
                            return newBank;
                        }
                    });
                }
            }
        }
        
    } catch (error) {
        console.error("Error querying banks from Firestore:", error);
    }
    
    // No matching bank found
    return null;
}
// Exchange rate function (with fallback)
async function getExchangeRate(fromCurrency, toCurrency) {
    // Try to get live rate from an API
    try {
        const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${fromCurrency}`);
        if (response.ok) {
            const data = await response.json();
            return data.rates[toCurrency] || getDefaultExchangeRate(fromCurrency, toCurrency);
        }
    } catch (error) {
        console.log('Using default exchange rate:', error);
    }
    
    // Fallback to default rates
    return getDefaultExchangeRate(fromCurrency, toCurrency);
}

function getDefaultExchangeRate(fromCurrency, toCurrency) {
    // Default rates (update these as needed)
    const rates = {
        'USD_KSH': 150, // 1 USD = 150 KSH
        'KSH_USD': 1/150 // 1 KSH = 0.00667 USD
    };
    
    if (fromCurrency === 'USD' && toCurrency === 'KSH') {
        return rates.USD_KSH;
    } else if (fromCurrency === 'KSH' && toCurrency === 'USD') {
        return rates.KSH_USD;
    }
    
    return 1; // Same currency
}


    // --- Tab Switching Function ---
    function openTab(evt, tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });

        // Remove active class from all tab buttons
        const tabButtons = document.querySelectorAll('.custom-tab');
        tabButtons.forEach(button => {
            button.classList.remove('active');
        });

        // Show the selected tab
        const selectedTab = document.getElementById(tabName);
        if (selectedTab) {
            selectedTab.style.display = 'block';
            selectedTab.classList.add('active');
        }

        // Add active class to clicked button
        if (evt && evt.currentTarget) {
            evt.currentTarget.classList.add('active');
        }
        
        // Update data when switching to bank management tab
        if (tabName === 'bank-management') {
            updateBankSelectors();
            updateTransferBankSelectors();
            updateBankCards();
            updateTransferHistory();
        }
    }

    // --- M-Pesa Bank Functions ---
    function ensureMpesaBank() {
        const mpesaBank = banks.find(b => b.id === 'mpesa');
        if (!mpesaBank) {
            banks.push({
                id: 'mpesa',
                name: 'M-Pesa',
                accountNumber: '0712-XXX-XXX',
                branch: 'Mobile Money',
                balance: 0,
                isMpesa: true,
                lastUpdated: new Date().toISOString(),
                primaryPettyCash: true
            });
        }
    }

    function updateMpesaFromPettyCash() {
        const mpesaBank = banks.find(b => b.id === 'mpesa');
        if (!mpesaBank) return;
        
        const { currentBalance } = calculatePettyCashBalance();
        mpesaBank.balance = currentBalance;
        mpesaBank.lastUpdated = new Date().toISOString();
        
        // Update bank cards if on bank management tab
        updateBankCards();
        updateBankSelectors();
        updateTransferBankSelectors();
        
        // Save to Firestore
        if (user) saveUserData();
    }

    // --- Balance Visibility Functions ---
    function toggleAllBalances() {
        balancesHidden = !balancesHidden;
        
        // Update all balance displays
        updateBalanceDisplay('current-balance', balancesHidden);
        updateBalanceDisplay('day-expense', balancesHidden);
        updateBalanceDisplay('day-income', balancesHidden);
        updateBalanceDisplay('total-bank-funds', balancesHidden);
        updateBalanceDisplay('total-outstanding-loans', balancesHidden);
        updateBalanceDisplay('monthly-spend', balancesHidden);
        
        // Update bank cards
        updateBankCards();
        
        // Update button text
        const button = document.querySelector('#petty-cash-balance-bar button:first-child');
        if (button) {
            if (balancesHidden) {
                button.innerHTML = '<i class="fas fa-eye mr-2"></i>Show All Balances';
            } else {
                button.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>Hide All Balances';
            }
        }
    }

    function updateBalanceDisplay(elementId, hidden) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        if (hidden) {
            element.classList.add('hidden-balance');
            if (elementId === 'current-balance') {
                element.textContent = '********';
            } else if (elementId === 'day-expense' || elementId === 'day-income') {
                element.textContent = 'KSH *****';
            } else {
                element.textContent = '*****';
            }
        } else {
            element.classList.remove('hidden-balance');
            // Restore actual values
            if (elementId === 'current-balance') {
                const { currentBalance } = calculatePettyCashBalance();
                element.textContent = formatKSH(currentBalance);
                element.style.color = currentBalance < 0 ? '#dc3545' : 'var(--primary-color)';
            } else if (elementId === 'day-expense') {
                const { totalExpense } = calculatePettyCashBalance();
                element.textContent = formatKSH(totalExpense);
            } else if (elementId === 'day-income') {
                const { totalIncome } = calculatePettyCashBalance();
                element.textContent = formatKSH(totalIncome);
            } else if (elementId === 'total-bank-funds') {
                const totalBankFunds = banks.reduce((sum, bank) => sum + bank.balance, 0);
                element.textContent = formatKSH(totalBankFunds);
            } else if (elementId === 'total-outstanding-loans') {
                const totalOutstandingLoans = loans.reduce((sum, loan) => sum + loan.balance, 0);
                element.textContent = formatKSH(totalOutstandingLoans);
            } else if (elementId === 'monthly-spend') {
                element.textContent = formatKSH(currentMonthSpend.totalExpense);
            }
        }
    }

 async function loadFirebaseBanks() {
    if (!user) return;
    
    showLoading('Loading bank data from Firebase...');
    
    try {
        const banksSnapshot = await firestore.collection('bankDetails').get();
        const banksListDiv = document.getElementById('firebase-banks-list');
        banksListDiv.innerHTML = '';
        
        if (banksSnapshot.empty) {
            banksListDiv.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-university text-3xl mb-3"></i>
                    <p>No banks found in Firebase</p>
                    <p class="text-sm mt-2">Add banks in your other system first</p>
                </div>
            `;
            showLoading(false);
            return;
        }
        
        let hasAvailableBanks = false;
        banksSnapshot.forEach(doc => {
            const bankData = doc.data();
            const bankId = doc.id;
            
            // Skip any documents that aren't actual banks (like transfers)
            if (bankData.isTransfer || bankData.transferId || 
                bankData.type === 'transfer' || bankData.category === 'transfer') {
                return; // Skip this document
            }
            
            // Check if bank already exists locally
            const existingBank = banks.find(b => b.firebaseId === bankId);
            
            // Only show banks not already added locally
            if (!existingBank) {
                hasAvailableBanks = true;
                
                // Extract bank name from Firebase data
                const bankName = bankData.bankName || 
                               bankData.name || 
                               bankData.bank || 
                               'Bank Account';
                
                // Extract account number
                const accountNumber = bankData.accountNumber || 
                                    bankData.account || 
                                    'N/A';
                
                // Extract branch
                const branch = bankData.branch || '';
                
                // Extract currency
                const currency = bankData.currency || 'KSH';
                
                const bankOption = document.createElement('div');
                bankOption.className = `p-4 border rounded-lg cursor-pointer transition-all hover:bg-gray-50 bg-white border-gray-200`;
                bankOption.onclick = () => selectFirebaseBank(bankId, bankData);
                bankOption.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-gray-800">${bankName}</h4>
                            <p class="text-sm text-gray-600">Account: ${accountNumber}</p>
                            <p class="text-xs text-gray-500 mt-1">Currency: ${currency}</p>
                            ${branch ? `<p class="text-xs text-gray-500 mt-1">${branch}</p>` : ''}
                            <p class="text-xs text-green-600 mt-1 font-medium">Click to add</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                `;
                
                banksListDiv.appendChild(bankOption);
            }
        });
        
        if (!hasAvailableBanks) {
            banksListDiv.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-check-circle text-3xl mb-3 text-green-500"></i>
                    <p>All Firebase banks have been added</p>
                    <p class="text-sm mt-2">Add more banks in your other system</p>
                </div>
            `;
        }
        
        showLoading(false);
    } catch (error) {
        console.error("Error loading banks:", error);
        showLoading(false);
        showToast('Error loading banks from Firebase', 'error');
    }
}

   // Modify the existing loadReceiptPayments function to use the new processing
async function loadReceiptPayments() {
    if (!user) return;
    
    try {
        const paymentsSnapshot = await firestore.collection('receipt_payments').get();
        const receipts = [];
        
        paymentsSnapshot.forEach(doc => {
            receipts.push({ id: doc.id, ...doc.data() });
        });
        
        // Track processed payments to avoid duplicates
        const processedPaymentIds = new Set(
            majorTransactions
                .filter(t => t.isFromReceipt && t.receiptId)
                .map(t => t.receiptId)
        );
        
        // Process only unprocessed receipts
        for (const receipt of receipts) {
            if (!processedPaymentIds.has(receipt.id)) {
                await processNewPayment(receipt);
            } else {
                console.log('Skipping already processed payment:', receipt.id);
            }
        }
        
        // Update all UI components
        updateFinancialDashboard();
        updateBankCards();
        updateBankSelectors();
        updateTransferBankSelectors();
        
    } catch (error) {
        console.error("Error loading receipts:", error);
        showToast('Error loading payments from Firebase', 'error');
    }
}
    function updateBankBalancesFromReceipts(receipts) {
        receipts.forEach(receipt => {
            const bankName = receipt.bankName || receipt.bank;
            const amount = parseFloat(receipt.amount) || 0;
            
            if (bankName && amount) {
                // Check if it's M-Pesa
                if (bankName.toLowerCase().includes('mpesa') || bankName.toLowerCase().includes('mobile')) {
                    const mpesaBank = banks.find(b => b.id === 'mpesa');
                    if (mpesaBank) {
                        mpesaBank.balance += amount;
                        
                        // Add to petty cash as income
                        pettyCashTransactions.push({
                            date: new Date(receipt.paymentDate || Date.now()).toLocaleDateString('en-KE'),
                            time: new Date(receipt.paymentDate || Date.now()).toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' }),
                            description: `M-Pesa payment: ${receipt.receiptNumber || 'Unknown'}`,
                            recipient: 'M-Pesa',
                            cost: amount,
                            type: 'income'
                        });
                        
                        renderPettyCash();
                        updatePettyCashBalanceDisplay();
                        updatePettyCashChart();
                    }
                } else {
                    // Find local bank by name
                    const localBank = banks.find(b => 
                        b.name.toLowerCase().includes(bankName.toLowerCase()) || 
                        bankName.toLowerCase().includes(b.name.toLowerCase())
                    );
                    
                    if (localBank && receipt.paymentDate) {
                        localBank.balance += amount;
                        
                        // Add to major transactions
                        majorTransactions.push({
                            description: `Payment from receipt: ${receipt.receiptNumber || 'Unknown'}`,
                            amount: amount,
                            category: 'Sales',
                            date: new Date(receipt.paymentDate).toLocaleDateString('en-KE') || new Date().toLocaleDateString('en-KE'),
                            bankId: localBank.id,
                            isFromReceipt: true
                        });
                        
                        console.log(`Updated ${localBank.name} balance by +${amount} from receipt`);
                    }
                }
            }
        });
        
        updateFinancialDashboard();
        updateBankCards();
        updateBankSelectors();
        updateTransferBankSelectors();
        
        // Save to Firestore
        if (user) saveUserData();
    }

    function selectFirebaseBank(bankId, bankData) {
        // Extract bank name from Firebase data with multiple possible field names
        const bankName = bankData.bankName || 
                       bankData.name || 
                       bankData.bank || 
                       bankData.bank_name || 
                       bankData.bankName || 
                       'Bank Account';
        
        const accountNumber = bankData.accountNumber || 
                            bankData.account || 
                            bankData.account_number || 
                            bankData.accountNumber || 
                            'N/A';
        
        const branch = bankData.branch || 
                     bankData.branchName || 
                     bankData.branch_name || 
                     bankData.branchName || 
                     '';
        
        selectedFirebaseBank = {
            id: bankId,
            name: bankName,
            accountNumber: accountNumber,
            branch: branch,
            data: bankData
        };
        
        // Highlight selection
        document.querySelectorAll('#firebase-banks-list > div').forEach(div => {
            div.classList.remove('bg-primary', 'text-white', 'border-primary');
            div.classList.add('bg-white', 'border-gray-200');
        });
        
        event.currentTarget.classList.remove('bg-white', 'border-gray-200');
        event.currentTarget.classList.add('bg-primary', 'text-white', 'border-primary');
        
        // Update selected bank name display
        document.getElementById('selected-bank-name').textContent = selectedFirebaseBank.name;
        document.getElementById('confirm-bank-name').textContent = selectedFirebaseBank.name;
    }

    // --- Add Bank Modal Functions ---
    function openAddBankModal() {
        if (!user) {
            showToast('Please connect to Firebase first', 'warning');
            toggleFirebaseLogin();
            return;
        }
        
        const modal = document.getElementById('add-bank-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
        loadFirebaseBanks();
        resetAddBankModal();
    }

    function closeAddBankModal() {
        const modal = document.getElementById('add-bank-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    function resetAddBankModal() {
        addBankStep = 1;
        selectedFirebaseBank = null;
        
        // Reset steps
        document.getElementById('step-1-indicator').className = 'step-indicator active';
        document.getElementById('step-2-indicator').className = 'step-indicator';
        document.getElementById('step-3-indicator').className = 'step-indicator';
        
        // Show step 1
        document.querySelectorAll('.bank-step').forEach(step => {
            step.classList.remove('active');
            step.style.display = 'none';
        });
        document.getElementById('step-1').classList.add('active');
        document.getElementById('step-1').style.display = 'block';
        
        // Reset inputs
        document.getElementById('bank-initial-balance').value = '';
        document.getElementById('confirm-terms').checked = false;
    }

    function nextBankStep() {
        if (addBankStep === 1) {
            if (!selectedFirebaseBank) {
                showToast('Please select a bank first', 'error');
                return;
            }
            addBankStep = 2;
        } else if (addBankStep === 2) {
            const balance = parseFloat(document.getElementById('bank-initial-balance').value);
            if (!balance || balance < 0) {
                showToast('Please enter a valid balance', 'error');
                return;
            }
            document.getElementById('confirm-bank-balance').textContent = `KSH ${balance.toLocaleString('en-KE')}`;
            addBankStep = 3;
        }
        
        updateBankModalSteps();
    }

    function prevBankStep() {
        if (addBankStep === 2) {
            addBankStep = 1;
        } else if (addBankStep === 3) {
            addBankStep = 2;
        }
        updateBankModalSteps();
    }

    function updateBankModalSteps() {
        // Update indicators
        document.getElementById('step-1-indicator').className = `step-indicator ${addBankStep >= 1 ? 'active' : ''}`;
        document.getElementById('step-2-indicator').className = `step-indicator ${addBankStep >= 2 ? 'active' : ''}`;
        document.getElementById('step-3-indicator').className = `step-indicator ${addBankStep >= 3 ? 'active' : ''}`;
        
        // Show current step
        document.querySelectorAll('.bank-step').forEach(step => {
            step.classList.remove('active');
            step.style.display = 'none';
        });
        
        const currentStep = document.getElementById(`step-${addBankStep}`);
        if (currentStep) {
            currentStep.classList.add('active');
            currentStep.style.display = 'block';
        }
    }

  function submitNewBank() {
    const termsAccepted = document.getElementById('confirm-terms').checked;
    if (!termsAccepted) {
        showToast('Please confirm the terms', 'error');
        return;
    }
    
    const balance = parseFloat(document.getElementById('bank-initial-balance').value);
    
    const newBank = {
        id: 'fb_' + selectedFirebaseBank.id,
        name: selectedFirebaseBank.name,
        accountNumber: selectedFirebaseBank.accountNumber,
        branch: selectedFirebaseBank.branch,
        currency: selectedFirebaseBank.data.currency || 'KSH',
        balance: balance,
        firebaseId: selectedFirebaseBank.id,
        firebaseData: selectedFirebaseBank.data,
        lastUpdated: new Date().toISOString(),
        isSynced: true
    };
    
    // Check if bank already exists
    const existingBankIndex = banks.findIndex(b => b.firebaseId === newBank.firebaseId);
    if (existingBankIndex >= 0) {
        // Update existing bank
        banks[existingBankIndex] = { ...banks[existingBankIndex], ...newBank };
        showToast(`Bank ${newBank.name} updated successfully!`, 'success');
    } else {
        // Add new bank
        banks.push(newBank);
        showToast(`Bank ${newBank.name} added successfully!`, 'success');
    }
    
    updateBankSelectors();
    updateTransferBankSelectors();
    updateFinancialDashboard();
    updateBankCards();
    closeAddBankModal();
    
    // Update quick stats
    updateQuickStats();
    
    // Save to Firestore
    if (user) saveUserData();
}

    // --- Inter-Bank Transfer Functions ---
    function updateTransferBankSelectors() {
        const fromSelect = document.getElementById('transfer-from-bank');
        const toSelect = document.getElementById('transfer-to-bank');
        
        if (!fromSelect || !toSelect) return;
        
        fromSelect.innerHTML = '<option value="" disabled selected>Select Source Bank</option>';
        toSelect.innerHTML = '<option value="" disabled selected>Select Destination Bank</option>';
        
        if (banks.length === 0) {
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "No banks available - Add banks first";
            option.disabled = true;
            fromSelect.appendChild(option.cloneNode(true));
            toSelect.appendChild(option.cloneNode(true));
            return;
        }
        
        banks.forEach(bank => {
            const fromOption = document.createElement('option');
            fromOption.value = bank.id;
            if (bank.id === 'mpesa') {
                fromOption.textContent = `${bank.name} (Petty Cash) - ${formatKSH(bank.balance)}`;
            } else {
                fromOption.textContent = `${bank.name} - ${formatKSH(bank.balance)}`;
            }
            fromSelect.appendChild(fromOption.cloneNode(true));
            
            const toOption = fromOption.cloneNode(true);
            toSelect.appendChild(toOption);
        });
        
        // Add event listeners for balance display
        fromSelect.addEventListener('change', function() {
            const bank = getBankById(this.value);
            const balanceElement = document.getElementById('from-bank-balance');
            if (bank && balanceElement) {
                balanceElement.innerHTML = 
                    `<span class="font-semibold">Current Balance:</span> ${formatKSH(bank.balance)}`;
            }
        });
        
        toSelect.addEventListener('change', function() {
            const bank = getBankById(this.value);
            const balanceElement = document.getElementById('to-bank-balance');
            if (bank && balanceElement) {
                balanceElement.innerHTML = 
                    `<span class="font-semibold">Current Balance:</span> ${formatKSH(bank.balance)}`;
            }
        });
        
        // Initialize fee calculation
        const transferAmount = document.getElementById('transfer-amount');
        if (transferAmount) {
            transferAmount.addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                const fee = calculateTransferFee(amount);
                const feeElement = document.getElementById('transfer-fee');
                if (feeElement) {
                    feeElement.textContent = `Transfer Fee: ${formatKSH(fee)}`;
                }
            });
        }
    }

    function calculateTransferFee(amount) {
        // Simple fee calculation: 0.1% or min 50, max 5000
        const fee = Math.max(50, Math.min(5000, amount * 0.001));
        return fee;
    }

    function closeTransferConfirm() {
        const modal = document.getElementById('transfer-confirm-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        document.getElementById('transfer-pin').value = '';
    }

function executeBankTransfer() {
    const pin = document.getElementById('transfer-pin').value;
    
    if (pin !== '2679') { // Using the same access code as security pin
        showToast('Invalid security PIN', 'error');
        return;
    }
    
    const fromBankId = document.getElementById('transfer-from-bank').value;
    const toBankId = document.getElementById('transfer-to-bank').value;
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const fee = parseFloat(document.getElementById('transfer-fee-input').value) || 0;
    const feeBearer = document.getElementById('fee-bearer').value;
    const reason = document.getElementById('transfer-reason').value;
    
    const fromBank = getBankById(fromBankId);
    const toBank = getBankById(toBankId);

      // Check if currencies match, convert if necessary
    if (fromBank.currency !== toBank.currency) {
        const confirmConvert = confirm(
            `Currency mismatch!\nFrom: ${fromBank.currency}\nTo: ${toBank.currency}\n` +
            `Amount ${formatCurrency(amount, fromBank.currency)} will be converted.\n\n` +
            `Continue with conversion?`
        );
        
        if (!confirmConvert) {
            return;
        }
    }
    
    // Calculate total debit based on fee bearer
    let fromBankDebit = amount;
    let toBankCredit = amount;
    
    if (feeBearer === 'sending') {
        fromBankDebit += fee;
    } else if (feeBearer === 'receiving') {
        toBankCredit -= fee;
    }
    
    // Check if sending bank has sufficient funds
    if (fromBank.balance < fromBankDebit) {
        showToast(`Insufficient funds. Available: ${formatKSH(fromBank.balance)}, Required: ${formatKSH(fromBankDebit)}`, 'error');
        return;
    }
    
    // Execute transfer
    fromBank.balance -= fromBankDebit;
    toBank.balance += toBankCredit;
    
    // If transferring to/from M-Pesa, update petty cash
    if (toBank.id === 'mpesa') {
        // Add as petty cash income
        pettyCashTransactions.push({
            date: new Date().toLocaleDateString('en-KE'),
            time: new Date().toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' }),
            description: `Bank transfer to M-Pesa: ${reason || 'Transfer'}`,
            recipient: 'M-Pesa',
            cost: amount,
            type: 'income'
        });
        renderPettyCash();
        updatePettyCashBalanceDisplay();
        updatePettyCashChart();
    } else if (fromBank.id === 'mpesa') {
        // Add as petty cash expense
        pettyCashTransactions.push({
            date: new Date().toLocaleDateString('en-KE'),
            time: new Date().toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' }),
            description: `M-Pesa transfer to ${toBank.name}: ${reason || 'Transfer'}`,
            recipient: toBank.name,
            cost: amount + (feeBearer === 'sending' ? fee : 0),
            type: 'expense'
        });
        renderPettyCash();
        updatePettyCashBalanceDisplay();
        updatePettyCashChart();
    }
    
    // Record transfer
    const transferId = 't' + Date.now();
    const transferRecord = {
        id: transferId,
        date: new Date().toISOString(),
        fromBankId: fromBankId,
        fromBankName: fromBank.name,
        toBankId: toBankId,
        toBankName: toBank.name,
        amount: amount,
        fee: fee,
        feeBearer: feeBearer,
        fromBankDebit: fromBankDebit,
        toBankCredit: toBankCredit,
        reason: reason,
        status: 'completed'
    };
    
    bankTransfers.push(transferRecord);
    
    // Add to major transactions
    majorTransactions.push({
        description: `Bank Transfer: ${reason || 'Inter-bank transfer'}`,
        amount: amount,
        category: 'Assets',
        date: new Date().toLocaleDateString('en-KE'),
        bankId: toBankId,
        isTransfer: true,
        transferId: transferId
    });
    
    // Add fee as expense to the appropriate bank
    if (fee > 0) {
        const feeBankId = feeBearer === 'sending' ? fromBankId : toBankId;
        const feeBank = getBankById(feeBankId);
        majorTransactions.push({
            description: `Bank Transfer Fee`,
            amount: fee,
            category: 'Overheads',
            date: new Date().toLocaleDateString('en-KE'),
            bankId: feeBankId,
            isTransferFee: true,
            transferId: transferId,
            feeBearer: feeBearer
        });
    }
    
    // Update UI
    updateFinancialDashboard();
    updateBankCards();
    updateTransferHistory();
    updateBankSelectors();
    updateTransferBankSelectors();
    
    // Clear form
    document.getElementById('bank-transfer-form').reset();
    document.getElementById('transfer-preview').classList.add('hidden');
    document.getElementById('transfer-pin').value = '';
    document.getElementById('transfer-confirm-modal').classList.add('hidden');
    
    // Animate bank cards
    const fromCard = document.querySelector(`[data-bank-id="${fromBankId}"]`);
    const toCard = document.querySelector(`[data-bank-id="${toBankId}"]`);
    
    if (fromCard) fromCard.classList.add('transfer-animation');
    if (toCard) toCard.classList.add('transfer-animation');
    
    setTimeout(() => {
        if (fromCard) fromCard.classList.remove('transfer-animation');
        if (toCard) toCard.classList.remove('transfer-animation');
    }, 500);
    
    showToast(`Transfer of ${formatKSH(amount)} completed successfully!`, 'success');
    
    // Update quick stats
    updateQuickStats();
    
    // Save to Firestore
    if (user) saveUserData();
}

    function updateTransferHistory() {
        const tbody = document.getElementById('transfer-history');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Show last 5 transfers
        const recentTransfers = [...bankTransfers]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);
        
        if (recentTransfers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-exchange-alt text-3xl mb-3"></i>
                        <p>No transfers yet</p>
                        <p class="text-sm mt-2">Make your first inter-bank transfer above</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        recentTransfers.forEach(transfer => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const date = new Date(transfer.date);
            const formattedDate = date.toLocaleDateString('en-KE');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formattedDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${transfer.fromBankName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${transfer.toBankName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatKSH(transfer.amount)}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                        ${transfer.status}
                    </span>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // --- Bank Cards Display ---
// Add currency display to bank cards
function updateBankCards() {
     // Filter out any banks that might be transfers
    const actualBanks = banks.filter(bank => 
        !bank.isTransfer && 
        !bank.transferId && 
        bank.id !== 'transfer' &&
        !bank.name.toLowerCase().includes('transfer')
    );
    const container = document.getElementById('bank-details-cards');
    const loading = document.getElementById('bank-cards-loading');
    const noBanks = document.getElementById('no-banks-message');
    
    if (!container || !loading || !noBanks) return;
    
    if (banks.length === 0) {
        container.innerHTML = '';
        loading.classList.add('hidden');
        noBanks.classList.remove('hidden');
        return;
    }
    
    loading.classList.add('hidden');
    noBanks.classList.add('hidden');
    container.innerHTML = '';
    
    banks.forEach(bank => {
        const card = document.createElement('div');
        
        // Special styling for M-Pesa
        if (bank.id === 'mpesa') {
            card.className = 'mpesa-card rounded-xl shadow-card overflow-hidden hover:shadow-card-hover transition-all duration-300';
        } else {
            card.className = 'bg-white rounded-xl shadow-card overflow-hidden hover:shadow-card-hover transition-all duration-300';
        }
        
        card.setAttribute('data-bank-id', bank.id);
        
        const balanceColor = bank.balance < 0 ? 'text-red-500' : (bank.id === 'mpesa' ? 'text-white' : 'text-primary');
        const balanceIcon = bank.balance < 0 ? 'fa-arrow-down' : 'fa-arrow-up';
        const displayBalance = balancesHidden ? '*****' : formatKSH(bank.balance);
        const currency = bank.currency || 'KSH';
        const currencySymbol = currency === 'USD' ? '$' : 'KSH';
        
        card.innerHTML = `
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="text-xl font-bold ${bank.id === 'mpesa' ? 'text-white' : 'text-gray-800'}">
                            ${bank.name}
                            ${bank.id === 'mpesa' ? '<span class="mpesa-badge text-xs px-2 py-1 rounded-full ml-2">Petty Cash</span>' : ''}
                            ${bank.isAutoGenerated ? '<span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800 ml-2">Auto</span>' : ''}
                        </h4>
                        <p class="${bank.id === 'mpesa' ? 'text-white opacity-80' : 'text-gray-600'} mt-1">${bank.accountNumber || 'No account number'}</p>
                        ${bank.branch ? `<p class="${bank.id === 'mpesa' ? 'text-white opacity-60' : 'text-gray-500'} text-xs mt-1">${bank.branch}</p>` : ''}
                        <p class="${bank.id === 'mpesa' ? 'text-white opacity-70' : 'text-gray-500'} text-xs mt-1">
                            ${currency} ${bank.currency === 'USD' ? '($USD)' : '(KSH)'}
                        </p>
                    </div>
                    <div class="${bank.id === 'mpesa' ? 'bg-white bg-opacity-20 text-white' : 'bg-primary bg-opacity-10 text-primary'} p-3 rounded-lg">
                        <i class="fas ${bank.id === 'mpesa' ? 'fa-mobile-alt' : 'fa-university'} text-xl"></i>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="${bank.id === 'mpesa' ? 'text-white opacity-80' : 'text-gray-600'}">Current Balance</span>
                        <span class="text-xs ${bank.id === 'mpesa' ? 'text-white opacity-60' : 'text-gray-500'}">Updated: ${new Date(bank.lastUpdated || Date.now()).toLocaleTimeString('en-KE', {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="text-2xl font-bold ${balanceColor} flex items-center ${balancesHidden ? 'hidden-balance' : ''}">
                        <i class="fas ${balanceIcon} mr-2"></i>
                        ${displayBalance} ${currency === 'USD' ? '(USD)' : '(KSH)'}
                        <span class="text-sm ml-2">${currency === 'USD' ? '($USD)' : '(KSH)'}</span>
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="updateBankBalance('${bank.id}')"
                            class="flex-1 ${bank.id === 'mpesa' ? 'bg-white bg-opacity-20 hover:bg-opacity-30 text-white' : 'bg-blue-50 hover:bg-blue-100 text-blue-600'} font-medium py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center">
                        <i class="fas fa-edit mr-2"></i>Update
                    </button>
                    <button onclick="showBankTransactions('${bank.id}')"
                            class="flex-1 ${bank.id === 'mpesa' ? 'bg-white bg-opacity-10 hover:bg-opacity-20 text-white' : 'bg-gray-50 hover:bg-gray-100 text-gray-600'} font-medium py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center">
                        <i class="fas fa-history mr-2"></i>History
                    </button>
                </div>
            </div>
            
            ${bank.firebaseId ? `
            <div class="${bank.id === 'mpesa' ? 'bg-white bg-opacity-10' : 'bg-gray-50'} px-6 py-3 border-t ${bank.id === 'mpesa' ? 'border-white border-opacity-20' : 'border-gray-100'}">
                <div class="flex items-center text-sm ${bank.id === 'mpesa' ? 'text-white opacity-80' : 'text-gray-600'}">
                    <i class="fas fa-fire ${bank.id === 'mpesa' ? 'text-yellow-300' : 'text-orange-500'} mr-2"></i>
                    <span>Synced with Firebase</span>
                    <button onclick="syncBankWithFirebase('${bank.id}')"
                            class="ml-auto ${bank.id === 'mpesa' ? 'text-yellow-300 hover:text-yellow-200' : 'text-primary hover:text-primary-dark'} text-xs font-medium">
                        <i class="fas fa-sync-alt mr-1"></i>Sync Now
                    </button>
                </div>
            </div>
            ` : ''}
        `;
        
        container.appendChild(card);
    });
    
    // Update quick stats
    updateQuickStats();
}
    // --- Loan Card Functions ---
    function updateLoanCards() {
        const container = document.getElementById('loan-cards-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (loans.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8 text-gray-500">
                    <i class="fas fa-hand-holding-usd text-3xl mb-3"></i>
                    <p>No active loans</p>
                    <p class="text-sm mt-2">Add loans to see them listed here</p>
                </div>
            `;
            return;
        }
        
        loans.forEach(loan => {
            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-xl shadow-card hover:shadow-card-hover transition-all duration-300';
            
            // Calculate repayment progress
            const repaymentProgress = ((loan.originalBalance - loan.balance) / loan.originalBalance) * 100;
            const dueDate = new Date(loan.dueDate);
            const today = new Date();
            const daysRemaining = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            const isOverdue = daysRemaining < 0;
            
            // Determine card color based on status
            let statusColor = 'bg-green-100 text-green-800';
            if (isOverdue) {
                statusColor = 'bg-red-100 text-red-800';
            } else if (daysRemaining < 30) {
                statusColor = 'bg-yellow-100 text-yellow-800';
            }
            
            card.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-xl font-bold text-gray-800">${loan.institution}</h4>
                            <p class="text-sm text-gray-600 mt-1">${loan.type.charAt(0).toUpperCase() + loan.type.slice(1)} Loan</p>
                        </div>
                        <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-lg">
                            <i class="fas fa-landmark text-xl"></i>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-600">Current Balance</span>
                            <span class="font-bold text-lg ${loan.balance > 0 ? 'text-red-600' : 'text-green-600'} ${balancesHidden ? 'hidden-balance' : ''}">
                                ${balancesHidden ? '*****' : formatKSH(loan.balance)}
                            </span>
                        </div>
                        
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="bg-primary h-2 rounded-full" style="width: ${Math.min(100, repaymentProgress)}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 flex justify-between">
                            <span>Repaid: ${repaymentProgress.toFixed(1)}%</span>
                            <span class="${balancesHidden ? 'hidden-balance' : ''}">Original: ${balancesHidden ? '*****' : formatKSH(loan.originalBalance)}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div>
                            <span class="text-gray-600 block">Interest Rate</span>
                            <span class="font-semibold">${loan.interestRate}%</span>
                        </div>
                        <div>
                            <span class="text-gray-600 block">Due In</span>
                            <span class="font-semibold ${isOverdue ? 'text-red-600' : ''}">
                                ${isOverdue ? Math.abs(daysRemaining) + ' days overdue' : daysRemaining + ' days'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="openLoanRepaymentModal('${loan.id}')"
                                class="flex-1 bg-primary hover:bg-primary-dark text-white font-medium py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center">
                            <i class="fas fa-money-check-alt mr-2"></i>Repay
                        </button>
                        <button onclick="viewLoanDetails('${loan.id}')"
                                class="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-600 font-medium py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center">
                            <i class="fas fa-history mr-2"></i>History
                        </button>
                    </div>
                </div>
                
                <div class="px-5 py-3 border-t border-gray-100 ${statusColor}">
                    <div class="flex items-center text-sm">
                        <i class="fas ${isOverdue ? 'fa-exclamation-triangle' : 'fa-calendar-check'} mr-2"></i>
                        <span>${isOverdue ? 'PAYMENT OVERDUE' : (daysRemaining < 30 ? 'PAYMENT DUE SOON' : 'ACTIVE')}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    function openLoanRepaymentModal(loanId) {
        currentRepaymentLoanId = loanId;
        const loan = loans.find(l => l.id === loanId);
        if (!loan) return;
        
        const modal = document.getElementById('loan-repayment-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
        
        // Update loan details
        const detailsDiv = document.getElementById('repayment-loan-details');
        detailsDiv.innerHTML = `
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <span class="text-gray-600 text-sm">Institution:</span>
                    <p class="font-semibold">${loan.institution}</p>
                </div>
                <div>
                    <span class="text-gray-600 text-sm">Current Balance:</span>
                    <p class="font-bold text-lg text-red-600">${formatKSH(loan.balance)}</p>
                </div>
                <div>
                    <span class="text-gray-600 text-sm">Loan Type:</span>
                    <p class="font-medium">${loan.type.charAt(0).toUpperCase() + loan.type.slice(1)}</p>
                </div>
                <div>
                    <span class="text-gray-600 text-sm">Due Date:</span>
                    <p class="font-medium">${new Date(loan.dueDate).toLocaleDateString('en-KE')}</p>
                </div>
            </div>
        `;
        
        // Update bank selector
        const bankSelect = document.getElementById('repayment-bank-select');
        bankSelect.innerHTML = '<option value="" disabled selected>Select Bank for Repayment</option>';
        
        if (banks.length === 0) {
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "No banks available";
            option.disabled = true;
            bankSelect.appendChild(option);
        } else {
            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.id;
                if (bank.id === 'mpesa') {
                    option.textContent = `${bank.name} (Petty Cash) - ${formatKSH(bank.balance)}`;
                } else {
                    option.textContent = `${bank.name} - ${formatKSH(bank.balance)}`;
                }
                bankSelect.appendChild(option);
            });
        }
        
        // Add event listener for bank balance display
        bankSelect.addEventListener('change', function() {
            const bank = getBankById(this.value);
            const balanceElement = document.getElementById('repayment-bank-balance');
            if (bank && balanceElement) {
                balanceElement.innerHTML = 
                    `<span class="font-semibold">Available Balance:</span> ${formatKSH(bank.balance)}`;
            }
        });
        
        // Update remaining balance text
        document.getElementById('remaining-balance-text').textContent = 
            `Remaining balance: ${formatKSH(loan.balance)}`;
        
        // Update preview
        updateRepaymentPreview();
        
        // Add event listeners for real-time preview
        document.getElementById('repayment-amount').addEventListener('input', updateRepaymentPreview);
        document.getElementById('repayment-bank-select').addEventListener('change', updateRepaymentPreview);
    }

    function closeLoanRepaymentModal() {
        const modal = document.getElementById('loan-repayment-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        currentRepaymentLoanId = null;
        document.getElementById('loan-repayment-form').reset();
    }

    function fillFullBalance() {
        const loan = loans.find(l => l.id === currentRepaymentLoanId);
        if (!loan) return;
        
        document.getElementById('repayment-amount').value = loan.balance.toFixed(2);
        updateRepaymentPreview();
    }

    function updateRepaymentPreview() {
        const loan = loans.find(l => l.id === currentRepaymentLoanId);
        if (!loan) return;
        
        const amount = parseFloat(document.getElementById('repayment-amount').value) || 0;
        const bankId = document.getElementById('repayment-bank-select').value;
        const bank = getBankById(bankId);
        
        document.getElementById('preview-loan').textContent = loan.institution;
        document.getElementById('preview-amount').textContent = formatKSH(amount);
        document.getElementById('preview-source-bank').textContent = bank ? bank.name : 'Not selected';
        document.getElementById('preview-new-balance').textContent = formatKSH(Math.max(0, loan.balance - amount));
    }

    function viewLoanDetails(loanId) {
        const loan = loans.find(l => l.id === loanId);
        if (!loan) return;
        
        let message = `Loan Details - ${loan.institution}\n\n`;
        message += `Type: ${loan.type.charAt(0).toUpperCase() + loan.type.slice(1)}\n`;
        message += `Original Amount: ${formatKSH(loan.originalBalance)}\n`;
        message += `Current Balance: ${formatKSH(loan.balance)}\n`;
        message += `Interest Rate: ${loan.interestRate}%\n`;
        message += `Due Date: ${new Date(loan.dueDate).toLocaleDateString('en-KE')}\n`;
        message += `Disbursed to: ${loan.bankName}\n\n`;
        
        if (loan.repayments && loan.repayments.length > 0) {
            message += `Repayment History:\n\n`;
            loan.repayments.forEach(repayment => {
                message += `${new Date(repayment.date).toLocaleDateString('en-KE')}: ${formatKSH(repayment.amount)}\n`;
                message += `  From: ${repayment.bankName}\n`;
                message += `  Ref: ${repayment.reference}\n`;
                if (repayment.notes) message += `  Notes: ${repayment.notes}\n`;
                message += `\n`;
            });
        } else {
            message += `No repayments made yet.\n`;
        }
        
        alert(message);
    }

    function updateBankBalance(bankId) {
        const bank = getBankById(bankId);
        if (!bank) return;
        
        const newBalance = prompt(`Update balance for ${bank.name}\nCurrent: ${formatKSH(bank.balance)}\n\nEnter new balance (KSH):`, bank.balance);
        
        if (newBalance !== null) {
            const balance = parseFloat(newBalance);
            if (!isNaN(balance)) {
                const oldBalance = bank.balance;
                bank.balance = balance;
                bank.lastUpdated = new Date().toISOString();
                
                // If updating M-Pesa, also update petty cash
                if (bank.id === 'mpesa') {
                    // Update petty cash transactions to reflect new balance
                    const { currentBalance } = calculatePettyCashBalance();
                    const difference = balance - currentBalance;
                    
                    if (difference !== 0) {
                        pettyCashTransactions.push({
                            date: new Date().toLocaleDateString('en-KE'),
                            time: new Date().toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' }),
                            description: `Manual M-Pesa balance adjustment`,
                            recipient: 'System',
                            cost: Math.abs(difference),
                            type: difference > 0 ? 'income' : 'expense'
                        });
                        renderPettyCash();
                        updatePettyCashBalanceDisplay();
                        updatePettyCashChart();
                    }
                }
                
                // Record the adjustment
                majorTransactions.push({
                    description: `Manual balance adjustment for ${bank.name}`,
                    amount: Math.abs(balance - oldBalance),
                    category: balance > oldBalance ? 'Sales' : 'Overheads',
                    date: new Date().toLocaleDateString('en-KE'),
                    bankId: bankId,
                    isAdjustment: true,
                    oldBalance: oldBalance,
                    newBalance: balance
                });
                
                updateFinancialDashboard();
                updateBankCards();
                updateBankSelectors();
                updateTransferBankSelectors();
                
                showToast(`Updated ${bank.name} balance to ${formatKSH(balance)}`, 'success');
                
                // Save to Firestore
                if (user) saveUserData();
            } else {
                showToast('Invalid balance amount', 'error');
            }
        }
    }

    function showBankTransactions(bankId) {
        const bank = getBankById(bankId);
        if (!bank) return;
        
        // Filter transactions for this bank
        const bankTransactions = majorTransactions.filter(t => t.bankId === bankId);
        
        if (bankTransactions.length === 0) {
            alert(`No transactions recorded for ${bank.name}`);
            return;
        }
        
        let message = `Transaction History for ${bank.name}\n\n`;
        message += `Current Balance: ${formatKSH(bank.balance)}\n\n`;
        
        bankTransactions.slice(-10).reverse().forEach(t => {
            const type = t.category === 'Sales' ? 'INCOME' : 'EXPENSE';
            const sign = t.category === 'Sales' ? '+' : '-';
            message += `${t.date}: ${t.description}\n`;
            message += `  ${type}: ${sign}${formatKSH(t.amount)}\n\n`;
        });
        
        alert(message);
    }

    async function syncBankWithFirebase(bankId) {
        const bank = getBankById(bankId);
        if (!bank || !bank.firebaseId) return;
        
        showLoading(`Syncing ${bank.name} with Firebase...`);
        
        try {
            // In a real implementation, you would update Firebase with the current balance
            // or fetch the latest from Firebase
            
            // For now, we'll simulate a sync
            setTimeout(() => {
                showLoading(false);
                showToast(`${bank.name} synced successfully!`, 'success');
                
                // Update the last updated time
                bank.lastUpdated = new Date().toISOString();
                updateBankCards();
                
                // Save to Firestore
                if (user) saveUserData();
            }, 1000);
            
        } catch (error) {
            showLoading(false);
            showToast(`Sync failed: ${error.message}`, 'error');
        }
    }

    // --- Utility Functions ---
    function getBankById(id) {
        return banks.find(b => b.id === id);
    }

   function formatKSH(amount) {
    // This function now handles different currencies
    const currency = 'KSH'; // Default to KSH for backward compatibility
    return `${currency} ${amount.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

// Add a new function for proper currency formatting
function formatCurrency(amount, currency = 'KSH') {
    if (currency === 'USD') {
        return `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    } else {
        return `KSH ${amount.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
}

    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loading-overlay');
        const text = document.getElementById('loading-text');
        
        if (message) {
            overlay.classList.remove('hidden');
            text.textContent = message;
        } else {
            overlay.classList.add('hidden');
        }
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            warning: 'bg-yellow-500',
            info: 'bg-blue-500'
        };
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast ${colors[type]} text-white rounded-lg shadow-lg p-4`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icons[type]} text-xl mr-3"></i>
                <div class="flex-1">${message}</div>
                <button onclick="document.getElementById('${toastId}').remove()" class="ml-4 text-white opacity-70 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        container.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 5000);
    }

    function updateQuickStats() {
        // Today's transactions
        const today = new Date().toLocaleDateString('en-KE');
        const todayTrans = pettyCashTransactions.filter(t => t.date === today);
        const todayElement = document.getElementById('stats-today-transactions');
        if (todayElement) todayElement.textContent = todayTrans.length;
        
        // Progress bar (capped at 20 transactions)
        const todayProgress = Math.min(100, (todayTrans.length / 20) * 100);
        const progressElement = document.getElementById('stats-today-progress');
        if (progressElement) progressElement.style.width = `${todayProgress}%`;
        
        // Active banks
        const banksElement = document.getElementById('stats-active-banks');
        if (banksElement) banksElement.textContent = banks.length;
        
        // Monthly budget used (simplified)
        const monthlyBudget = 1000000; // Example budget
        const budgetUsed = Math.min(100, (currentMonthSpend.totalExpense / monthlyBudget) * 100);
        const budgetUsedElement = document.getElementById('stats-budget-used');
        if (budgetUsedElement) budgetUsedElement.textContent = `${budgetUsed.toFixed(1)}%`;
        const budgetProgressElement = document.getElementById('stats-budget-progress');
        if (budgetProgressElement) budgetProgressElement.style.width = `${budgetUsed}%`;
    }

    function refreshAllData() {
        showLoading('Refreshing all data...');
        
        // Refresh Firebase data if connected
        if (user) {
            loadFirebaseBanks();
            loadReceiptPayments();
            loadUserData();
        }
        
        // Update all local data
        updateFinancialDashboard();
        updateBankCards();
        updatePettyCashBalanceDisplay();
        updatePettyCashChart();
        updateMajorCategoryChart();
        updateTransferHistory();
        updateQuickStats();
        updateLoanCards();
        
        setTimeout(() => {
            showLoading(false);
            showToast('All data refreshed successfully!', 'success');
        }, 1000);
    }

    function refreshBankData() {
        if (user) {
            loadFirebaseBanks();
            loadReceiptPayments();
            showToast('Bank data refreshed from Firebase', 'success');
        } else {
            showToast('Connect to Firebase to refresh bank data', 'warning');
        }
    }

    function toggleDarkMode() {
        document.body.classList.toggle('bg-gray-900');
        document.body.classList.toggle('text-gray-100');
        
        const isDark = document.body.classList.contains('bg-gray-900');
        const icon = document.querySelector('#firebase-login-btn + button i');
        
        if (isDark) {
            icon.className = 'fas fa-sun';
            document.body.style.backgroundColor = '#1a202c';
        } else {
            icon.className = 'fas fa-moon';
            document.body.style.backgroundColor = '';
        }
        
        // Store preference
        localStorage.setItem('darkMode', isDark);
    }

    // --- Petty Cash Functions ---
    document.addEventListener('DOMContentLoaded', function() {
        // Petty Cash Form
        const pettyCashForm = document.getElementById('petty-cash-form');
        if (pettyCashForm) {
            pettyCashForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const description = document.getElementById('description').value;
                const recipient = document.getElementById('recipient').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const type = document.getElementById('type').value;

                if (cost <= 0) {
                    alert("Cost must be a positive value.");
                    return;
                }

                const now = new Date();
                const newTransaction = {
                    date: now.toLocaleDateString('en-KE'),
                    time: now.toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' }),
                    description: description,
                    recipient: recipient,
                    cost: cost,
                    type: type
                };

                pettyCashTransactions.push(newTransaction);
                renderPettyCash();
                updatePettyCashBalanceDisplay();
                updatePettyCashChart();
                updatePettyExpenditureChart();
                
                // Update M-Pesa balance
                updateMpesaFromPettyCash();
                
                document.getElementById('petty-cash-form').reset();
                checkAnomalies(newTransaction);
                updateQuickStats();
                showToast('Transaction added successfully!', 'success');
                
                // Save to Firestore
                if (user) saveUserData();
            });
        }
        
        // Major Transaction Form
        const majorTransactionForm = document.getElementById('major-transaction-form');
        if (majorTransactionForm) {
            majorTransactionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const description = document.getElementById('major-description').value;
                const cost = parseFloat(document.getElementById('major-cost').value);
                const category = document.getElementById('major-category').value;
                const bankId = document.getElementById('transaction-bank-id').value;

                if (cost <= 0) {
                    showToast("Amount must be a positive value.", 'error');
                    return;
                }
                if (!bankId) {
                    showToast("Please select a bank account for this transaction.", 'error');
                    return;
                }

                const selectedBank = getBankById(bankId);
                const isIncome = category === 'Sales';
                
                if (isIncome) {
                    selectedBank.balance += cost;
                } else {
                    selectedBank.balance -= cost;
                }
                
                majorTransactions.push({
                    description,
                    amount: cost,
                    category,
                    date: new Date().toLocaleDateString('en-KE'),
                    bankId: bankId
                });

                updateBankSelectors();
                updateMajorSummary();
                updateMajorCategoryChart();
                updateFinancialDashboard();
                document.getElementById('major-transaction-form').reset();
                showToast(`Major Transaction Logged: ${description} - ${formatKSH(cost)}`, 'success');
                
                // Save to Firestore
                if (user) saveUserData();
            });
        }
        
        // Loan Form
        const loanForm = document.getElementById('loan-form');
    // Update the loan form submission to handle Firebase bank IDs
if (loanForm) {
    loanForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const institution = document.getElementById('loan-institution').value;
        const balance = parseFloat(document.getElementById('loan-balance').value);
        const bankSelect = document.getElementById('loan-bank-account');
        const selectedOption = bankSelect.options[bankSelect.selectedIndex];
        const bankFirebaseId = selectedOption.getAttribute('data-firebase-id');
        const bankId = bankSelect.value;
        const loanType = document.getElementById('loan-type').value;
        const interestRate = parseFloat(document.getElementById('loan-interest-rate').value) || 0;
        const dueDate = document.getElementById('loan-due-date').value;
        
        if (!bankId) {
            showToast('Please select a bank account for loan disbursement', 'error');
            return;
        }
        
        // Find or create local bank representation
        let selectedBank;
        
        if (bankId === 'mpesa') {
            selectedBank = banks.find(b => b.id === 'mpesa');
        } else {
            // Check if we already have this bank locally
            selectedBank = banks.find(b => b.firebaseId === bankFirebaseId);
            
            // If not, create a local entry for it
            if (!selectedBank) {
                try {
                    // Fetch bank details from Firebase
                    const bankDoc = await firestore.collection('bankDetails').doc(bankFirebaseId).get();
                    if (bankDoc.exists) {
                        const bankData = bankDoc.data();
                        const bankName = bankData.bankName || 
                                       bankData.name || 
                                       bankData.bank || 
                                       bankData.bank_name || 
                                       bankData.bankName || 
                                       'Bank Account';
                        
                        const accountNumber = bankData.accountNumber || 
                                            bankData.account || 
                                            bankData.account_number || 
                                            bankData.accountNumber || 
                                            'N/A';
                        
                        const branch = bankData.branch || 
                                     bankData.branchName || 
                                     bankData.branch_name || 
                                     bankData.branchName || 
                                     '';
                        
                        const initialBalance = bankData.balance || 
                                             bankData.currentBalance || 
                                             bankData.accountBalance || 
                                             bankData.balanceAmount || 
                                             0;
                        
                        selectedBank = {
                            id: 'fb_' + bankFirebaseId,
                            name: bankName,
                            accountNumber: accountNumber,
                            branch: branch,
                            balance: parseFloat(initialBalance) + balance, // Add loan amount
                            firebaseId: bankFirebaseId,
                            firebaseData: bankData,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        banks.push(selectedBank);
                    }
                } catch (error) {
                    console.error("Error fetching bank details:", error);
                    showToast('Error loading bank details from Firebase', 'error');
                    return;
                }
            } else {
                // Update existing bank balance
                selectedBank.balance += balance;
            }
        }
        
        if (!selectedBank) {
            showToast('Selected bank not found', 'error');
            return;
        }
        
        // Add loan amount to selected bank
        if (bankId !== 'mpesa') {
            selectedBank.balance += balance;
        }
        
        const newLoan = {
            id: 'l' + Date.now(),
            institution: institution,
            balance: balance,
            originalBalance: balance,
            bankId: selectedBank.id,
            bankName: selectedBank.name,
            bankFirebaseId: bankFirebaseId,
            type: loanType,
            interestRate: interestRate,
            dueDate: dueDate,
            createdAt: new Date().toISOString(),
            repayments: []
        };
        
        loans.push(newLoan);
        
        // Add loan disbursement as major transaction
        majorTransactions.push({
            description: `Loan disbursement from ${institution}`,
            amount: balance,
            category: 'Sales',
            date: new Date().toLocaleDateString('en-KE'),
            bankId: selectedBank.id,
            isLoanDisbursement: true,
            loanId: newLoan.id
        });
        
        updateFinancialDashboard();
        updateBankCards();
        updateBankSelectors();
        initializeLoanBankSelector();
        updateLoanCards();
        document.getElementById('loan-form').reset();
        
        showToast(`Loan from ${institution} added. ${formatKSH(balance)} deposited to ${selectedBank.name}`, 'success');
        
        // Save to Firestore
        if (user) saveUserData();
    });
}
        
        // Bank Transfer Form
        // Update the bank transfer form submit handler preview section
// Bank Transfer Form
const bankTransferForm = document.getElementById('bank-transfer-form');
if (bankTransferForm) {
    bankTransferForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fromBankId = document.getElementById('transfer-from-bank').value;
        const toBankId = document.getElementById('transfer-to-bank').value;
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        const fee = parseFloat(document.getElementById('transfer-fee-input').value) || 0;
        const feeBearer = document.getElementById('fee-bearer').value;
        const reason = document.getElementById('transfer-reason').value;
        
        if (!fromBankId || !toBankId) {
            showToast('Please select both source and destination banks', 'error');
            return;
        }
        
        if (fromBankId === toBankId) {
            showToast('Cannot transfer to the same bank account', 'error');
            return;
        }
        
        if (!amount || amount <= 0) {
            showToast('Please enter a valid transfer amount', 'error');
            return;
        }
        
        const fromBank = getBankById(fromBankId);
        const toBank = getBankById(toBankId);
        
        // Calculate total debit based on fee bearer
        let fromBankDebit = amount;
        let toBankCredit = amount;
        
        if (feeBearer === 'sending') {
            fromBankDebit += fee;
        } else if (feeBearer === 'receiving') {
            toBankCredit -= fee;
        }
        
        if (fromBank.balance < fromBankDebit) {
            showToast(`Insufficient funds. Available: ${formatKSH(fromBank.balance)}, Required: ${formatKSH(fromBankDebit)}`, 'error');
            return;
        }
        
        // Show preview - FIXED IDs
        document.getElementById('preview-from').textContent = fromBank.name;
        document.getElementById('preview-to').textContent = toBank.name;
        document.getElementById('preview-amount').textContent = formatKSH(amount);
        document.getElementById('preview-fee').textContent = formatKSH(fee);
        document.getElementById('preview-fee-bearer').textContent = feeBearer === 'sending' ? 'Sending Bank' : 'Receiving Bank';
        document.getElementById('preview-total-debit').textContent = formatKSH(fromBankDebit);
        document.getElementById('preview-reason').textContent = reason || 'No reason provided';
        document.getElementById('transfer-preview').classList.remove('hidden');
        
        // Show confirmation modal - FIXED IDs
        document.getElementById('confirm-transfer-from').textContent = fromBank.name;
        document.getElementById('confirm-transfer-to').textContent = toBank.name;
        document.getElementById('confirm-transfer-amount').textContent = formatKSH(amount);
        document.getElementById('confirm-transfer-fee').textContent = formatKSH(fee);
        // Add fee bearer to confirmation modal if it exists
        const confirmFeeBearer = document.getElementById('confirm-transfer-fee-bearer');
        if (confirmFeeBearer) {
            confirmFeeBearer.textContent = feeBearer === 'sending' ? 'Sending Bank' : 'Receiving Bank';
        }
        document.getElementById('confirm-transfer-total').textContent = formatKSH(fromBankDebit);
        document.getElementById('confirm-transfer-reason').textContent = reason || 'No reason provided';
        
        document.getElementById('transfer-confirm-modal').classList.remove('hidden');
    });
}

        // Loan Repayment Form
        const repaymentForm = document.getElementById('loan-repayment-form');
        if (repaymentForm) {
            repaymentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const loan = loans.find(l => l.id === currentRepaymentLoanId);
                if (!loan) {
                    showToast('Loan not found', 'error');
                    return;
                }
                
                const bankId = document.getElementById('repayment-bank-select').value;
                const amount = parseFloat(document.getElementById('repayment-amount').value);
                const date = document.getElementById('repayment-date').value;
                const reference = document.getElementById('repayment-reference').value;
                const notes = document.getElementById('repayment-notes').value;
                
                if (!bankId) {
                    showToast('Please select a bank account', 'error');
                    return;
                }
                
                if (!amount || amount <= 0) {
                    showToast('Please enter a valid repayment amount', 'error');
                    return;
                }
                
                if (amount > loan.balance) {
                    showToast(`Repayment amount cannot exceed loan balance of ${formatKSH(loan.balance)}`, 'error');
                    return;
                }
                
                const bank = getBankById(bankId);
                if (amount > bank.balance) {
                    showToast(`Insufficient funds in ${bank.name}. Available: ${formatKSH(bank.balance)}`, 'error');
                    return;
                }
                
                // Deduct from bank
                bank.balance -= amount;
                
                // Update loan balance
                loan.balance -= amount;
                
                // Record repayment
                const repaymentId = 'r' + Date.now();
                const repaymentRecord = {
                    id: repaymentId,
                    loanId: loan.id,
                    date: new Date(date).toISOString(),
                    amount: amount,
                    bankId: bankId,
                    bankName: bank.name,
                    reference: reference,
                    notes: notes,
                    previousBalance: loan.balance + amount,
                    newBalance: loan.balance
                };
                
                loanRepayments.push(repaymentRecord);
                loan.repayments = loan.repayments || [];
                loan.repayments.push(repaymentRecord);
                
                // Add repayment as major transaction
                majorTransactions.push({
                    description: `Loan repayment to ${loan.institution} - Ref: ${reference}`,
                    amount: amount,
                    category: 'Payroll',
                    date: new Date(date).toLocaleDateString('en-KE'),
                    bankId: bankId,
                    isLoanRepayment: true,
                    loanId: loan.id,
                    repaymentId: repaymentId
                });
                
                // Update UI
                updateFinancialDashboard();
                updateBankCards();
                updateBankSelectors();
                updateLoanCards();
                closeLoanRepaymentModal();
                
                showToast(`Loan repayment of ${formatKSH(amount)} to ${loan.institution} processed successfully!`, 'success');
                
                // If loan is fully paid, show confirmation
                if (loan.balance <= 0) {
                    setTimeout(() => {
                        showToast(`üéâ Congratulations! Loan from ${loan.institution} has been fully paid off!`, 'success');
                    }, 1000);
                }
                
                // Save to Firestore
                if (user) saveUserData();
            });
        }
        
        // EMI Calculator Form
        const emiForm = document.getElementById('emi-calculator-form');
        if (emiForm) {
            emiForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const principal = parseFloat(document.getElementById('principal').value);
                const rateAnnual = parseFloat(document.getElementById('rate').value);
                const months = parseInt(document.getElementById('months').value);
                const resultElement = document.getElementById('emi-result');
                
                if (principal <= 0 || rateAnnual < 0 || months <= 0) {
                    resultElement.textContent = "Please enter positive values.";
                    return;
                }

                const rateMonthly = (rateAnnual / 100) / 12;
                const n = months;
                
                let emi;
                if (rateMonthly === 0) {
                    emi = principal / n;
                } else {
                    const power = Math.pow((1 + rateMonthly), n);
                    emi = principal * (rateMonthly * power) / (power - 1);
                }

                const totalInterest = (emi * n) - principal;

                resultElement.style.color = 'var(--primary-color)';
                resultElement.innerHTML = `
                    <p>Monthly Payment (EMI): <strong>${formatKSH(emi.toFixed(2))}</strong></p>
                    <p>Total Repayment: ${formatKSH((emi * n).toFixed(2))}</p>
                    <p>Total Interest: ${formatKSH(totalInterest.toFixed(2))}</p>
                `;
            });
        }
    });

    function renderPettyCash() {
        const list = document.getElementById('transaction-list');
        if (!list) return;
        
        list.innerHTML = '';
        const sortedTransactions = [...pettyCashTransactions].sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
        const transactionsToShow = sortedTransactions.slice(0, 5);

        if (transactionsToShow.length === 0) {
            list.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-exchange-alt text-3xl mb-3"></i>
                        <p>No transactions yet</p>
                        <p class="text-sm mt-2">Add your first transaction above</p>
                    </td>
                </tr>
            `;
            return;
        }

        transactionsToShow.forEach(tx => {
            const row = list.insertRow();
            row.style.color = tx.type === 'expense' ? '#d9534f' : 'var(--primary-color)';
            
            row.insertCell().textContent = tx.date;
            row.insertCell().textContent = tx.description;
            row.insertCell().textContent = tx.recipient;
            row.insertCell().textContent = tx.type.charAt(0).toUpperCase() + tx.type.slice(1);
            row.insertCell().textContent = formatKSH(tx.cost);
        });
        updatePettyCashBalanceDisplay();
    }

    function calculatePettyCashBalance() {
        let totalExpense = 0;
        let totalIncome = 0;
        let currentBalance = 0;
        
        pettyCashTransactions.forEach(t => {
            currentBalance += (t.type === 'income' ? t.cost : -t.cost);
        });
        
        const today = new Date().toLocaleDateString('en-KE');
        const todayTrans = pettyCashTransactions.filter(t => t.date === today);

        todayTrans.forEach(t => {
            if (t.type === 'expense') {
                totalExpense += t.cost;
            } else {
                totalIncome += t.cost;
            }
        });
        
        return { currentBalance, totalExpense, totalIncome };
    }

    function updatePettyCashBalanceDisplay() {
        const { currentBalance, totalExpense, totalIncome } = calculatePettyCashBalance();
        
        const currentBalanceElement = document.getElementById('current-balance');
        const dayExpenseElement = document.getElementById('day-expense');
        const dayIncomeElement = document.getElementById('day-income');
        
        if (currentBalanceElement) {
            if (balancesHidden) {
                currentBalanceElement.textContent = '********';
                currentBalanceElement.classList.add('hidden-balance');
            } else {
                currentBalanceElement.textContent = formatKSH(currentBalance);
                currentBalanceElement.classList.remove('hidden-balance');
                currentBalanceElement.style.color = currentBalance < 0 ? '#dc3545' : 'var(--primary-color)';
            }
        }
        
        if (dayExpenseElement) {
            if (balancesHidden) {
                dayExpenseElement.textContent = 'KSH *****';
                dayExpenseElement.classList.add('hidden-balance');
            } else {
                dayExpenseElement.textContent = formatKSH(totalExpense);
                dayExpenseElement.classList.remove('hidden-balance');
            }
        }
        
        if (dayIncomeElement) {
            if (balancesHidden) {
                dayIncomeElement.textContent = 'KSH *****';
                dayIncomeElement.classList.add('hidden-balance');
            } else {
                dayIncomeElement.textContent = formatKSH(totalIncome);
                dayIncomeElement.classList.remove('hidden-balance');
            }
        }
    }

    async function endDayAndGenerateReport() {
        const today = new Date().toLocaleDateString('en-KE');
        const todayTrans = pettyCashTransactions.filter(t => t.date === today);
        const { currentBalance, totalExpense, totalIncome } = calculatePettyCashBalance();
        
        if (todayTrans.length === 0) {
            alert("No transactions logged for today to generate a report.");
            return;
        }

        const pdf = new jsPDF('p', 'mm', 'a4');
        const title = `Petty Cash Daily Report - ${today}`;
        const startingBalance = currentBalance + totalExpense - totalIncome;

        pdf.setFontSize(22);
        pdf.setTextColor(38, 121, 33);
        pdf.text(title, 14, 20);
        
        pdf.setFontSize(12);
        pdf.setTextColor(51, 51, 51);
        pdf.text(`Starting Balance (EOD T-1): ${formatKSH(startingBalance)}`, 14, 38);
        pdf.text(`(+) Total Income Today: ${formatKSH(totalIncome)}`, 14, 44);
        pdf.text(`(-) Total Expense Today: ${formatKSH(totalExpense)}`, 14, 50);
        pdf.text(`(=) End of Day Balance: ${formatKSH(currentBalance)}`, 14, 56);
        
        pdf.setFontSize(16);
        pdf.setTextColor(38, 121, 33);
        pdf.text('Detailed Daily Transactions', 14, 68);
        
        let y = 75;
        pdf.setFontSize(9);
        
        pdf.setFillColor(38, 121, 33);
        pdf.setTextColor(255, 255, 255);
        pdf.rect(10, y, 190, 6, 'F');
        pdf.text('Time', 12, y + 4);
        pdf.text('Description', 40, y + 4);
        pdf.text('Recipient', 100, y + 4);
        pdf.text('Type', 135, y + 4);
        pdf.text('Amount (KSH)', 165, y + 4);
        y += 6;

        pdf.setTextColor(51, 51, 51);
        todayTrans.forEach(tx => {
            if (y > 280) { pdf.addPage(); y = 20; pdf.setTextColor(51, 51, 51); }
            const time = tx.time || new Date().toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' });
            const color = tx.type === 'income' ? '#267921' : '#d9534f';
            
            pdf.setTextColor(51, 51, 51);
            pdf.text(time, 12, y + 4);
            pdf.text(tx.description.substring(0, 30) + (tx.description.length > 30 ? '...' : ''), 40, y + 4);
            pdf.text(tx.recipient, 100, y + 4);
            pdf.text(tx.type.toUpperCase(), 135, y + 4);
            pdf.setTextColor(color);
            pdf.text(tx.cost.toLocaleString('en-KE'), 165, y + 4);
            y += 6;
        });

        pdf.save(`CarKenya_Petty_Cash_Daily_Report_${today.replace(/\//g, '-')}.pdf`);
        showToast(`Day closed. Report generated for ${today}.`, 'success');
    }

    // --- Chart Functions ---
    function updatePettyCashChart() {
        let totalExpense = pettyCashTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.cost, 0);
        let totalIncome = pettyCashTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.cost, 0);

        const data = {
            labels: ['Total Expenses', 'Total Income'],
            datasets: [{
                label: 'Petty Cash Flow (KSH)',
                data: [totalExpense, totalIncome],
                backgroundColor: ['#d9534f', 'var(--primary-color)'],
                borderWidth: 1
            }]
        };

        const canvas = document.getElementById('pettyCashChart');
        if (!canvas) return;
        
        if (pettyChartInstance) {
            pettyChartInstance.data = data;
            pettyChartInstance.update();
        } else {
            const ctx = canvas.getContext('2d');
            pettyChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true } } 
                } 
            });
        }
    }
    
    function updatePettyExpenditureChart() {
        // Sample data for demonstration
        const data = { 
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], 
            datasets: [{ 
                label: 'Monthly Expenditure Trend', 
                data: [10000, 15000, 12000, 18000, 14000, 16000], 
                borderColor: '#dc3545', 
                fill: false, 
                tension: 0.3 
            }] 
        };
        
        const canvas = document.getElementById('pettyExpenditureLineChart');
        if (!canvas) return;
        
        if (pettyLineChartInstance) {
            pettyLineChartInstance.data = data;
            pettyLineChartInstance.update();
        } else {
            const ctx = canvas.getContext('2d');
            pettyLineChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: 'top' } }, 
                    scales: { y: { beginAtZero: true } } 
                } 
            });
        }
    }

    // --- Major Financial Reports Logic ---
    function checkAccessCode() {
        const codeInput = document.getElementById('access-code').value;
        if (codeInput === ACCESS_CODE) {
            document.getElementById('access-gate').style.display = 'none';
            document.getElementById('report-input-area').style.display = 'block';
            updateMajorCategoryChart();
            updateFinancialDashboard();
            updateBankSelectors();
            showToast('Access Granted! Welcome to the Major Financial Report Generator.', 'success');
        } else {
            showToast('Access Denied. Invalid Code.', 'error');
            document.getElementById('access-code').value = '';
        }
    }
    
    function updateMajorSummary() {
        const majorSummaryElement = document.getElementById('major-summary');
        if (!majorSummaryElement) return;
        
        if (majorTransactions.length === 0) {
            majorSummaryElement.innerHTML = '<p>No major transactions logged yet.</p>';
            return;
        }
        
        let summaryHTML = '<h4 class="font-semibold mb-2">Major Transactions Summary</h4>';
        const total = majorTransactions.reduce((sum, t) => sum + t.amount, 0);
        summaryHTML += `<p class="mb-4"><strong>Total Major Value Logged:</strong> ${formatKSH(total)}</p>`;
        
        const detailsHTML = `
            <h5 class="font-semibold mb-2">Recent Transactions:</h5>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Date</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Description</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Category</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Amount</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${majorTransactions.slice(-5).reverse().map(t => `
                            <tr>
                                <td class="px-4 py-2 text-sm">${t.date}</td>
                                <td class="px-4 py-2 text-sm">${t.description}</td>
                                <td class="px-4 py-2 text-sm">${t.category}</td>
                                <td class="px-4 py-2 text-sm font-semibold ${t.category === 'Sales' ? 'text-green-600' : 'text-red-600'}">${formatKSH(t.amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        majorSummaryElement.innerHTML = summaryHTML + detailsHTML;
    }

    function updateMajorCategoryChart() {
        const categories = majorTransactions.reduce((acc, t) => {
            acc[t.category] = (acc[t.category] || 0) + t.amount;
            return acc;
        }, {});

        const labels = Object.keys(categories);
        const dataValues = Object.values(categories);
        
        if (labels.length === 0) {
            const canvas = document.getElementById('majorCategoryChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#f0f0f0';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', canvas.width/2, canvas.height/2);
            }
            return;
        }
        
        const data = {
            labels: labels,
            datasets: [{
                label: 'Value by Category (KSH)',
                data: dataValues,
                backgroundColor: ['#267921', '#ffc107', '#0dcaf0', '#dc3545', '#6c757d'],
                hoverOffset: 4
            }]
        };

        const canvas = document.getElementById('majorCategoryChart');
        if (!canvas) return;
        
        if (majorChartInstance) {
            majorChartInstance.data = data;
            majorChartInstance.update();
        } else {
            const ctx = canvas.getContext('2d');
            majorChartInstance = new Chart(ctx, { 
                type: 'doughnut', 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        title: { 
                            display: true, 
                            text: 'Major Transactions Breakdown' 
                        } 
                    } 
                } 
            });
        }
    }
    
    function generateReport() {
        if (majorTransactions.length === 0) {
            const reportOutput = document.getElementById('report-output-area');
            if (reportOutput) {
                reportOutput.innerHTML = '<p style="color: #d9534f;">‚ö†Ô∏è No major transactions logged. Cannot generate report.</p>';
            }
            showToast('No major transactions to generate report', 'warning');
            return;
        }
        updateMajorSummary();
        updateMajorCategoryChart();
        showToast('Financial Report Generated! Ready to print/export.', 'success');
    }

    // --- Financial Dashboard Functions ---
    function updateFinancialDashboard() {
        // 1. Total Bank Funds
        const totalBankFunds = banks.reduce((sum, bank) => sum + bank.balance, 0);
        const totalBankElement = document.getElementById('total-bank-funds');
        if (totalBankElement) {
            if (balancesHidden) {
                totalBankElement.textContent = '*****';
                totalBankElement.classList.add('hidden-balance');
            } else {
                totalBankElement.textContent = formatKSH(totalBankFunds);
                totalBankElement.classList.remove('hidden-balance');
            }
        }
        
        // 2. Total Outstanding Loans
        const totalOutstandingLoans = loans.reduce((sum, loan) => sum + loan.balance, 0);
        const totalLoansElement = document.getElementById('total-outstanding-loans');
        if (totalLoansElement) {
            if (balancesHidden) {
                totalLoansElement.textContent = '*****';
                totalLoansElement.classList.add('hidden-balance');
            } else {
                totalLoansElement.textContent = formatKSH(totalOutstandingLoans);
                totalLoansElement.classList.remove('hidden-balance');
            }
        }
        
        // 3. Monthly Spend
        const now = new Date();
        if (now.getMonth() !== currentMonthSpend.month || now.getFullYear() !== currentMonthSpend.year) {
            currentMonthSpend.month = now.getMonth();
            currentMonthSpend.year = now.getFullYear();
            currentMonthSpend.totalExpense = 0;
        } else {
            currentMonthSpend.totalExpense = majorTransactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    const isExpense = ['Payroll', 'Overheads', 'Assets'].includes(t.category);
                    const isThisMonth = tDate.getMonth() === currentMonthSpend.month && tDate.getFullYear() === currentMonthSpend.year;
                    return isExpense && isThisMonth;
                })
                .reduce((sum, t) => sum + t.amount, 0);
        }
        
        const monthlySpendElement = document.getElementById('monthly-spend');
        if (monthlySpendElement) {
            if (balancesHidden) {
                monthlySpendElement.textContent = '*****';
                monthlySpendElement.classList.add('hidden-balance');
            } else {
                monthlySpendElement.textContent = formatKSH(currentMonthSpend.totalExpense);
                monthlySpendElement.classList.remove('hidden-balance');
            }
        }
    }

    // --- Auditing Logic ---
    function simulateAudit() {
        let auditIssues = [];
        
        const pettyAnomalies = pettyCashTransactions.filter(t => t.type === 'expense' && t.cost > 5000);
        if (pettyAnomalies.length > 0) { 
            auditIssues.push(`[Petty Cash] ${pettyAnomalies.length} high-value expenses (>KSH 5,000) found.`); 
        }

        const pettyBalance = pettyCashTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.cost : -t.cost), 0);
        if (pettyBalance < 0) { 
            auditIssues.push(`[Petty Cash] Negative Balance: ${formatKSH(pettyBalance)}.`); 
        }
        
        banks.filter(b => b.balance < 0).forEach(b => { 
            auditIssues.push(`[Bank Integrity] ${b.name} has a negative balance of ${formatKSH(b.balance)}.`); 
        });
        
        const smallMajorExpenses = majorTransactions.filter(t => ['Payroll', 'Overheads'].includes(t.category) && t.amount < 1000);
        if (smallMajorExpenses.length > 0) { 
            auditIssues.push(`[Major Integrity] ${smallMajorExpenses.length} small expenses logged as Major.`); 
        }

        const statusElement = document.getElementById('audit-status');
        if (statusElement) {
            if (auditIssues.length > 0) {
                statusElement.className = 'bg-red-50 border border-red-200 rounded-lg p-4 mb-6';
                statusElement.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                        <div>
                            <span class="font-medium text-red-800">AUDIT WARNING - ${auditIssues.length} issues found:</span>
                            <ul class="text-sm text-red-700 mt-1 list-disc pl-5">
                                ${auditIssues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                showToast('Audit Complete: WARNING! See Audit Status for details.', 'warning');
            } else {
                statusElement.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mb-6';
                statusElement.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        <span class="font-medium text-green-800">System Health: All Clear. Financial data integrity passed basic audit.</span>
                    </div>
                `;
                showToast('Audit Complete: System passed all checks.', 'success');
            }
        }
    }

    function checkAnomalies(transaction) {
        if (transaction.type === 'expense' && transaction.cost > 5000) {
            const statusElement = document.getElementById('audit-status');
            if (statusElement) {
                statusElement.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6';
                statusElement.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                        <span class="font-medium text-yellow-800">PETTY CASH ALERT: Expense of ${formatKSH(transaction.cost)} logged. Check receipt for "${transaction.description}".</span>
                    </div>
                `;
            }
        }
    }

    // --- PDF Generation ---
    async function exportReportToPdf() {
        if (majorTransactions.length === 0) {
            showToast("Cannot generate PDF. No major transactions logged.", 'warning');
            return;
        }
        
        const pdf = new jsPDF('p', 'mm', 'a4');
        const title = 'CarKenya.Co.Ke Financial Report';

        pdf.setFontSize(22);
        pdf.setTextColor(38, 121, 33);
        pdf.text(title, 14, 20);
        
        pdf.setFontSize(10);
        pdf.setTextColor(51, 51, 51);
        pdf.text(`Date Generated: ${new Date().toLocaleDateString('en-KE')}`, 14, 25);
        pdf.text(`Total Bank Funds: ${formatKSH(banks.reduce((sum, b) => sum + b.balance, 0))}`, 14, 30);
        
        pdf.setFontSize(16);
        pdf.text('Category Breakdown Graph', 14, 40);

        const canvas = await html2canvas(document.getElementById('majorCategoryChart'), { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 10, 45, 180, 100); 

        pdf.setFontSize(16);
        pdf.text('Transaction Details', 14, 155);

        let y = 165;
        pdf.setFontSize(10);
        
        pdf.setFillColor(38, 121, 33);
        pdf.setTextColor(255, 255, 255);
        pdf.rect(10, y, 190, 7, 'F');
        pdf.text('Date', 12, y + 5);
        pdf.text('Description', 40, y + 5);
        pdf.text('Category', 95, y + 5);
        pdf.text('Bank', 130, y + 5);
        pdf.text('Amount (KSH)', 165, y + 5);
        y += 7;

        pdf.setTextColor(51, 51, 51);
        majorTransactions.forEach(tx => {
            if (y > 280) { pdf.addPage(); y = 20; pdf.setTextColor(51, 51, 51); }
            pdf.text(tx.date, 12, y + 5);
            pdf.text(tx.description.substring(0, 30) + (tx.description.length > 30 ? '...' : ''), 40, y + 5);
            pdf.text(tx.category, 95, y + 5);
            pdf.text(getBankById(tx.bankId)?.name || 'N/A', 130, y + 5);
            pdf.text(tx.amount.toLocaleString('en-KE'), 165, y + 5);
            y += 7;
        });

        pdf.save("CarKenya_Financial_Report.pdf");
        showToast('PDF Report exported successfully!', 'success');
    }

    // --- Calculator Logic ---
    function openCalculatorModal(defaultTab) {
        const modal = document.getElementById('calculator-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
        if (defaultTab) {
            const tabButton = document.querySelector(`.calc-tab-button[onclick*='${defaultTab}-calc']`);
            if (tabButton) { 
                switchCalcTab({ currentTarget: tabButton }, `${defaultTab}-calc`); 
            }
        }
    }
    
    function closeCalculatorModal() {
        const modal = document.getElementById('calculator-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }
    
    function switchCalcTab(evt, tabName) {
        document.querySelectorAll(".calc-tab-content").forEach(el => {
            el.classList.remove('active');
            el.style.display = 'none';
        });
        document.querySelectorAll(".calc-tab-button").forEach(el => {
            el.classList.remove('active');
            el.classList.remove('border-primary');
        });
        const tabElement = document.getElementById(tabName);
        if (tabElement) {
            tabElement.classList.add('active');
            tabElement.style.display = 'block';
        }
        if (evt && evt.currentTarget) {
            evt.currentTarget.classList.add('active');
            evt.currentTarget.classList.add('border-primary');
        }
    }
    
    function appendToBasicCalc(value) {
        const display = document.getElementById('calculator-display');
        if (!display) return;
        
        if (display.textContent === '0' && value !== '.') { 
            display.textContent = ''; 
        }
        if (basicCalcCurrentExpression === 'Error') { 
            basicCalcCurrentExpression = ''; 
        }
        
        const lastChar = basicCalcCurrentExpression.slice(-1);
        const isOperator = (char) => ['+', '-', '*', '/'].includes(char);

        if (isOperator(lastChar) && isOperator(value)) {
            basicCalcCurrentExpression = basicCalcCurrentExpression.slice(0, -1) + value;
        } else if (value === '.' && basicCalcCurrentExpression.split(/[\+\-\*\/]/).pop().includes('.')) {
            return;
        } else if (value === '.' && basicCalcCurrentExpression.length === 0) {
            basicCalcCurrentExpression = '0.';
        } else {
            basicCalcCurrentExpression += value;
        }

        let displayValue = basicCalcCurrentExpression.replace(/\*/g, '√ó').replace(/\//g, '√∑').replace(/\-/g, '‚àí');
        display.textContent = displayValue.length > 20 ? '... ' + displayValue.slice(-20) : displayValue;
    }

    function clearBasicCalc() {
        const display = document.getElementById('calculator-display');
        if (display) {
            display.textContent = '0';
        }
        basicCalcCurrentExpression = '';
    }

    function calculateBasicCalc() {
        const display = document.getElementById('calculator-display');
        if (!display) return;
        
        try {
            let result = new Function('return ' + basicCalcCurrentExpression)();
            if (result === Infinity || isNaN(result)) { 
                throw new Error('Invalid calculation'); 
            }
            result = parseFloat(result.toFixed(4)); 
            display.textContent = result.toLocaleString('en-KE');
            basicCalcCurrentExpression = result.toString();
        } catch (error) {
            display.textContent = 'Error';
            basicCalcCurrentExpression = 'Error';
        }
    }

    // --- Bank Selector Functions ---
    function updateBankSelectors() {
        const majorSelect = document.getElementById('transaction-bank-id');
        if (majorSelect) {
            majorSelect.innerHTML = '<option value="" disabled selected>Select Bank</option>';

            if (banks.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No banks available - Add banks in Bank Management tab";
                option.disabled = true;
                majorSelect.appendChild(option);
            } else {
                banks.forEach(bank => {
                    const option = document.createElement('option');
                    option.value = bank.id;
                    if (bank.id === 'mpesa') {
                        option.textContent = `${bank.name} (Petty Cash) - ${formatKSH(bank.balance)}`;
                    } else {
                        option.textContent = `${bank.name} - ${formatKSH(bank.balance)}`;
                    }
                    majorSelect.appendChild(option);
                });
            }
        }
        
        // Also update transfer selectors
        updateTransferBankSelectors();
    }

    // --- Initialize the application ---
    window.onload = async () => {
        // Check for dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            toggleDarkMode();
        }
        
        // Initialize Firebase
        initializeFirebase();
        
        // Initialize the default tab (Petty Cash)
        openTab({ currentTarget: document.querySelector('.custom-tab.active') }, 'petty-cash');
        
        // Initialize M-Pesa bank
        ensureMpesaBank();
        
        // Initialize other components
        renderPettyCash();
        updatePettyCashBalanceDisplay();
        updatePettyCashChart();
        updatePettyExpenditureChart();
        updateBankSelectors();
        updateTransferBankSelectors();
        updateMajorSummary();
        updateFinancialDashboard();
        updateBankCards();
        updateTransferHistory();
        updateQuickStats();
        initializeLoanBankSelector();
        updateLoanCards();
        
        // Initialize calculator tab
        const calcTabButton = document.querySelector('#calculator-tabs .calc-tab-button.active');
        if (calcTabButton) {
            switchCalcTab({ currentTarget: calcTabButton }, 'basic-calc');
        }
        
        // Update Firebase UI
        updateFirebaseUI();
    };
</script>
</body>
</html>
