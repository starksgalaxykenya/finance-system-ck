<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarKenya Financial Manager - Integrated & Enhanced</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#267921',
                        'primary-dark': '#1f641b',
                        secondary: '#f0f0f0',
                        'secondary-dark': '#1c272a',
                        accent: '#0dcaf0',
                        danger: '#dc3545',
                        warning: '#ffc107',
                        success: '#28a745'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'Segoe UI', 'system-ui', '-apple-system', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 8px 30px rgba(0, 0, 0, 0.12)',
                        'floating': '0 10px 40px rgba(0, 0, 0, 0.15)'
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem'
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom styles to complement Tailwind */
        :root {
            --primary-color: #267921;
            --secondary-color: #f0f0f0;
            --text-color: #333;
            --light-bg: #fff;
            --dark-bg: #1c272a;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Smooth transitions */
        .transition-all {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Modal backdrop blur */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        /* Bank card gradient effects */
        .bank-card-gradient {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .bank-card-gradient:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        /* Shimmer loading effect */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Pulse animation for notifications */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Custom tab styling */
        .custom-tab {
            position: relative;
            overflow: hidden;
        }

        .custom-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .custom-tab.active::after {
            transform: translateX(0);
        }

        /* Confirmation step indicator */
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #e9ecef;
            color: #6c757d;
        }

        .step-indicator.active {
            background: var(--primary-color);
            color: white;
        }

        .step-indicator.completed {
            background: #28a745;
            color: white;
        }

        /* Bank transfer animation */
        @keyframes transferPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .transfer-animation {
            animation: transferPulse 0.5s ease-in-out;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            max-width: 350px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p class="text-lg font-semibold text-gray-700" id="loading-text">Loading...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîê Firebase Login</h2>
                <p class="text-gray-600 mb-6 text-center">Connect to Firebase to sync bank data and receipts</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="login-email" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                               placeholder="your@email.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button onclick="firebaseLogin()" 
                            class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login to Firebase
                    </button>
                    
                    <div class="text-center mt-4">
                        <button onclick="toggleFirebaseLogin()" 
                                class="text-sm text-gray-500 hover:text-gray-700">
                            Skip for now (Use Local Data)
                        </button>
                    </div>
                </div>
                
                <div id="firebase-status" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="firebase-status-text"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="bg-gradient-to-r from-primary to-primary-dark text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-car mr-3"></i>CarKenya.Co.Ke üöò Financial Dashboard
                    </h1>
                    <p class="text-primary-light mt-2">Petty Cash Manager & Financial Report Generator</p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="firebase-user-info" class="hidden bg-white bg-opacity-20 px-4 py-2 rounded-lg">
                        <i class="fas fa-user-circle mr-2"></i>
                        <span id="user-email" class="font-medium"></span>
                    </div>
                    
                    <button id="firebase-login-btn" onclick="toggleFirebaseLogin()"
                            class="bg-white text-primary hover:bg-gray-100 font-semibold py-2 px-4 rounded-lg transition-all flex items-center">
                        <i class="fas fa-cloud mr-2"></i>Connect Firebase
                    </button>
                    
                    <button onclick="toggleDarkMode()"
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-lg transition-all">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Main Content Area -->
            <div class="lg:w-2/3">
                <!-- Tabs Navigation -->
                <div class="bg-white rounded-2xl shadow-card overflow-hidden mb-8">
                    <div class="flex border-b border-gray-200">
                        <button class="custom-tab flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-primary transition-all active"
                                onclick="openTab(event, 'petty-cash')">
                            <i class="fas fa-wallet mr-2"></i>üí∞ Petty Cash Manager
                        </button>
                        <button class="custom-tab flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-primary transition-all"
                                onclick="openTab(event, 'financial-reports')">
                            <i class="fas fa-chart-line mr-2"></i>üìà Financial Reports
                        </button>
                        <button class="custom-tab flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-primary transition-all"
                                onclick="openTab(event, 'bank-management')">
                            <i class="fas fa-university mr-2"></i>üè¶ Bank Management
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="p-6">
                        <!-- Petty Cash Tab -->
                        <div id="petty-cash" class="tab-content active">
                            <!-- Balance Bar -->
                            <div id="petty-cash-balance-bar" class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-100 rounded-xl p-6 mb-8">
                                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                                    <div class="flex flex-wrap gap-8">
                                        <div class="text-center">
                                            <div id="current-balance" class="text-3xl font-bold text-primary mb-2">KSH 0</div>
                                            <div class="text-sm text-gray-600">Current Petty Cash Balance</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="day-expense" class="text-3xl font-bold text-red-500 mb-2">KSH 0</div>
                                            <div class="text-sm text-gray-600">Today's Total Expense</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="day-income" class="text-3xl font-bold text-green-500 mb-2">KSH 0</div>
                                            <div class="text-sm text-gray-600">Today's Total Income</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <button onclick="togglePettyCashBalance()"
                                                class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all flex items-center justify-center">
                                            <i class="fas fa-eye-slash mr-2"></i>Hide Balances
                                        </button>
                                        <button onclick="endDayAndGenerateReport()"
                                                class="bg-accent hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                                            <i class="fas fa-calendar-day mr-2"></i>End Day & Report
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Transaction Form -->
                            <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-exchange-alt mr-3"></i>Petty Cash Transactions
                                </h2>
                                
                                <form id="petty-cash-form">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-align-left mr-2"></i>Transaction Description
                                            </label>
                                            <input type="text" id="description" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                                   placeholder="e.g., Fuel for delivery car" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-user mr-2"></i>Recipient/Vendor
                                            </label>
                                            <input type="text" id="recipient" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                                   placeholder="e.g., John Doe" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-money-bill-wave mr-2"></i>Cost (KSH)
                                            </label>
                                            <input type="number" id="cost" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                                   placeholder="1500" required min="0" step="0.01">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-tag mr-2"></i>Type
                                            </label>
                                            <select id="type" 
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all appearance-none bg-white">
                                                <option value="expense">Expense</option>
                                                <option value="income">Income</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button type="submit"
                                            class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center">
                                        <i class="fas fa-plus-circle mr-2"></i>‚ûï Add Transaction
                                    </button>
                                </form>
                            </div>

                            <!-- Charts Section -->
                            <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-chart-bar mr-3"></i>üìä Petty Cash Flow Analysis
                                </h3>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Summary (Income vs. Expense)</h4>
                                        <div class="chart-container">
                                            <canvas id="pettyCashChart"></canvas>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Daily & Monthly Expenditure Trend</h4>
                                        <div class="chart-container">
                                            <canvas id="pettyExpenditureLineChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Transactions -->
                            <div class="bg-white rounded-xl shadow-card p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-history mr-3"></i>üìú Recent Transactions (Last 5)
                                </h3>
                                
                                <div class="overflow-x-auto rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-primary text-white">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Description</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Recipient</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Type</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Cost (KSH)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                                            <!-- Transactions will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Reports Tab -->
                        <div id="financial-reports" class="tab-content hidden">
                            <!-- Access Gate -->
                            <div id="access-gate" class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-8 mb-8">
                                <div class="text-center">
                                    <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Access Restricted üîí</h3>
                                    <p class="text-gray-600 mb-6">Please enter the security access code to manage major financial transactions and generate reports.</p>
                                    
                                    <div class="max-w-md mx-auto">
                                        <input type="text" id="access-code" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:ring-2 focus:ring-primary focus:border-transparent mb-4"
                                               placeholder="Enter Access Code">
                                        <button onclick="checkAccessCode()"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center mx-auto">
                                            <i class="fas fa-key mr-2"></i>üîë Unlock Reports
                                        </button>
                                    </div>
                                    
                                    <p class="mt-6 text-sm text-gray-500">
                                        <i class="fas fa-lightbulb mr-2"></i>Hint: The code is <span class="font-mono font-bold">2679</span>
                                    </p>
                                </div>
                            </div>

                            <!-- Report Input Area -->
                            <div id="report-input-area" class="hidden">
                                <!-- Financial Summary Dashboard -->
                                <div class="bg-gradient-to-r from-primary to-primary-dark text-white rounded-2xl shadow-card p-6 mb-8">
                                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                                        <i class="fas fa-chart-pie mr-3"></i>üí∞ Overall Financial Summary
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 text-center">
                                            <div id="total-bank-funds" class="text-4xl font-bold mb-2">KSH 0</div>
                                            <div class="text-sm opacity-90">Total Bank Funds (All Accounts)</div>
                                        </div>
                                        
                                        <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 text-center">
                                            <div id="total-outstanding-loans" class="text-4xl font-bold mb-2">KSH 0</div>
                                            <div class="text-sm opacity-90">Total Outstanding Loans</div>
                                        </div>
                                        
                                        <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 text-center">
                                            <div id="monthly-spend" class="text-4xl font-bold mb-2">KSH 0</div>
                                            <div class="text-sm opacity-90">Current Monthly Expense Spend</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Major Transaction Form -->
                                <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                        <i class="fas fa-exchange-alt mr-3"></i>Major Transaction Input
                                    </h3>
                                    
                                    <form id="major-transaction-form">
                                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                            <div class="md:col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                                <input type="text" id="major-description" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="e.g., Vehicle Import Duty" required>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (KSH)</label>
                                                <input type="number" id="major-cost" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="500000" required min="0">
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                                <select id="major-category" 
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                    <option value="Sales">Sales (Income)</option>
                                                    <option value="Payroll">Payroll (Expense)</option>
                                                    <option value="Assets">Assets (Investment)</option>
                                                    <option value="Overheads">Overheads (Expense)</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Tied Bank Account</label>
                                                <select id="transaction-bank-id" 
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                    <option value="" disabled selected>Select Bank</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button type="submit"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                                            <i class="fas fa-save mr-2"></i>üíæ Log Major Transaction
                                        </button>
                                    </form>
                                </div>

                                <!-- Loan Management -->
                                <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                        <i class="fas fa-hand-holding-usd mr-3"></i>üìà Loan Management
                                    </h3>
                                    
                                    <form id="loan-form">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                            <div class="md:col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Institution</label>
                                                <input type="text" id="loan-institution" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="e.g., Equity Bank" required>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Outstanding Balance (KSH)</label>
                                                <input type="number" id="loan-balance" 
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                       placeholder="500000" required min="1">
                                            </div>
                                        </div>
                                        
                                        <button type="submit"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                                            <i class="fas fa-plus-circle mr-2"></i>‚ûï Add New Loan
                                        </button>
                                    </form>
                                </div>

                                <!-- Report Generation -->
                                <div class="bg-white rounded-xl shadow-card p-6">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                        <i class="fas fa-file-alt mr-3"></i>Report Generation & Auditing
                                    </h3>
                                    
                                    <div class="flex flex-wrap gap-4 mb-8">
                                        <button onclick="generateReport()"
                                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center">
                                            <i class="fas fa-newspaper mr-2"></i>üì∞ Major Transactions Report
                                        </button>
                                        
                                        <button onclick="simulateAudit()"
                                                class="bg-warning hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center">
                                            <i class="fas fa-search mr-2"></i>üîç Run Audit
                                        </button>
                                        
                                        <button onclick="exportReportToPdf()"
                                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center">
                                            <i class="fas fa-print mr-2"></i>üñ®Ô∏è Print/PDF Report
                                        </button>
                                    </div>
                                    
                                    <div id="report-output-area">
                                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Generated Report Summary</h4>
                                        <div class="chart-container mb-6">
                                            <canvas id="majorCategoryChart"></canvas>
                                        </div>
                                        <p id="major-summary" class="text-gray-600">No major transactions logged yet.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Management Tab -->
                        <div id="bank-management" class="tab-content hidden">
                            <!-- Sync Status -->
                            <div id="firebase-sync-status" class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8 hidden">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-cloud text-2xl text-blue-500 mr-4"></i>
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Firebase Sync Active</h4>
                                            <p class="text-sm text-gray-600" id="sync-status-text">Syncing bank data...</p>
                                        </div>
                                    </div>
                                    <button onclick="refreshBankData()"
                                            class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center">
                                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                                    </button>
                                </div>
                            </div>

                            <!-- Bank Transfer Form -->
                            <div class="bg-white rounded-xl shadow-card p-6 mb-8">
                                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-money-check-alt mr-3"></i>üí∏ Inter-Bank Transfer
                                </h3>
                                
                                <form id="bank-transfer-form">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">From Bank</label>
                                            <select id="transfer-from-bank" 
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                <option value="" disabled selected>Select Source Bank</option>
                                            </select>
                                            <div id="from-bank-balance" class="text-sm text-gray-500 mt-2"></div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">To Bank</label>
                                            <select id="transfer-to-bank" 
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                <option value="" disabled selected>Select Destination Bank</option>
                                            </select>
                                            <div id="to-bank-balance" class="text-sm text-gray-500 mt-2"></div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Transfer Amount (KSH)</label>
                                            <input type="number" id="transfer-amount" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                   placeholder="100000" min="0.01" step="0.01" required>
                                            <div class="text-sm text-gray-500 mt-2" id="transfer-fee">Transfer Fee: KSH 0</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Transfer Reason</label>
                                        <textarea id="transfer-reason" 
                                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                  rows="2" placeholder="e.g., Working capital transfer between accounts"></textarea>
                                    </div>
                                    
                                    <button type="submit"
                                            class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                                        <i class="fas fa-paper-plane mr-2"></i>Initiate Transfer
                                    </button>
                                </form>
                                
                                <div id="transfer-preview" class="mt-6 hidden">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-2">Transfer Preview</h4>
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="text-gray-600">From:</span>
                                                <span id="preview-from" class="font-medium"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">To:</span>
                                                <span id="preview-to" class="font-medium"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Amount:</span>
                                                <span id="preview-amount" class="font-medium text-green-600"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Fee:</span>
                                                <span id="preview-fee" class="font-medium text-red-600"></span>
                                            </div>
                                            <div class="col-span-2">
                                                <span class="text-gray-600">Reason:</span>
                                                <span id="preview-reason" class="font-medium"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bank Cards Grid -->
                            <div class="mb-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                                        <i class="fas fa-credit-card mr-3"></i>üè¶ Bank Accounts
                                    </h3>
                                    <button onclick="openAddBankModal()"
                                            class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Bank Account
                                    </button>
                                </div>
                                
                                <!-- Loading Skeleton -->
                                <div id="bank-cards-loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div class="bg-gray-100 rounded-xl p-6 shimmer h-40"></div>
                                    <div class="bg-gray-100 rounded-xl p-6 shimmer h-40"></div>
                                    <div class="bg-gray-100 rounded-xl p-6 shimmer h-40"></div>
                                </div>
                                
                                <!-- Bank Cards Container -->
                                <div id="bank-details-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Bank cards will be dynamically inserted here -->
                                </div>
                                
                                <div id="no-banks-message" class="text-center py-12">
                                    <i class="fas fa-university text-4xl text-gray-300 mb-4"></i>
                                    <h4 class="text-xl font-semibold text-gray-600 mb-2">No Bank Accounts</h4>
                                    <p class="text-gray-500 mb-6">Add bank accounts to start managing your finances</p>
                                    <button onclick="openAddBankModal()"
                                            class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-lg transition-all">
                                        Add Your First Bank
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Transfers -->
                            <div class="bg-white rounded-xl shadow-card p-6">
                                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-history mr-3"></i>Recent Transfers
                                </h3>
                                
                                <div class="overflow-x-auto rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">From</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">To</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Amount</th>
                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transfer-history" class="bg-white divide-y divide-gray-200">
                                            <!-- Transfer history will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:w-1/3">
                <!-- Audit Card -->
                <div id="audit-card" class="bg-white rounded-2xl shadow-card p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-shield-alt mr-3"></i>‚ú® Extra Features & Auditing
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-gray-800">Real-Time Auditing (Client-side)</h4>
                                <ul class="text-sm text-gray-600 mt-1 space-y-1">
                                    <li><strong>Anomaly Detection:</strong> Flags petty cash transactions over KSH 5,000</li>
                                    <li><strong>Balance Integrity:</strong> Alerts on negative bank/petty cash balance</li>
                                    <li><strong>Major Integrity:</strong> Checks for small transactions logged as Major</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-heartbeat mr-2"></i>Current Audit Status
                    </h3>
                    <div id="audit-status" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-3"></i>
                            <span class="font-medium text-green-800">System Health: All Clear.</span>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-link mr-2"></i>CarKenya Quick Links
                    </h3>
                    <div class="space-y-3">
                        <a href="#" class="flex items-center text-primary hover:text-primary-dark transition-all">
                            <i class="fas fa-file-invoice-dollar mr-3"></i>
                            <span>View Invoices</span>
                        </a>
                        <a href="#" class="flex items-center text-primary hover:text-primary-dark transition-all">
                            <i class="fas fa-chart-pie mr-3"></i>
                            <span>Setup Budget</span>
                        </a>
                        <a href="#" class="flex items-center text-primary hover:text-primary-dark transition-all">
                            <i class="fas fa-receipt mr-3"></i>
                            <span>Staff Expense Claims</span>
                        </a>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="bg-gradient-to-br from-primary to-primary-dark text-white rounded-2xl shadow-card p-6">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <i class="fas fa-bolt mr-3"></i>Quick Stats
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm opacity-90">Total Transactions Today</span>
                                <span class="font-bold" id="stats-today-transactions">0</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                                <div id="stats-today-progress" class="bg-white h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm opacity-90">Active Bank Accounts</span>
                                <span class="font-bold" id="stats-active-banks">0</span>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm opacity-90">Monthly Budget Used</span>
                                <span class="font-bold" id="stats-budget-used">0%</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                                <div id="stats-budget-progress" class="bg-accent h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="refreshAllData()"
                            class="w-full mt-6 bg-white text-primary hover:bg-gray-100 font-semibold py-3 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Calculator Button -->
    <button class="floating-btn fixed bottom-8 right-8 w-16 h-16 bg-primary hover:bg-primary-dark text-white rounded-full shadow-floating transition-all transform hover:scale-110 active:scale-95 flex items-center justify-center z-40"
            onclick="openCalculatorModal('basic')">
        <i class="fas fa-calculator text-2xl"></i>
    </button>

    <!-- Calculator Modal -->
    <div id="calculator-modal" class="modal hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-calculator mr-3"></i>Financial Calculator
                    </h2>
                    <button onclick="document.getElementById('calculator-modal').style.display='none'"
                            class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="calculator-tabs" class="flex mb-6 border-b border-gray-200">
                    <button class="calc-tab-button flex-1 py-3 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-primary transition-all active"
                            onclick="switchCalcTab(event, 'basic-calc')">
                        <i class="fas fa-calculator mr-2"></i>Basic Calculator
                    </button>
                    <button class="calc-tab-button flex-1 py-3 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-primary transition-all"
                            onclick="switchCalcTab(event, 'financial-calc')">
                        <i class="fas fa-chart-line mr-2"></i>Financial (EMI)
                    </button>
                </div>
                
                <div id="basic-calc" class="calc-tab-content active">
                    <div id="calculator-display" class="bg-gray-800 text-white text-3xl font-mono p-4 rounded-lg mb-4 text-right overflow-x-auto">0</div>
                    
                    <div id="calculator-buttons" class="grid grid-cols-4 gap-2">
                        <button class="clear-btn bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition-all" onclick="clearBasicCalc()">C</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('/')">√∑</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('*')">√ó</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('-')">‚àí</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('7')">7</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('8')">8</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('9')">9</button>
                        <button class="operator bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('+')">+</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('4')">4</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('5')">5</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('6')">6</button>
                        <button class="equals bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-lg transition-all col-start-4 col-end-5 row-start-3 row-end-5" onclick="calculateBasicCalc()">=</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('1')">1</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('2')">2</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('3')">3</button>
                        
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all col-span-2" onclick="appendToBasicCalc('0')">0</button>
                        <button class="number-btn bg-gray-100 hover:bg-gray-200 font-bold py-4 rounded-lg transition-all" onclick="appendToBasicCalc('.')">.</button>
                    </div>
                </div>
                
                <div id="financial-calc" class="calc-tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Loan Payment (EMI) Calculator</h3>
                    
                    <form id="emi-calculator-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loan Principal (KSH)</label>
                            <input type="number" id="principal" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   value="1000000" required min="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Annual Interest Rate (%)</label>
                            <input type="number" id="rate" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   value="10" step="0.01" required min="0">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loan Term (Months)</label>
                            <input type="number" id="months" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   value="36" required min="1">
                        </div>
                        
                        <button type="submit"
                                class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center">
                            <i class="fas fa-calculator mr-2"></i>Calculate EMI
                        </button>
                    </form>
                    
                    <div class="mt-6 p-4 bg-green-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">Result</h4>
                        <p id="emi-result" class="text-primary font-bold">Enter values and click Calculate.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bank Modal -->
    <div id="add-bank-modal" class="modal hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-university mr-3"></i>Add Bank Account
                    </h2>
                    <button onclick="closeAddBankModal()"
                            class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Step Indicator -->
                <div class="flex justify-between items-center mb-8">
                    <div class="flex flex-col items-center">
                        <div id="step-1-indicator" class="step-indicator active">1</div>
                        <span class="text-xs mt-2 font-medium">Select Bank</span>
                    </div>
                    <div class="h-1 w-12 bg-gray-200"></div>
                    <div class="flex flex-col items-center">
                        <div id="step-2-indicator" class="step-indicator">2</div>
                        <span class="text-xs mt-2 font-medium">Set Balance</span>
                    </div>
                    <div class="h-1 w-12 bg-gray-200"></div>
                    <div class="flex flex-col items-center">
                        <div id="step-3-indicator" class="step-indicator">3</div>
                        <span class="text-xs mt-2 font-medium">Confirm</span>
                    </div>
                </div>
                
                <!-- Step 1: Select Bank -->
                <div id="step-1" class="bank-step active">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Bank from Firebase</h3>
                    <p class="text-gray-600 mb-6">Choose a bank from your existing bank details in Firebase</p>
                    
                    <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Banks from Firebase will be loaded here -->
                        <div id="firebase-banks-list" class="space-y-3">
                            <!-- Bank options will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="closeAddBankModal()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium">
                            Cancel
                        </button>
                        <button onclick="nextBankStep()"
                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-lg transition-all">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Set Initial Balance -->
                <div id="step-2" class="bank-step hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Set Initial Balance</h3>
                    <p class="text-gray-600 mb-6">Enter the current balance for <span id="selected-bank-name" class="font-semibold"></span></p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Initial Balance (KSH)</label>
                        <input type="number" id="bank-initial-balance" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg text-2xl text-center focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="0.00" min="0" step="0.01" required>
                        <p class="text-sm text-gray-500 mt-2">This will be the starting balance for your local tracking</p>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevBankStep()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button onclick="nextBankStep()"
                                class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-lg transition-all">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Confirmation -->
                <div id="step-3" class="bank-step hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Details</h3>
                    
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-600 text-sm">Bank Name:</span>
                                <p id="confirm-bank-name" class="font-semibold"></p>
                            </div>
                            <div>
                                <span class="text-gray-600 text-sm">Initial Balance:</span>
                                <p id="confirm-bank-balance" class="font-semibold text-green-600"></p>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-600 text-sm">Source:</span>
                                <p class="font-semibold flex items-center">
                                    <i class="fas fa-fire mr-2 text-orange-500"></i>Firebase Sync
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-start mb-6">
                        <input type="checkbox" id="confirm-terms" class="mt-1 mr-3">
                        <label for="confirm-terms" class="text-sm text-gray-600">
                            I confirm that this balance is accurate and I've verified it against my bank statement
                        </label>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevBankStep()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button onclick="submitNewBank()"
                                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all flex items-center">
                            <i class="fas fa-check-circle mr-2"></i> Add Bank Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Confirmation Modal -->
    <div id="transfer-confirm-modal" class="modal hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6">
                <div class="text-center mb-6">
                    <i class="fas fa-paper-plane text-5xl text-primary mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Confirm Transfer</h3>
                    <p class="text-gray-600">Please confirm the bank transfer details</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">From:</span>
                            <span id="confirm-transfer-from" class="font-semibold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">To:</span>
                            <span id="confirm-transfer-to" class="font-semibold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Amount:</span>
                            <span id="confirm-transfer-amount" class="font-semibold text-green-600"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Fee:</span>
                            <span id="confirm-transfer-fee" class="font-semibold text-red-600"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Debit:</span>
                            <span id="confirm-transfer-total" class="font-bold"></span>
                        </div>
                        <hr class="my-2">
                        <div>
                            <span class="text-gray-600">Reason:</span>
                            <p id="confirm-transfer-reason" class="font-medium mt-1"></p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Security PIN</label>
                        <input type="password" id="transfer-pin" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-xl tracking-widest focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="0000" maxlength="4" required>
                        <p class="text-xs text-gray-500 mt-2">Enter your 4-digit security PIN to confirm</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="closeTransferConfirm()"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg transition-all">
                            Cancel
                        </button>
                        <button onclick="executeBankTransfer()"
                                class="flex-1 bg-primary hover:bg-primary-dark text-white font-semibold py-3 rounded-lg transition-all">
                            Confirm Transfer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Initialization Script -->
   
<!-- Firebase Initialization Script -->
<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCuUKCxYx0jYKqWOQaN82K5zFGlQsKQsK0",
        authDomain: "ck-manager-1abdc.firebaseapp.com",
        projectId: "ck-manager-1abdc",
        storageBucket: "ck-manager-1abdc.firebasestorage.app",
        messagingSenderId: "890017473158",
        appId: "1:890017473158:web:528e1eebc4b67bd54ca707",
        measurementId: "G-7Z71W1NSX4"
    };

    // Initialize Firebase
    let firebaseApp;
    let firestore;
    let auth;
    let firebaseInitialized = false;
    let user = null;

    function initializeFirebase() {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firestore = firebase.firestore();
            auth = firebase.auth();
            firebaseInitialized = true;
            
            // Set up auth state listener
            auth.onAuthStateChanged((firebaseUser) => {
                user = firebaseUser;
                updateFirebaseUI();
                
                if (user) {
                    showToast('Connected to Firebase successfully!', 'success');
                    loadFirebaseBanks();
                    loadReceiptPayments();
                }
            });
            
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showToast('Firebase initialization failed. Using local data only.', 'error');
        }
    }

    // Call initialization
    initializeFirebase();
</script>

<!-- Main Application Script -->
<script>
    // --- Original Functions from Your Code ---

    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        const auditCard = document.getElementById('audit-card');

        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }

        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.className += " active";
    }

    // --- Core Application Data ---
    const { jsPDF } = window.jspdf;
    let pettyCashTransactions = [];
    let majorTransactions = [];
    let banks = [];
    let loans = [];
    let bankTransfers = [];
    const ACCESS_CODE = "2679";
    let pettyChartInstance = null;
    let majorChartInstance = null;
    let pettyLineChartInstance = null;
    let basicCalcCurrentExpression = '';
    let currentMonthSpend = {
        month: new Date().getMonth(),
        year: new Date().getFullYear(),
        totalExpense: 0
    };

    // Add Bank Modal State
    let addBankStep = 1;
    let selectedFirebaseBank = null;

    // --- Firebase Functions ---

    function toggleFirebaseLogin() {
        const modal = document.getElementById('login-modal');
        modal.classList.toggle('hidden');
    }

    async function firebaseLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            showToast('Please enter email and password', 'error');
            return;
        }
        
        showLoading('Connecting to Firebase...');
        
        try {
            await auth.signInWithEmailAndPassword(email, password);
            showLoading(false);
            document.getElementById('login-modal').classList.add('hidden');
            showToast('Login successful! Syncing bank data...', 'success');
        } catch (error) {
            showLoading(false);
            console.error("Login error:", error);
            showToast(`Login failed: ${error.message}`, 'error');
        }
    }

    function updateFirebaseUI() {
        const loginBtn = document.getElementById('firebase-login-btn');
        const userInfo = document.getElementById('firebase-user-info');
        const userEmail = document.getElementById('user-email');
        const syncStatus = document.getElementById('firebase-sync-status');
        
        if (user) {
            loginBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Connected';
            loginBtn.classList.remove('bg-white', 'text-primary');
            loginBtn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
            
            userInfo.classList.remove('hidden');
            userEmail.textContent = user.email;
            
            syncStatus.classList.remove('hidden');
            document.getElementById('sync-status-text').textContent = `Connected as ${user.email}`;
        } else {
            loginBtn.innerHTML = '<i class="fas fa-cloud mr-2"></i>Connect Firebase';
            loginBtn.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
            loginBtn.classList.add('bg-white', 'text-primary');
            
            userInfo.classList.add('hidden');
            syncStatus.classList.add('hidden');
        }
    }

    async function loadFirebaseBanks() {
        if (!user) return;
        
        showLoading('Loading bank data from Firebase...');
        
        try {
            const banksSnapshot = await firestore.collection('bankDetails').get();
            const banksListDiv = document.getElementById('firebase-banks-list');
            banksListDiv.innerHTML = '';
            
            if (banksSnapshot.empty) {
                banksListDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-university text-3xl mb-3"></i>
                        <p>No banks found in Firebase</p>
                        <p class="text-sm mt-2">Add banks in your other system first</p>
                    </div>
                `;
                showLoading(false);
                return;
            }
            
            banksSnapshot.forEach(doc => {
                const bankData = doc.data();
                const bankId = doc.id;
                
                // Check if bank already exists locally
                const existingBank = banks.find(b => b.firebaseId === bankId);
                
                const bankOption = document.createElement('div');
                bankOption.className = `p-4 border rounded-lg cursor-pointer transition-all hover:bg-gray-50 ${existingBank ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`;
                bankOption.onclick = () => selectFirebaseBank(bankId, bankData);
                bankOption.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-gray-800">${bankData.bankName || 'Unnamed Bank'}</h4>
                            <p class="text-sm text-gray-600">${bankData.accountNumber || 'No account number'}</p>
                            <p class="text-xs text-gray-500 mt-1">${existingBank ? '‚úì Already added' : 'Click to add'}</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                `;
                
                banksListDiv.appendChild(bankOption);
            });
            
            showLoading(false);
        } catch (error) {
            console.error("Error loading banks:", error);
            showLoading(false);
            showToast('Error loading banks from Firebase', 'error');
        }
    }

    async function loadReceiptPayments() {
        if (!user) return;
        
        try {
            const paymentsSnapshot = await firestore.collection('receipt_payments').get();
            const receipts = [];
            
            paymentsSnapshot.forEach(doc => {
                receipts.push({ id: doc.id, ...doc.data() });
            });
            
            // Update bank balances from receipts
            updateBankBalancesFromReceipts(receipts);
        } catch (error) {
            console.error("Error loading receipts:", error);
        }
    }

    function updateBankBalancesFromReceipts(receipts) {
        receipts.forEach(receipt => {
            const bankName = receipt.bankName || receipt.bank;
            const amount = parseFloat(receipt.amount) || 0;
            
            if (bankName && amount) {
                // Find local bank by name
                const localBank = banks.find(b => 
                    b.name.toLowerCase().includes(bankName.toLowerCase()) || 
                    bankName.toLowerCase().includes(b.name.toLowerCase())
                );
                
                if (localBank && receipt.paymentDate) {
                    // This is a payment, so it's income for the bank
                    localBank.balance += amount;
                    
                    // Add to major transactions
                    majorTransactions.push({
                        description: `Payment from receipt: ${receipt.receiptNumber || 'Unknown'}`,
                        amount: amount,
                        category: 'Sales',
                        date: new Date(receipt.paymentDate).toLocaleDateString('en-KE') || new Date().toLocaleDateString('en-KE'),
                        bankId: localBank.id,
                        isFromReceipt: true
                    });
                    
                    console.log(`Updated ${localBank.name} balance by +${amount} from receipt`);
                }
            }
        });
        
        updateFinancialDashboard();
        updateBankCards();
    }

    function selectFirebaseBank(bankId, bankData) {
        selectedFirebaseBank = {
            id: bankId,
            name: bankData.bankName || 'Unnamed Bank',
            accountNumber: bankData.accountNumber || '',
            branch: bankData.branch || '',
            data: bankData
        };
        
        // Highlight selection
        document.querySelectorAll('#firebase-banks-list > div').forEach(div => {
            div.classList.remove('bg-primary', 'text-white', 'border-primary');
            div.classList.add('bg-white', 'border-gray-200');
        });
        
        event.currentTarget.classList.remove('bg-white', 'border-gray-200');
        event.currentTarget.classList.add('bg-primary', 'text-white', 'border-primary');
        
        // Update selected bank name display
        document.getElementById('selected-bank-name').textContent = selectedFirebaseBank.name;
        document.getElementById('confirm-bank-name').textContent = selectedFirebaseBank.name;
    }

    // --- Add Bank Modal Functions ---

    function openAddBankModal() {
        if (!user) {
            showToast('Please connect to Firebase first', 'warning');
            toggleFirebaseLogin();
            return;
        }
        
        document.getElementById('add-bank-modal').classList.remove('hidden');
        loadFirebaseBanks();
        resetAddBankModal();
    }

    function closeAddBankModal() {
        document.getElementById('add-bank-modal').classList.add('hidden');
    }

    function resetAddBankModal() {
        addBankStep = 1;
        selectedFirebaseBank = null;
        
        // Reset steps
        document.getElementById('step-1-indicator').className = 'step-indicator active';
        document.getElementById('step-2-indicator').className = 'step-indicator';
        document.getElementById('step-3-indicator').className = 'step-indicator';
        
        // Show step 1
        document.querySelectorAll('.bank-step').forEach(step => step.classList.add('hidden'));
        document.getElementById('step-1').classList.remove('hidden');
        
        // Reset inputs
        document.getElementById('bank-initial-balance').value = '';
        document.getElementById('confirm-terms').checked = false;
    }

    function nextBankStep() {
        if (addBankStep === 1) {
            if (!selectedFirebaseBank) {
                showToast('Please select a bank first', 'error');
                return;
            }
            addBankStep = 2;
        } else if (addBankStep === 2) {
            const balance = parseFloat(document.getElementById('bank-initial-balance').value);
            if (!balance || balance < 0) {
                showToast('Please enter a valid balance', 'error');
                return;
            }
            document.getElementById('confirm-bank-balance').textContent = `KSH ${balance.toLocaleString('en-KE')}`;
            addBankStep = 3;
        }
        
        updateBankModalSteps();
    }

    function prevBankStep() {
        if (addBankStep === 2) {
            addBankStep = 1;
        } else if (addBankStep === 3) {
            addBankStep = 2;
        }
        updateBankModalSteps();
    }

    function updateBankModalSteps() {
        // Update indicators
        document.getElementById('step-1-indicator').className = `step-indicator ${addBankStep >= 1 ? 'active' : ''}`;
        document.getElementById('step-2-indicator').className = `step-indicator ${addBankStep >= 2 ? 'active' : ''}`;
        document.getElementById('step-3-indicator').className = `step-indicator ${addBankStep >= 3 ? 'active' : ''}`;
        
        if (addBankStep === 1) {
            document.getElementById('step-1-indicator').classList.add('active');
        } else if (addBankStep === 2) {
            document.getElementById('step-2-indicator').classList.add('active');
        } else if (addBankStep === 3) {
            document.getElementById('step-3-indicator').classList.add('active');
        }
        
        // Show current step
        document.querySelectorAll('.bank-step').forEach(step => step.classList.add('hidden'));
        document.getElementById(`step-${addBankStep}`).classList.remove('hidden');
    }

    function submitNewBank() {
        const termsAccepted = document.getElementById('confirm-terms').checked;
        if (!termsAccepted) {
            showToast('Please confirm the terms', 'error');
            return;
        }
        
        const balance = parseFloat(document.getElementById('bank-initial-balance').value);
        
        const newBank = {
            id: 'b' + Date.now(),
            name: selectedFirebaseBank.name,
            accountNumber: selectedFirebaseBank.accountNumber,
            branch: selectedFirebaseBank.branch,
            balance: balance,
            firebaseId: selectedFirebaseBank.id,
            firebaseData: selectedFirebaseBank.data,
            lastUpdated: new Date().toISOString()
        };
        
        banks.push(newBank);
        updateBankSelectors();
        updateFinancialDashboard();
        updateBankCards();
        
        showToast(`Bank ${newBank.name} added successfully!`, 'success');
        closeAddBankModal();
        
        // Update quick stats
        updateQuickStats();
    }

    // --- Inter-Bank Transfer Functions ---

    function updateTransferBankSelectors() {
        const fromSelect = document.getElementById('transfer-from-bank');
        const toSelect = document.getElementById('transfer-to-bank');
        
        fromSelect.innerHTML = '<option value="" disabled selected>Select Source Bank</option>';
        toSelect.innerHTML = '<option value="" disabled selected>Select Destination Bank</option>';
        
        banks.forEach(bank => {
            const fromOption = document.createElement('option');
            fromOption.value = bank.id;
            fromOption.textContent = `${bank.name} (${formatKSH(bank.balance)})`;
            fromSelect.appendChild(fromOption.cloneNode(true));
            
            const toOption = fromOption.cloneNode(true);
            toSelect.appendChild(toOption);
        });
        
        // Add event listeners for balance display
        fromSelect.addEventListener('change', function() {
            const bank = getBankById(this.value);
            if (bank) {
                document.getElementById('from-bank-balance').innerHTML = 
                    `<span class="font-semibold">Current Balance:</span> ${formatKSH(bank.balance)}`;
            }
        });
        
        toSelect.addEventListener('change', function() {
            const bank = getBankById(this.value);
            if (bank) {
                document.getElementById('to-bank-balance').innerHTML = 
                    `<span class="font-semibold">Current Balance:</span> ${formatKSH(bank.balance)}`;
            }
        });
    }

    function calculateTransferFee(amount) {
        // Simple fee calculation: 0.1% or min 50, max 5000
        const fee = Math.max(50, Math.min(5000, amount * 0.001));
        return fee;
    }

    document.getElementById('transfer-amount').addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        const fee = calculateTransferFee(amount);
        document.getElementById('transfer-fee').textContent = `Transfer Fee: ${formatKSH(fee)}`;
    });

    document.getElementById('bank-transfer-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fromBankId = document.getElementById('transfer-from-bank').value;
        const toBankId = document.getElementById('transfer-to-bank').value;
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        const reason = document.getElementById('transfer-reason').value;
        
        if (!fromBankId || !toBankId) {
            showToast('Please select both source and destination banks', 'error');
            return;
        }
        
        if (fromBankId === toBankId) {
            showToast('Cannot transfer to the same bank account', 'error');
            return;
        }
        
        if (!amount || amount <= 0) {
            showToast('Please enter a valid transfer amount', 'error');
            return;
        }
        
        const fromBank = getBankById(fromBankId);
        const toBank = getBankById(toBankId);
        const fee = calculateTransferFee(amount);
        const totalDebit = amount + fee;
        
        if (fromBank.balance < totalDebit) {
            showToast(`Insufficient funds. Available: ${formatKSH(fromBank.balance)}, Required: ${formatKSH(totalDebit)}`, 'error');
            return;
        }
        
        // Show preview
        document.getElementById('preview-from').textContent = fromBank.name;
        document.getElementById('preview-to').textContent = toBank.name;
        document.getElementById('preview-amount').textContent = formatKSH(amount);
        document.getElementById('preview-fee').textContent = formatKSH(fee);
        document.getElementById('preview-reason').textContent = reason || 'No reason provided';
        document.getElementById('transfer-preview').classList.remove('hidden');
        
        // Show confirmation modal
        document.getElementById('confirm-transfer-from').textContent = fromBank.name;
        document.getElementById('confirm-transfer-to').textContent = toBank.name;
        document.getElementById('confirm-transfer-amount').textContent = formatKSH(amount);
        document.getElementById('confirm-transfer-fee').textContent = formatKSH(fee);
        document.getElementById('confirm-transfer-total').textContent = formatKSH(totalDebit);
        document.getElementById('confirm-transfer-reason').textContent = reason || 'No reason provided';
        
        document.getElementById('transfer-confirm-modal').classList.remove('hidden');
    });

    function closeTransferConfirm() {
        document.getElementById('transfer-confirm-modal').classList.add('hidden');
        document.getElementById('transfer-pin').value = '';
    }

    function executeBankTransfer() {
        const pin = document.getElementById('transfer-pin').value;
        
        if (pin !== '2679') { // Using the same access code as security pin
            showToast('Invalid security PIN', 'error');
            return;
        }
        
        const fromBankId = document.getElementById('transfer-from-bank').value;
        const toBankId = document.getElementById('transfer-to-bank').value;
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        const reason = document.getElementById('transfer-reason').value;
        
        const fromBank = getBankById(fromBankId);
        const toBank = getBankById(toBankId);
        const fee = calculateTransferFee(amount);
        const totalDebit = amount + fee;
        
        // Execute transfer
        fromBank.balance -= totalDebit;
        toBank.balance += amount;
        
        // Record transfer
        const transferId = 't' + Date.now();
        const transferRecord = {
            id: transferId,
            date: new Date().toISOString(),
            fromBankId: fromBankId,
            fromBankName: fromBank.name,
            toBankId: toBankId,
            toBankName: toBank.name,
            amount: amount,
            fee: fee,
            totalDebit: totalDebit,
            reason: reason,
            status: 'completed'
        };
        
        bankTransfers.push(transferRecord);
        
        // Add to major transactions
        majorTransactions.push({
            description: `Bank Transfer: ${reason || 'Inter-bank transfer'}`,
            amount: amount,
            category: 'Assets',
            date: new Date().toLocaleDateString('en-KE'),
            bankId: toBankId,
            isTransfer: true,
            transferId: transferId
        });
        
        // Add fee as expense
        majorTransactions.push({
            description: `Bank Transfer Fee`,
            amount: fee,
            category: 'Overheads',
            date: new Date().toLocaleDateString('en-KE'),
            bankId: fromBankId,
            isTransferFee: true,
            transferId: transferId
        });
        
        // Update UI
        updateFinancialDashboard();
        updateBankCards();
        updateTransferHistory();
        updateBankSelectors();
        updateTransferBankSelectors();
        
        // Clear form
        document.getElementById('bank-transfer-form').reset();
        document.getElementById('transfer-preview').classList.add('hidden');
        document.getElementById('transfer-pin').value = '';
        document.getElementById('transfer-confirm-modal').classList.add('hidden');
        
        // Animate bank cards
        const fromCard = document.querySelector(`[data-bank-id="${fromBankId}"]`);
        const toCard = document.querySelector(`[data-bank-id="${toBankId}"]`);
        
        if (fromCard) fromCard.classList.add('transfer-animation');
        if (toCard) toCard.classList.add('transfer-animation');
        
        setTimeout(() => {
            if (fromCard) fromCard.classList.remove('transfer-animation');
            if (toCard) toCard.classList.remove('transfer-animation');
        }, 500);
        
        showToast(`Transfer of ${formatKSH(amount)} completed successfully!`, 'success');
        
        // Update quick stats
        updateQuickStats();
    }

    function updateTransferHistory() {
        const tbody = document.getElementById('transfer-history');
        tbody.innerHTML = '';
        
        // Show last 5 transfers
        const recentTransfers = [...bankTransfers]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);
        
        if (recentTransfers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-exchange-alt text-3xl mb-3"></i>
                        <p>No transfers yet</p>
                        <p class="text-sm mt-2">Make your first inter-bank transfer above</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        recentTransfers.forEach(transfer => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const date = new Date(transfer.date);
            const formattedDate = date.toLocaleDateString('en-KE');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formattedDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${transfer.fromBankName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${transfer.toBankName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatKSH(transfer.amount)}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                        ${transfer.status}
                    </span>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // --- Bank Cards Display ---

    function updateBankCards() {
        const container = document.getElementById('bank-details-cards');
        const loading = document.getElementById('bank-cards-loading');
        const noBanks = document.getElementById('no-banks-message');
        
        if (banks.length === 0) {
            container.innerHTML = '';
            loading.classList.add('hidden');
            noBanks.classList.remove('hidden');
            return;
        }
        
        loading.classList.add('hidden');
        noBanks.classList.add('hidden');
        container.innerHTML = '';
        
        banks.forEach(bank => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-card overflow-hidden hover:shadow-card-hover transition-all duration-300';
            card.setAttribute('data-bank-id', bank.id);
            
            const balanceColor = bank.balance < 0 ? 'text-red-500' : 'text-primary';
            const balanceIcon = bank.balance < 0 ? 'fa-arrow-down' : 'fa-arrow-up';
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-xl font-bold text-gray-800">${bank.name}</h4>
                            <p class="text-sm text-gray-600 mt-1">${bank.accountNumber || 'No account number'}</p>
                            ${bank.branch ? `<p class="text-xs text-gray-500 mt-1">${bank.branch}</p>` : ''}
                        </div>
                        <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-lg">
                            <i class="fas fa-university text-xl"></i>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-600">Current Balance</span>
                            <span class="text-xs text-gray-500">Updated: ${new Date(bank.lastUpdated || Date.now()).toLocaleTimeString('en-KE', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="text-2xl font-bold ${balanceColor} flex items-center">
                            <i class="fas ${balanceIcon} mr-2"></i>
                            ${formatKSH(bank.balance)}
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="updateBankBalance('${bank.id}')"
                                class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 font-medium py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center">
                            <i class="fas fa-edit mr-2"></i>Update
                        </button>
                        <button onclick="showBankTransactions('${bank.id}')"
                                class="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-600 font-medium py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center">
                            <i class="fas fa-history mr-2"></i>History
                        </button>
                    </div>
                </div>
                
                ${bank.firebaseId ? `
                <div class="bg-gray-50 px-6 py-3 border-t border-gray-100">
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-fire text-orange-500 mr-2"></i>
                        <span>Synced with Firebase</span>
                        <button onclick="syncBankWithFirebase('${bank.id}')"
                                class="ml-auto text-primary hover:text-primary-dark text-xs font-medium">
                            <i class="fas fa-sync-alt mr-1"></i>Sync Now
                        </button>
                    </div>
                </div>
                ` : ''}
            `;
            
            container.appendChild(card);
        });
        
        // Update quick stats
        document.getElementById('stats-active-banks').textContent = banks.length;
    }

    function updateBankBalance(bankId) {
        const bank = getBankById(bankId);
        if (!bank) return;
        
        const newBalance = prompt(`Update balance for ${bank.name}\nCurrent: ${formatKSH(bank.balance)}\n\nEnter new balance (KSH):`, bank.balance);
        
        if (newBalance !== null) {
            const balance = parseFloat(newBalance);
            if (!isNaN(balance)) {
                const oldBalance = bank.balance;
                bank.balance = balance;
                bank.lastUpdated = new Date().toISOString();
                
                // Record the adjustment
                majorTransactions.push({
                    description: `Manual balance adjustment for ${bank.name}`,
                    amount: Math.abs(balance - oldBalance),
                    category: balance > oldBalance ? 'Sales' : 'Overheads',
                    date: new Date().toLocaleDateString('en-KE'),
                    bankId: bankId,
                    isAdjustment: true,
                    oldBalance: oldBalance,
                    newBalance: balance
                });
                
                updateFinancialDashboard();
                updateBankCards();
                updateBankSelectors();
                updateTransferBankSelectors();
                
                showToast(`Updated ${bank.name} balance to ${formatKSH(balance)}`, 'success');
            } else {
                showToast('Invalid balance amount', 'error');
            }
        }
    }

    function showBankTransactions(bankId) {
        const bank = getBankById(bankId);
        if (!bank) return;
        
        // Filter transactions for this bank
        const bankTransactions = majorTransactions.filter(t => t.bankId === bankId);
        
        if (bankTransactions.length === 0) {
            alert(`No transactions recorded for ${bank.name}`);
            return;
        }
        
        let message = `Transaction History for ${bank.name}\n\n`;
        message += `Current Balance: ${formatKSH(bank.balance)}\n\n`;
        
        bankTransactions.slice(-10).reverse().forEach(t => {
            const type = t.category === 'Sales' ? 'INCOME' : 'EXPENSE';
            const sign = t.category === 'Sales' ? '+' : '-';
            message += `${t.date}: ${t.description}\n`;
            message += `  ${type}: ${sign}${formatKSH(t.amount)}\n\n`;
        });
        
        alert(message);
    }

    async function syncBankWithFirebase(bankId) {
        const bank = getBankById(bankId);
        if (!bank || !bank.firebaseId) return;
        
        showLoading(`Syncing ${bank.name} with Firebase...`);
        
        try {
            // In a real implementation, you would update Firebase with the current balance
            // or fetch the latest from Firebase
            
            // For now, we'll simulate a sync
            setTimeout(() => {
                showLoading(false);
                showToast(`${bank.name} synced successfully!`, 'success');
                
                // Update the last updated time
                bank.lastUpdated = new Date().toISOString();
                updateBankCards();
            }, 1000);
            
        } catch (error) {
            showLoading(false);
            showToast(`Sync failed: ${error.message}`, 'error');
        }
    }

    // --- Utility Functions (from original code, enhanced) ---

    function getBankById(id) {
        return banks.find(b => b.id === id);
    }

    function formatKSH(amount) {
        return `KSH ${amount.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loading-overlay');
        const text = document.getElementById('loading-text');
        
        if (message) {
            overlay.classList.remove('hidden');
            text.textContent = message;
        } else {
            overlay.classList.add('hidden');
        }
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            warning: 'bg-yellow-500',
            info: 'bg-blue-500'
        };
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast ${colors[type]} text-white rounded-lg shadow-lg p-4`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icons[type]} text-xl mr-3"></i>
                <div class="flex-1">${message}</div>
                <button onclick="document.getElementById('${toastId}').remove()" class="ml-4 text-white opacity-70 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        container.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 5000);
    }

    function updateQuickStats() {
        // Today's transactions
        const today = new Date().toLocaleDateString('en-KE');
        const todayTrans = pettyCashTransactions.filter(t => t.date === today);
        document.getElementById('stats-today-transactions').textContent = todayTrans.length;
        
        // Progress bar (capped at 20 transactions)
        const todayProgress = Math.min(100, (todayTrans.length / 20) * 100);
        document.getElementById('stats-today-progress').style.width = `${todayProgress}%`;
        
        // Active banks
        document.getElementById('stats-active-banks').textContent = banks.length;
        
        // Monthly budget used (simplified)
        const monthlyBudget = 1000000; // Example budget
        const budgetUsed = Math.min(100, (currentMonthSpend.totalExpense / monthlyBudget) * 100);
        document.getElementById('stats-budget-used').textContent = `${budgetUsed.toFixed(1)}%`;
        document.getElementById('stats-budget-progress').style.width = `${budgetUsed}%`;
    }

    function refreshAllData() {
        showLoading('Refreshing all data...');
        
        // Refresh Firebase data if connected
        if (user) {
            loadFirebaseBanks();
            loadReceiptPayments();
        }
        
        // Update all local data
        updateFinancialDashboard();
        updateBankCards();
        updatePettyCashBalanceDisplay();
        updatePettyCashChart();
        updateMajorCategoryChart();
        updateTransferHistory();
        updateQuickStats();
        
        setTimeout(() => {
            showLoading(false);
            showToast('All data refreshed successfully!', 'success');
        }, 1000);
    }

    function refreshBankData() {
        if (user) {
            loadFirebaseBanks();
            loadReceiptPayments();
            showToast('Bank data refreshed from Firebase', 'success');
        } else {
            showToast('Connect to Firebase to refresh bank data', 'warning');
        }
    }

    function toggleDarkMode() {
        document.body.classList.toggle('bg-gray-900');
        document.body.classList.toggle('text-gray-100');
        
        const isDark = document.body.classList.contains('bg-gray-900');
        const icon = document.querySelector('#firebase-login-btn + button i');
        
        if (isDark) {
            icon.className = 'fas fa-sun';
            document.body.style.backgroundColor = '#1a202c';
        } else {
            icon.className = 'fas fa-moon';
            document.body.style.backgroundColor = '';
        }
        
        // Store preference
        localStorage.setItem('darkMode', isDark);
    }

    // --- Original Petty Cash Functions ---

    document.getElementById('petty-cash-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const description = document.getElementById('description').value;
        const recipient = document.getElementById('recipient').value;
        const cost = parseFloat(document.getElementById('cost').value);
        const type = document.getElementById('type').value;

        if (cost <= 0) {
            alert("Cost must be a positive value.");
            return;
        }

        const now = new Date();
        const newTransaction = {
            date: now.toLocaleDateString('en-KE'),
            time: now.toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' }),
            description: description,
            recipient: recipient,
            cost: cost,
            type: type
        };

        pettyCashTransactions.push(newTransaction);
        renderPettyCash();
        updatePettyCashBalanceDisplay();
        updatePettyCashChart();
        updatePettyExpenditureChart();
        document.getElementById('petty-cash-form').reset();
        checkAnomalies(newTransaction);
        updateQuickStats();
    });

    function renderPettyCash() {
        const list = document.getElementById('transaction-list');
        list.innerHTML = '';
        const sortedTransactions = [...pettyCashTransactions].sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
        const transactionsToShow = sortedTransactions.slice(0, 5);

        transactionsToShow.forEach(tx => {
            const row = list.insertRow();
            row.style.color = tx.type === 'expense' ? '#d9534f' : 'var(--primary-color)';
            
            row.insertCell().textContent = tx.date;
            row.insertCell().textContent = tx.description;
            row.insertCell().textContent = tx.recipient;
            row.insertCell().textContent = tx.type.charAt(0).toUpperCase() + tx.type.slice(1);
            row.insertCell().textContent = formatKSH(tx.cost);
        });
        updatePettyCashBalanceDisplay();
    }

    function calculatePettyCashBalance() {
        let totalExpense = 0;
        let totalIncome = 0;
        let currentBalance = 0;
        
        pettyCashTransactions.forEach(t => {
            currentBalance += (t.type === 'income' ? t.cost : -t.cost);
        });
        
        const today = new Date().toLocaleDateString('en-KE');
        const todayTrans = pettyCashTransactions.filter(t => t.date === today);

        todayTrans.forEach(t => {
            if (t.type === 'expense') {
                totalExpense += t.cost;
            } else {
                totalIncome += t.cost;
            }
        });
        
        return { currentBalance, totalExpense, totalIncome };
    }

    function updatePettyCashBalanceDisplay() {
        const { currentBalance, totalExpense, totalIncome } = calculatePettyCashBalance();
        
        document.getElementById('current-balance').textContent = formatKSH(currentBalance);
        document.getElementById('day-expense').textContent = formatKSH(totalExpense);
        document.getElementById('day-income').textContent = formatKSH(totalIncome);
        
        const currentBalanceElement = document.getElementById('current-balance');
        currentBalanceElement.style.color = currentBalance < 0 ? '#dc3545' : 'var(--primary-color)';
    }

    function togglePettyCashBalance() {
        const currentBalance = document.getElementById('current-balance');
        const dayExpense = document.getElementById('day-expense');
        const dayIncome = document.getElementById('day-income');
        const button = document.querySelector('.balance-bar button:first-child');
        
        const isHidden = dayIncome.textContent.includes('*****');
        
        if (isHidden) {
            updatePettyCashBalanceDisplay();
            button.innerHTML = 'üôà Hide Balances';
        } else {
            currentBalance.textContent = '********';
            dayExpense.textContent = 'KSH *****';
            dayIncome.textContent = 'KSH *****';
            button.innerHTML = 'üëÅÔ∏è Reveal Balances';
        }
    }

    async function endDayAndGenerateReport() {
        const today = new Date().toLocaleDateString('en-KE');
        const todayTrans = pettyCashTransactions.filter(t => t.date === today);
        const { currentBalance, totalExpense, totalIncome } = calculatePettyCashBalance();
        
        if (todayTrans.length === 0) {
            alert("No transactions logged for today to generate a report.");
            return;
        }

        const pdf = new jsPDF('p', 'mm', 'a4');
        const title = `Petty Cash Daily Report - ${today}`;
        const startingBalance = currentBalance + totalExpense - totalIncome;

        pdf.setFontSize(22);
        pdf.setTextColor(38, 121, 33);
        pdf.text(title, 14, 20);
        
        pdf.setFontSize(12);
        pdf.setTextColor(51, 51, 51);
        pdf.text(`Starting Balance (EOD T-1): ${formatKSH(startingBalance)}`, 14, 38);
        pdf.text(`(+) Total Income Today: ${formatKSH(totalIncome)}`, 14, 44);
        pdf.text(`(-) Total Expense Today: ${formatKSH(totalExpense)}`, 14, 50);
        pdf.text(`(=) End of Day Balance: ${formatKSH(currentBalance)}`, 14, 56);
        
        pdf.setFontSize(16);
        pdf.setTextColor(38, 121, 33);
        pdf.text('Detailed Daily Transactions', 14, 68);
        
        let y = 75;
        pdf.setFontSize(9);
        
        pdf.setFillColor(38, 121, 33);
        pdf.setTextColor(255, 255, 255);
        pdf.rect(10, y, 190, 6, 'F');
        pdf.text('Time', 12, y + 4);
        pdf.text('Description', 40, y + 4);
        pdf.text('Recipient', 100, y + 4);
        pdf.text('Type', 135, y + 4);
        pdf.text('Amount (KSH)', 165, y + 4);
        y += 6;

        pdf.setTextColor(51, 51, 51);
        todayTrans.forEach(tx => {
            if (y > 280) { pdf.addPage(); y = 20; pdf.setTextColor(51, 51, 51); }
            const time = tx.time || new Date().toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit' });
            const color = tx.type === 'income' ? '#267921' : '#d9534f';
            
            pdf.setTextColor(51, 51, 51);
            pdf.text(time, 12, y + 4);
            pdf.text(tx.description.substring(0, 30) + (tx.description.length > 30 ? '...' : ''), 40, y + 4);
            pdf.text(tx.recipient, 100, y + 4);
            pdf.text(tx.type.toUpperCase(), 135, y + 4);
            pdf.setTextColor(color);
            pdf.text(tx.cost.toLocaleString('en-KE'), 165, y + 4);
            y += 6;
        });

        pdf.save(`CarKenya_Petty_Cash_Daily_Report_${today.replace(/\//g, '-')}.pdf`);
        alert(`Day closed. Report generated for ${today}.`);
    }

    // --- Chart Functions ---

    function updatePettyCashChart() {
        let totalExpense = pettyCashTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.cost, 0);
        let totalIncome = pettyCashTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.cost, 0);

        const data = {
            labels: ['Total Expenses', 'Total Income'],
            datasets: [{
                label: 'Petty Cash Flow (KSH)',
                data: [totalExpense, totalIncome],
                backgroundColor: ['#d9534f', 'var(--primary-color)'],
                borderWidth: 1
            }]
        };

        if (pettyChartInstance) {
            pettyChartInstance.data = data;
            pettyChartInstance.update();
        } else {
            const ctx = document.getElementById('pettyCashChart').getContext('2d');
            pettyChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true } } 
                } 
            });
        }
    }
    
    function updatePettyExpenditureChart() {
        const data = { 
            labels: ['Jan', 'Feb', 'Mar'], 
            datasets: [{ 
                label: 'Daily/Monthly Trend', 
                data: [10000, 15000, 12000], 
                borderColor: '#dc3545', 
                fill: false, 
                tension: 0.3 
            }] 
        };
        
        if (pettyLineChartInstance) {
            pettyLineChartInstance.data = data;
            pettyLineChartInstance.update();
        } else {
            const ctx = document.getElementById('pettyExpenditureLineChart').getContext('2d');
            pettyLineChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: 'top' } }, 
                    scales: { y: { beginAtZero: true } } 
                } 
            });
        }
    }

    // --- Major Financial Reports Logic ---

    function checkAccessCode() {
        const codeInput = document.getElementById('access-code').value;
        if (codeInput === ACCESS_CODE) {
            document.getElementById('access-gate').style.display = 'none';
            document.getElementById('report-input-area').style.display = 'block';
            updateMajorCategoryChart();
            updateFinancialDashboard();
            alert('Access Granted! Welcome to the Major Financial Report Generator.');
        } else {
            alert('Access Denied. Invalid Code.');
            document.getElementById('access-code').value = '';
        }
    }

    document.getElementById('major-transaction-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const description = document.getElementById('major-description').value;
        const cost = parseFloat(document.getElementById('major-cost').value);
        const category = document.getElementById('major-category').value;
        const bankId = document.getElementById('transaction-bank-id').value;

        if (cost <= 0) {
            alert("Amount must be a positive value.");
            return;
        }
        if (!bankId) {
            alert("Please select a bank account for this transaction.");
            return;
        }

        const selectedBank = getBankById(bankId);
        const isIncome = category === 'Sales';
        
        if (isIncome) {
            selectedBank.balance += cost;
        } else {
            selectedBank.balance -= cost;
        }
        
        majorTransactions.push({
            description,
            amount: cost,
            category,
            date: new Date().toLocaleDateString('en-KE'),
            bankId: bankId
        });

        updateBankSelectors();
        updateMajorSummary();
        updateMajorCategoryChart();
        updateFinancialDashboard();
        document.getElementById('major-transaction-form').reset();
        alert(`Major Transaction Logged: ${description} - ${formatKSH(cost)} (Bank: ${selectedBank.name})`);
    });
    
    function updateMajorSummary() {
        let summaryHTML = '<h4>Major Transactions Summary</h4>';
        const total = majorTransactions.reduce((sum, t) => sum + t.amount, 0);
        summaryHTML += `<p><strong>Total Major Value Logged:</strong> ${formatKSH(total)}</p>`;
        
        const detailsHTML = `
            <h5>Transaction Details:</h5>
            <table class="transaction-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Bank</th>
                        <th>Amount (KSH)</th>
                    </tr>
                </thead>
                <tbody>
                    ${majorTransactions.map(t => `
                        <tr>
                            <td>${t.date}</td>
                            <td>${t.description}</td>
                            <td>${t.category}</td>
                            <td>${getBankById(t.bankId)?.name || 'N/A'}</td>
                            <td>${formatKSH(t.amount)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        document.getElementById('major-summary').innerHTML = summaryHTML + detailsHTML;
    }

    function updateMajorCategoryChart() {
        const categories = majorTransactions.reduce((acc, t) => {
            acc[t.category] = (acc[t.category] || 0) + t.amount;
            return acc;
        }, {});

        const labels = Object.keys(categories);
        const dataValues = Object.values(categories);
        
        const data = {
            labels: labels,
            datasets: [{
                label: 'Value by Category (KSH)',
                data: dataValues,
                backgroundColor: ['#267921', '#ffc107', '#0dcaf0', '#dc3545', '#6c757d'],
                hoverOffset: 4
            }]
        };

        if (majorChartInstance) {
            majorChartInstance.data = data;
            majorChartInstance.update();
        } else {
            const ctx = document.getElementById('majorCategoryChart').getContext('2d');
            majorChartInstance = new Chart(ctx, { 
                type: 'doughnut', 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        title: { 
                            display: true, 
                            text: 'Major Transactions Breakdown' 
                        } 
                    } 
                } 
            });
        }
    }
    
    function generateReport() {
        if (majorTransactions.length === 0) {
            document.getElementById('report-output-area').innerHTML = '<p style="color: #d9534f;">‚ö†Ô∏è No major transactions logged. Cannot generate report.</p>';
            return;
        }
        updateMajorSummary();
        updateMajorCategoryChart();
        alert('Financial Report Generated! Ready to print/export.');
    }

    // --- Financial Dashboard Functions ---

    function updateFinancialDashboard() {
        // 1. Total Bank Funds
        const totalBankFunds = banks.reduce((sum, bank) => sum + bank.balance, 0);
        document.getElementById('total-bank-funds').textContent = formatKSH(totalBankFunds);
        
        // 2. Total Outstanding Loans
        const totalOutstandingLoans = loans.reduce((sum, loan) => sum + loan.balance, 0);
        document.getElementById('total-outstanding-loans').textContent = formatKSH(totalOutstandingLoans);
        
        // 3. Monthly Spend
        const now = new Date();
        if (now.getMonth() !== currentMonthSpend.month || now.getFullYear() !== currentMonthSpend.year) {
            currentMonthSpend.month = now.getMonth();
            currentMonthSpend.year = now.getFullYear();
            currentMonthSpend.totalExpense = 0;
        } else {
            currentMonthSpend.totalExpense = majorTransactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    const isExpense = ['Payroll', 'Overheads', 'Assets'].includes(t.category);
                    const isThisMonth = tDate.getMonth() === currentMonthSpend.month && tDate.getFullYear() === currentMonthSpend.year;
                    return isExpense && isThisMonth;
                })
                .reduce((sum, t) => sum + t.amount, 0);
        }
        
        document.getElementById('monthly-spend').textContent = formatKSH(currentMonthSpend.totalExpense);
    }

    // --- Loan Management ---

    document.getElementById('loan-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const institution = document.getElementById('loan-institution').value;
        const balance = parseFloat(document.getElementById('loan-balance').value);
        
        const newLoan = {
            id: 'l' + Date.now(),
            institution: institution,
            balance: balance
        };
        loans.push(newLoan);
        updateFinancialDashboard();
        document.getElementById('loan-form').reset();
        alert(`Loan from ${institution} added with outstanding balance ${formatKSH(balance)}.`);
    });

    // --- Auditing Logic ---

    function simulateAudit() {
        let auditIssues = [];
        
        const pettyAnomalies = pettyCashTransactions.filter(t => t.type === 'expense' && t.cost > 5000);
        if (pettyAnomalies.length > 0) { 
            auditIssues.push(`[Petty Cash] ${pettyAnomalies.length} high-value expenses (>KSH 5,000) found.`); 
        }

        const pettyBalance = pettyCashTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.cost : -t.cost), 0);
        if (pettyBalance < 0) { 
            auditIssues.push(`[Petty Cash] Negative Balance: ${formatKSH(pettyBalance)}.`); 
        }
        
        banks.filter(b => b.balance < 0).forEach(b => { 
            auditIssues.push(`[Bank Integrity] ${b.name} has a negative balance of ${formatKSH(b.balance)}.`); 
        });
        
        const smallMajorExpenses = majorTransactions.filter(t => ['Payroll', 'Overheads'].includes(t.category) && t.amount < 1000);
        if (smallMajorExpenses.length > 0) { 
            auditIssues.push(`[Major Integrity] ${smallMajorExpenses.length} small expenses logged as Major.`); 
        }

        const statusElement = document.getElementById('audit-status');
        if (auditIssues.length > 0) {
            statusElement.style.color = 'red';
            statusElement.innerHTML = `‚ö†Ô∏è **AUDIT WARNING** - ${auditIssues.length} issues found:<br><ul><li>${auditIssues.join('</li><li>')}</li></ul>`;
            alert('Audit Complete: WARNING! See Audit Status for details.');
        } else {
            statusElement.style.color = 'green';
            statusElement.textContent = 'System Health: All Clear. Financial data integrity passed basic audit.';
            alert('Audit Complete: System passed all checks.');
        }
    }

    function checkAnomalies(transaction) {
        if (transaction.type === 'expense' && transaction.cost > 5000) {
            const statusElement = document.getElementById('audit-status');
            statusElement.style.color = 'orange';
            statusElement.innerHTML = `üü° **PETTY CASH ALERT:** Expense of ${formatKSH(transaction.cost)} logged. Check receipt for ${transaction.description}.`;
        }
    }

    // --- PDF Generation ---

    async function exportReportToPdf() {
        if (majorTransactions.length === 0) {
            alert("Cannot generate PDF. No major transactions logged.");
            return;
        }
        
        const pdf = new jsPDF('p', 'mm', 'a4');
        const title = 'CarKenya.Co.Ke Financial Report';

        pdf.setFontSize(22);
        pdf.setTextColor(38, 121, 33);
        pdf.text(title, 14, 20);
        
        pdf.setFontSize(10);
        pdf.setTextColor(51, 51, 51);
        pdf.text(`Date Generated: ${new Date().toLocaleDateString('en-KE')}`, 14, 25);
        pdf.text(`Total Bank Funds: ${formatKSH(banks.reduce((sum, b) => sum + b.balance, 0))}`, 14, 30);
        
        pdf.setFontSize(16);
        pdf.text('Category Breakdown Graph', 14, 40);

        const canvas = await html2canvas(document.getElementById('majorCategoryChart'), { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 10, 45, 180, 100); 

        pdf.setFontSize(16);
        pdf.text('Transaction Details', 14, 155);

        let y = 165;
        pdf.setFontSize(10);
        
        pdf.setFillColor(38, 121, 33);
        pdf.setTextColor(255, 255, 255);
        pdf.rect(10, y, 190, 7, 'F');
        pdf.text('Date', 12, y + 5);
        pdf.text('Description', 40, y + 5);
        pdf.text('Category', 95, y + 5);
        pdf.text('Bank', 130, y + 5);
        pdf.text('Amount (KSH)', 165, y + 5);
        y += 7;

        pdf.setTextColor(51, 51, 51);
        majorTransactions.forEach(tx => {
            if (y > 280) { pdf.addPage(); y = 20; pdf.setTextColor(51, 51, 51); }
            pdf.text(tx.date, 12, y + 5);
            pdf.text(tx.description.substring(0, 30) + (tx.description.length > 30 ? '...' : ''), 40, y + 5);
            pdf.text(tx.category, 95, y + 5);
            pdf.text(getBankById(tx.bankId)?.name || 'N/A', 130, y + 5);
            pdf.text(tx.amount.toLocaleString('en-KE'), 165, y + 5);
            y += 7;
        });

        pdf.save("CarKenya_Financial_Report.pdf");
        alert('PDF Report exported successfully!');
    }

    // --- Calculator Logic ---

    function openCalculatorModal(defaultTab) {
        const modal = document.getElementById('calculator-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
        if (defaultTab) {
            const tabButton = document.querySelector(`.calc-tab-button[onclick*='${defaultTab}-calc']`);
            if (tabButton) { 
                switchCalcTab({ currentTarget: tabButton }, `${defaultTab}-calc`); 
            }
        }
    }
    
    function switchCalcTab(evt, tabName) {
        document.querySelectorAll(".calc-tab-content").forEach(el => {
            el.style.display = "none";
            el.classList.remove('active');
        });
        document.querySelectorAll(".calc-tab-button").forEach(el => {
            el.className = el.className.replace(" active", "");
        });
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.className += " active";
    }
    
    function appendToBasicCalc(value) {
        const display = document.getElementById('calculator-display');
        if (display.textContent === '0' && value !== '.') { 
            display.textContent = ''; 
        }
        if (basicCalcCurrentExpression === 'Error') { 
            basicCalcCurrentExpression = ''; 
        }
        
        const lastChar = basicCalcCurrentExpression.slice(-1);
        const isOperator = (char) => ['+', '-', '*', '/'].includes(char);

        if (isOperator(lastChar) && isOperator(value)) {
            basicCalcCurrentExpression = basicCalcCurrentExpression.slice(0, -1) + value;
        } else if (value === '.' && basicCalcCurrentExpression.split(/[\+\-\*\/]/).pop().includes('.')) {
            return;
        } else if (value === '.' && basicCalcCurrentExpression.length === 0) {
            basicCalcCurrentExpression = '0.';
        } else {
            basicCalcCurrentExpression += value;
        }

        let displayValue = basicCalcCurrentExpression.replace(/\*/g, '√ó').replace(/\//g, '√∑').replace(/\-/g, '‚àí');
        display.textContent = displayValue.length > 20 ? '... ' + displayValue.slice(-20) : displayValue;
    }

    function clearBasicCalc() {
        document.getElementById('calculator-display').textContent = '0';
        basicCalcCurrentExpression = '';
    }

    function calculateBasicCalc() {
        const display = document.getElementById('calculator-display');
        try {
            let result = new Function('return ' + basicCalcCurrentExpression)();
            if (result === Infinity || isNaN(result)) { 
                throw new Error('Invalid calculation'); 
            }
            result = parseFloat(result.toFixed(4)); 
            display.textContent = result.toLocaleString('en-KE');
            basicCalcCurrentExpression = result.toString();
        } catch (error) {
            display.textContent = 'Error';
            basicCalcCurrentExpression = 'Error';
        }
    }

    document.getElementById('emi-calculator-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const principal = parseFloat(document.getElementById('principal').value);
        const rateAnnual = parseFloat(document.getElementById('rate').value);
        const months = parseInt(document.getElementById('months').value);
        const resultElement = document.getElementById('emi-result');
        
        if (principal <= 0 || rateAnnual < 0 || months <= 0) {
            resultElement.textContent = "Please enter positive values.";
            return;
        }

        const rateMonthly = (rateAnnual / 100) / 12;
        const n = months;
        
        let emi;
        if (rateMonthly === 0) {
            emi = principal / n;
        } else {
            const power = Math.pow((1 + rateMonthly), n);
            emi = principal * (rateMonthly * power) / (power - 1);
        }

        const totalInterest = (emi * n) - principal;

        resultElement.style.color = 'var(--primary-color)';
        resultElement.innerHTML = `
            <p>Monthly Payment (EMI): <strong>${formatKSH(emi.toFixed(2))}</strong></p>
            <p>Total Repayment: ${formatKSH((emi * n).toFixed(2))}</p>
            <p>Total Interest: ${formatKSH(totalInterest.toFixed(2))}</p>
        `;
    });

    // --- Bank Selector Functions ---

    function updateBankSelectors() {
        const majorSelect = document.getElementById('transaction-bank-id');
        if (majorSelect) {
            majorSelect.innerHTML = '<option value="" disabled selected>Select Bank</option>';

            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.id;
                option.textContent = `${bank.name} (${formatKSH(bank.balance)})`;
                majorSelect.appendChild(option);
            });
        }
        
        // Also update transfer selectors
        updateTransferBankSelectors();
    }

    // --- Initialize the application ---

    window.onload = () => {
        // Check for dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            toggleDarkMode();
        }
        
        // Initialize original functions
        openTab({ currentTarget: document.querySelector('.tab-button.active') }, 'petty-cash');
        renderPettyCash();
        updatePettyCashBalanceDisplay();
        updatePettyCashChart();
        updatePettyExpenditureChart();
        updateBankSelectors();
        updateTransferBankSelectors();
        updateMajorSummary();
        updateFinancialDashboard();
        updateBankCards();
        updateTransferHistory();
        updateQuickStats();
        
        // Initialize calculator tab
        const calcTabButton = document.querySelector('#calculator-tabs .calc-tab-button.active');
        if (calcTabButton) {
            switchCalcTab({ currentTarget: calcTabButton }, 'basic-calc');
        }
        
        // Update Firebase UI
        updateFirebaseUI();
    };
</script>
    <!-- Include your original JavaScript functions here -->
    <!-- I've shown how to integrate them with the new system -->
    <!-- You'll need to copy all your original functions from the previous code -->
    <!-- and ensure they use the updated bank system and Firebase integration -->

</body>
</html>
