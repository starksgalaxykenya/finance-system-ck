<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarKenya | Reports Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen">

    <div id="gate" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-3xl font-black mb-6">Admin Access</h1>
            <input type="password" id="pin" placeholder="Enter PIN" class="w-full p-4 bg-slate-800 rounded-2xl text-center text-2xl tracking-widest outline-none mb-4 focus:ring-2 focus:ring-green-500">
            <button onclick="unlock()" class="w-full bg-green-600 font-bold py-4 rounded-2xl hover:bg-green-500 transition">Unlock System</button>
            <p class="text-slate-500 mt-4 text-xs font-bold uppercase tracking-widest">Pin is 2679</p>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <nav class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 backdrop-blur-md sticky top-0">
            <h2 class="text-xl font-black italic">CarKenya Dashboard</h2>
            <div class="flex gap-4">
                <button onclick="exportPDF()" class="bg-white text-slate-900 px-4 py-2 rounded-lg text-xs font-black">üñ®Ô∏è Export PDF</button>
                <button onclick="location.reload()" class="bg-rose-500 px-4 py-2 rounded-lg text-xs font-black">Logout</button>
            </div>
        </nav>

        <main class="p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700">
                    <p class="text-slate-500 text-[10px] font-black uppercase mb-2">Total Bank Funds</p>
                    <h3 id="bank-funds" class="text-4xl font-black text-green-400">KSH 0</h3>
                </div>
                <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700">
                    <p class="text-slate-500 text-[10px] font-black uppercase mb-2">Outstanding Loans</p>
                    <h3 id="total-loans" class="text-4xl font-black text-rose-400">KSH 0</h3>
                </div>
                <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700">
                    <p class="text-slate-500 text-[10px] font-black uppercase mb-2">Monthly Spend</p>
                    <h3 id="month-spend" class="text-4xl font-black text-blue-400">KSH 0</h3>
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700">
                <h4 class="font-bold mb-6 flex items-center gap-2">üíæ Log Major Entry</h4>
                <form id="major-form" class="space-y-4">
                    <input type="text" id="m-desc" placeholder="Major Description" class="w-full p-3 bg-slate-900 rounded-xl outline-none focus:ring-1 focus:ring-green-500">
                    <input type="number" id="m-amt" placeholder="Amount (KSH)" class="w-full p-3 bg-slate-900 rounded-xl outline-none focus:ring-1 focus:ring-green-500">
                    <select id="m-cat" class="w-full p-3 bg-slate-900 rounded-xl outline-none">
                        <option value="Sales">Sales (Income)</option>
                        <option value="Payroll">Payroll (Expense)</option>
                        <option value="Assets">Assets (Investment)</option>
                        <option value="Overheads">Overheads (Expense)</option>
                    </select>
                    <select id="m-bank" class="w-full p-3 bg-slate-900 rounded-xl outline-none">
                        <option value="KCB Account">KCB Main</option>
                        <option value="Equity Bank">Equity Business</option>
                    </select>
                    <button type="submit" class="w-full bg-green-600 font-bold py-3 rounded-xl hover:bg-green-500">Post Transaction</button>
                </form>
            </div>

            <div class="lg:col-span-2 bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden">
                <div class="p-6 border-b border-slate-700 bg-slate-800/50">
                    <h4 class="font-bold">Master Financial Feed</h4>
                </div>
                <div id="master-feed" class="divide-y divide-slate-700 h-[500px] overflow-y-auto"></div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuUKCxYx0jYKqWOQaN82K5zFGlQsKQsK0",
            authDomain: "ck-manager-1abdc.firebaseapp.com",
            projectId: "ck-manager-1abdc",
            storageBucket: "ck-manager-1abdc.firebasestorage.app",
            messagingSenderId: "890017473158",
            appId: "1:890017473158:web:528e1eebc4b67bd54ca707"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const txRef = collection(db, "transactions");

        window.unlock = () => {
            if(document.getElementById('pin').value === '2679') {
                document.getElementById('gate').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            } else { alert("Wrong PIN"); }
        };

        document.getElementById('major-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cat = document.getElementById('m-cat').value;
            await addDoc(txRef, {
                desc: document.getElementById('m-desc').value,
                amount: parseFloat(document.getElementById('m-amt').value),
                category: cat,
                type: (cat === 'Sales' ? 'income' : 'expense'),
                bank: document.getElementById('m-bank').value,
                isPetty: false,
                timestamp: serverTimestamp()
            });
            e.target.reset();
        });

        onSnapshot(query(txRef, orderBy("timestamp", "desc")), (snap) => {
            const feed = document.getElementById('master-feed');
            feed.innerHTML = '';
            let totalBank = 0, mSpend = 0;
            const thisMonth = new Date().getMonth();

            snap.docs.forEach(doc => {
                const tx = doc.data();
                if(!tx.isPetty) {
                    if(tx.type === 'income') totalBank += tx.amount; else totalBank -= tx.amount;
                    if(tx.timestamp?.toDate().getMonth() === thisMonth && tx.type === 'expense') mSpend += tx.amount;
                }

                const item = `<div class="p-6 flex justify-between items-center hover:bg-slate-700/50 transition">
                    <div>
                        <span class="text-[10px] font-black text-slate-500 uppercase">${tx.isPetty ? 'Petty' : 'Major'}</span>
                        <h5 class="font-bold">${tx.desc}</h5>
                        <p class="text-xs text-slate-500">${tx.bank || 'Cash Account'}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-black ${tx.type === 'expense' ? 'text-rose-400' : 'text-green-400'}">${tx.type === 'expense' ? '-' : '+'} ${tx.amount.toLocaleString()}</p>
                    </div>
                </div>`;
                feed.insertAdjacentHTML('beforeend', item);
            });
            document.getElementById('bank_funds').textContent = `KSH ${totalBank.toLocaleString()}`;
            document.getElementById('month-spend').textContent = `KSH ${mSpend.toLocaleString()}`;
        });
    </script>
</body>
</html>
